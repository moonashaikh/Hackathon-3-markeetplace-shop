!function(e){function t(t){for(var r,s,o=t[0],u=t[1],c=t[2],d=0,f=[];d<o.length;d++)s=o[d],Object.prototype.hasOwnProperty.call(i,s)&&i[s]&&f.push(i[s][0]),i[s]=0;for(r in u)Object.prototype.hasOwnProperty.call(u,r)&&(e[r]=u[r]);for(l&&l(t);f.length;)f.shift()();return a.push.apply(a,c||[]),n()}function n(){for(var e,t=0;t<a.length;t++){for(var n=a[t],r=!0,o=1;o<n.length;o++){var u=n[o];0!==i[u]&&(r=!1)}r&&(a.splice(t--,1),e=s(s.s=n[0]))}return e}var r={},i={47:0},a=[];function s(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=r,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="";var o=window.webpackJsonp=window.webpackJsonp||[],u=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var l=u;a.push([1072,0,5]),n()}({100:function(e,t,n){var r=n(9),i=n(117),a=n(82),s=n(40),o=n(29),u=n(113),c=n(150),l=n(15),d=i("Reflect","construct"),f=l((function(){function e(){}return!(d((function(){}),[],e)instanceof e)})),p=!l((function(){d((function(){}))})),h=f||p;r({target:"Reflect",stat:!0,forced:h,sham:h},{construct:function(e,t){a(e),s(t);var n=arguments.length<3?e:a(arguments[2]);if(p&&!f)return d(e,t,n);if(e==n){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var r=[null];return r.push.apply(r,t),new(c.apply(e,r))}var i=n.prototype,l=u(o(i)?i:Object.prototype),h=Function.apply.call(e,l,t);return o(h)?h:l}})},1e3:function(e,t,n){"use strict";
/*
@license
Copyright (c) 2022 Twilio Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


*/function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),n(168);var i=r(n(188)),a=function(e){var t=i.default.getLevel();i.default.setLevel("warn"),i.default.warn(e),i.default.setLevel(t)};t.deprecated=function(e,t,n){return function(r,i,s){if("function"!=typeof s.value&&void 0===(null==s?void 0:s.get))throw new Error("The deprecated decorator can only be applied to methods or getters");if("function"!=typeof s.value){var o=s.get;s.get=function(){return a("The getter ".concat(e," is deprecated").concat(t?", use "+t+" instead":"").concat(n?", "+n:".")),null==o?void 0:o.apply(this)}}else{var u=s.value;s.value=function(){a("The method ".concat(e," is deprecated").concat(t?", use "+t+" instead":"").concat(n?", "+n:"."));for(var r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return u.apply(this,i)}}}},t.deprecationWarning=a},1001:function(e,t,n){"use strict";var r=n(48),i=n(141).find,a=n(487),s=!0;"find"in[]&&Array(1).find((function(){s=!1})),r({target:"Array",proto:!0,forced:s},{find:function(e){return i(this,e,arguments.length>1?arguments[1]:void 0)}}),a("find")},1002:function(e,t,n){"use strict";var r=n(48),i=n(631),a=n(41),s=n(90),o=n(404).onFreeze,u=Object.freeze;r({target:"Object",stat:!0,forced:a((function(){u(1)})),sham:!i},{freeze:function(e){return u&&s(e)?u(o(e)):e}})},1072:function(e,t,n){"use strict";n.r(t);var r=n(2),i=n.n(r),a=n(1),s=n.n(a),o=n(8),u=n(13),c=n.n(u),l=n(14),d=n.n(l),f=n(3),p=n.n(f),h=(n(986),n(28),n(5),n(20),n(25),n(30),n(52),function(){function e(){c()(this,e)}var t,n;return d()(e,null,[{key:"fromParticipant",value:(n=i()(s.a.mark((function e(t){var n,r,i,a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t.sid,e.t1=null!==(n=t.attributes)&&void 0!==n?n:void 0,e.t2=null!==(r=t.dateUpdated)&&void 0!==r?r:void 0,e.t3=null!==(i=t.dateCreated)&&void 0!==i?i:void 0,e.t4=null!==(a=t.identity)&&void 0!==a?a:void 0,e.t5=t.isTyping,e.t6=null!==(o=t.lastReadMessageIndex)&&void 0!==o?o:void 0,e.t7=t.type,e.t8=this,e.next=11,t.getUser();case 11:return e.t9=e.sent,e.t10=e.t8.fromUser.call(e.t8,e.t9),e.t11=t.conversation.sid,e.abrupt("return",{sid:e.t0,attributes:e.t1,dateUpdated:e.t2,dateCreated:e.t3,identity:e.t4,isTyping:e.t5,lastReadMessageIndex:e.t6,type:e.t7,user:e.t10,conversationId:e.t11});case 15:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"fromUser",value:function(e){var t,n,r,i;return{identity:e.identity,attributes:null!==(t=e.attributes)&&void 0!==t?t:void 0,friendlyName:null!==(n=e.friendlyName)&&void 0!==n?n:void 0,isOnline:null!==(r=e.isOnline)&&void 0!==r?r:void 0,isNotifiable:null!==(i=e.isNotifiable)&&void 0!==i?i:void 0,isSubscribed:e.isSubscribed}}},{key:"fromConversation",value:function(e){var t,n,r,i,a,s,o;return{sid:e.sid,uniqueName:null!==(t=e.uniqueName)&&void 0!==t?t:void 0,status:e.status,friendlyName:null!==(n=e.friendlyName)&&void 0!==n?n:void 0,dateUpdated:null!==(r=e.dateUpdated)&&void 0!==r?r:void 0,dateCreated:null!==(i=e.dateCreated)&&void 0!==i?i:void 0,createdBy:e.createdBy,attributes:null!==(a=e.attributes)&&void 0!==a?a:void 0,lastReadMessageIndex:null!==(s=e.lastReadMessageIndex)&&void 0!==s?s:void 0,lastMessage:null!==(o=e.lastMessage)&&void 0!==o?o:void 0,state:e.state}}},{key:"fromMessage",value:(t=i()(s.a.mark((function e(t){var n,r,a,o,u,c,l,d;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.getParticipant();case 3:d=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),d=void 0;case 9:if(e.t1=t.sid,e.t2=t.conversation.sid,e.t3=null!==(n=t.author)&&void 0!==n?n:void 0,e.t4=null!==(r=t.body)&&void 0!==r?r:void 0,e.t5=null!==(a=t.dateUpdated)&&void 0!==a?a:void 0,e.t6=t.index,e.t7=null!==(o=t.lastUpdatedBy)&&void 0!==o?o:void 0,e.t8=null!==(u=t.dateCreated)&&void 0!==u?u:void 0,e.t9=null!==(c=t.attributes)&&void 0!==c?c:void 0,e.t10=t.type,e.t11=null!==(l=t.participantSid)&&void 0!==l?l:void 0,!d){e.next=26;break}return e.next=23,this.fromParticipant(d);case 23:e.t12=e.sent,e.next=27;break;case 26:e.t12=void 0;case 27:if(e.t13=e.t12,!t.attachedMedia){e.next=34;break}return e.next=31,Promise.all(t.attachedMedia.map(function(){var e=i()(s.a.mark((function e(t){var n,r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t.sid,e.t1=null!==(n=t.filename)&&void 0!==n?n:void 0,e.t2=t.contentType,e.t3=t.size,e.t4=t.category,e.next=7,t.getContentTemporaryUrl();case 7:if(e.t6=r=e.sent,e.t5=null!==e.t6,!e.t5){e.next=11;break}e.t5=void 0!==r;case 11:if(!e.t5){e.next=15;break}e.t7=r,e.next=16;break;case 15:e.t7="";case 16:return e.t8=e.t7,e.abrupt("return",{sid:e.t0,filename:e.t1,contentType:e.t2,size:e.t3,category:e.t4,url:e.t8});case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 31:e.t14=e.sent,e.next=35;break;case 34:e.t14=void 0;case 35:return e.t15=e.t14,e.abrupt("return",{sid:e.t1,conversationId:e.t2,author:e.t3,body:e.t4,dateUpdated:e.t5,index:e.t6,lastUpdatedBy:e.t7,dateCreated:e.t8,attributes:e.t9,type:e.t10,participantSid:e.t11,participant:e.t13,attachedMedia:e.t15});case 37:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(e){return t.apply(this,arguments)})}]),e}()),v=function(){function e(t){var n=this;c()(this,e),p()(this,"send",void 0),p()(this,"initialized",(function(){n.send({event:"initialized"})})),p()(this,"initFailed",(function(e){var t=e.error;n.send({event:"initFailed",data:t})})),p()(this,"conversationAdded",(function(e){n.send({event:"conversationAdded",data:h.fromConversation(e)})})),p()(this,"conversationJoined",(function(e){n.send({event:"conversationJoined",data:h.fromConversation(e)})})),p()(this,"conversationLeft",(function(e){n.send({event:"conversationLeft",data:h.fromConversation(e)})})),p()(this,"conversationRemoved",(function(e){n.send({event:"conversationRemoved",data:h.fromConversation(e)})})),p()(this,"conversationUpdated",(function(e){n.send({event:"conversationUpdated",data:{conversation:h.fromConversation(e.conversation),updateReasons:e.updateReasons}})})),p()(this,"participantJoined",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromParticipant(t);case 3:e.t1=e.sent,e.t2={event:"participantJoined",data:e.t1},e.t0.send.call(e.t0,e.t2);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"participantLeft",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromParticipant(t);case 3:e.t1=e.sent,e.t2={event:"participantLeft",data:e.t1},e.t0.send.call(e.t0,e.t2);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"participantUpdated",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromParticipant(t.participant);case 3:e.t1=e.sent,e.t2=t.updateReasons,e.t3={participant:e.t1,updateReasons:e.t2},e.t4={event:"participantUpdated",data:e.t3},e.t0.send.call(e.t0,e.t4);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"typingStarted",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromParticipant(t);case 3:e.t1=e.sent,e.t2={event:"typingStarted",data:e.t1},e.t0.send.call(e.t0,e.t2);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"typingEnded",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromParticipant(t);case 3:e.t1=e.sent,e.t2={event:"typingEnded",data:e.t1},e.t0.send.call(e.t0,e.t2);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"messageAdded",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromMessage(t);case 3:e.t1=e.sent,e.t2={event:"messageAdded",data:e.t1},e.t0.send.call(e.t0,e.t2);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"messageRemoved",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromMessage(t);case 3:e.t1=e.sent,e.t2={event:"messageRemoved",data:e.t1},e.t0.send.call(e.t0,e.t2);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"messageUpdated",function(){var e=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,h.fromMessage(t.message);case 3:e.t1=e.sent,e.t2=t.updateReasons,e.t3={message:e.t1,updateReasons:e.t2},e.t4={event:"messageUpdated",data:e.t3},e.t0.send.call(e.t0,e.t4);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p()(this,"connectionError",(function(e){n.send({event:"connectionError",data:e})})),p()(this,"connectionStateChanged",(function(e){n.send({event:"connectionStateChanged",data:e})})),this.send=t}return d()(e,[{key:"register",value:function(e){e.registerClientEventCallback("initialized",this.initialized),e.registerClientEventCallback("initFailed",this.initFailed),e.registerClientEventCallback("conversationAdded",this.conversationAdded),e.registerClientEventCallback("conversationJoined",this.conversationJoined),e.registerClientEventCallback("conversationLeft",this.conversationLeft),e.registerClientEventCallback("conversationRemoved",this.conversationRemoved),e.registerClientEventCallback("conversationUpdated",this.conversationUpdated),e.registerClientEventCallback("participantJoined",this.participantJoined),e.registerClientEventCallback("participantLeft",this.participantLeft),e.registerClientEventCallback("participantUpdated",this.participantUpdated),e.registerClientEventCallback("messageAdded",this.messageAdded),e.registerClientEventCallback("messageRemoved",this.messageRemoved),e.registerClientEventCallback("messageUpdated",this.messageUpdated),e.registerClientEventCallback("typingStarted",this.typingStarted),e.registerClientEventCallback("typingEnded",this.typingEnded),e.registerClientEventCallback("connectionError",this.connectionError),e.registerClientEventCallback("connectionStateChanged",this.connectionStateChanged)}},{key:"clear",value:function(e){e.clearClientEventCallback()}}]),e}(),y=(n(19),n(685)),m=(n(100),n(17)),g=n.n(m),b=n(36),k=n.n(b),w=n(38),_=n.n(w),x=n(22),S=n.n(x),C=n(63),E=n.n(C);n(57);function R(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=S()(e);if(t){var i=S()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _()(this,n)}}var I=function(e){k()(n,e);var t=R(n);function n(e){var r;return c()(this,n),r=t.call(this),p()(g()(r),"name","MethodNotFound"),p()(g()(r),"code","METHOD_NOT_FOUND"),r.message="Unable to handle method: ".concat(e),r}return d()(n)}(E()(Error)),T=function(e){k()(n,e);var t=R(n);function n(){var e;c()(this,n);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),p()(g()(e),"name","UninitailizedClient"),p()(g()(e),"code","UNINITIALIZED_CLIENT"),p()(g()(e),"message","Twilio client is not initialized"),e}return d()(n)}(E()(Error)),P=function(e){k()(n,e);var t=R(n);function n(e,r){var i;return c()(this,n),i=t.call(this),p()(g()(i),"name","TwilioError"),p()(g()(i),"code",void 0),i.code=e,i.message=r,i}return d()(n)}(E()(Error)),A=function(){function e(){c()(this,e),p()(this,"_client",void 0),p()(this,"_clientToken",void 0),p()(this,"conversations",{})}var t,n,r,a,o,u,l,f,h,v,m,g;return d()(e,[{key:"client",get:function(){if(this._client)return this._client;throw new T}},{key:"getConversationBySid",value:(g=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.conversations[t]){e.next=4;break}return e.next=3,this.client.getConversationBySid(t);case 3:this.conversations[t]=e.sent;case 4:return e.abrupt("return",this.conversations[t]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"initialize",value:(m=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._client){e.next=7;break}if(this._clientToken===t){e.next=5;break}return e.next=4,this._client.updateToken(t);case 4:this._clientToken=t;case 5:e.next=11;break;case 7:return e.next=9,y.Client.create(t);case 9:this._client=e.sent,this._clientToken=t;case 11:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"shutdown",value:(v=i()(s.a.mark((function e(){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.client.shutdown();case 2:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"registerClientEventCallback",value:function(e,t){this.client.onWithReplay(e,t)}},{key:"clearClientEventCallback",value:function(){this.client.removeAllListeners()}},{key:"getMessages",value:(h=i()(s.a.mark((function e(t,n,r,i){var a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getConversationBySid(t);case 2:return a=e.sent,e.next=5,a.getMessages(n,r,i);case 5:return o=e.sent,e.abrupt("return",o);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return h.apply(this,arguments)})},{key:"getParticipant",value:(f=i()(s.a.mark((function e(t,n){var r,i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getConversationBySid(t);case 2:return r=e.sent,e.next=5,r.getParticipantByIdentity(n);case 5:return i=e.sent,e.abrupt("return",i);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"getUser",value:(l=i()(s.a.mark((function e(t){var n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.client.getUser(t);case 2:return n=e.sent,e.abrupt("return",n);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"getConversation",value:(u=i()(s.a.mark((function e(t){var n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getConversationBySid(t);case 2:return n=e.sent,e.abrupt("return",n);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"leaveConversation",value:(o=i()(s.a.mark((function e(t){var n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getConversationBySid(t);case 2:return n=e.sent,e.abrupt("return",n.leave());case 4:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"sendMessage",value:(a=i()(s.a.mark((function e(t,n,r){var i,a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getConversationBySid(t);case 2:return i=e.sent,e.next=5,i.sendMessage(n,r?{nonce:r}:void 0);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"sendUserEndedChatMessage",value:(r=i()(s.a.mark((function e(t){var n,r,i,a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getConversationBySid(t);case 2:return r=e.sent,e.next=5,r.getMessages();case 5:if(e.t1=n=e.sent,e.t0=null===e.t1,e.t0){e.next=9;break}e.t0=void 0===n;case 9:if(!e.t0){e.next=13;break}e.t2=void 0,e.next=14;break;case 13:e.t2=n.items;case 14:if(null==(i=e.t2)||!i.length){e.next=18;break}return e.next=18,r.sendMessage("Customer has disconnected from the chat",{userEndedChat:!0,notification:!0});case 18:if(a=null==i?void 0:i.filter((function(e){var t,n;return"agent"===(null===(t=e.attributes)||void 0===t||null===(n=t.senderInfo)||void 0===n?void 0:n.type)})).length,null==i||!i.length||0!==a){e.next=22;break}return e.next=22,r.updateAttributes({userAbandonedChat:!0});case 22:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"sendFile",value:(n=i()(s.a.mark((function e(t,n,r){var i,a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=new FormData).append("file",n),e.next=4,this.getConversationBySid(t);case 4:return a=e.sent,o=a.sendMessage(i,r?{nonce:r}:void 0),e.abrupt("return",o);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"sendTyping",value:(t=i()(s.a.mark((function e(t){var n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getConversationBySid(t);case 2:return n=e.sent,e.next=5,n.typing();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),O=function(){function e(t){c()(this,e),p()(this,"service",void 0),p()(this,"clientEventsHandler",void 0),this.service=new A,this.clientEventsHandler=new v(t)}var t,n,r,a,o,u,l,f,y,m,g,b;return d()(e,[{key:"handleMethods",value:(b=i()(s.a.mark((function e(t,n){var r,i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.method,i=t.params,e.t0=r,e.next="initialize"===e.t0?4:"shutdown"===e.t0?7:"getMessages"===e.t0?10:"getConversation"===e.t0?13:"leaveConversation"===e.t0?16:"sendMessage"===e.t0?19:"sendFile"===e.t0?22:"sendTyping"===e.t0?25:"getParticipant"===e.t0?28:"getUser"===e.t0?31:"sendUserEndedChatMessage"===e.t0?34:37;break;case 4:return e.next=6,this.initialize(i,n);case 6:return e.abrupt("break",38);case 7:return e.next=9,this.shutdown(n);case 9:return e.abrupt("break",38);case 10:return e.next=12,this.getMessages(i,n);case 12:return e.abrupt("break",38);case 13:return e.next=15,this.getConversation(i,n);case 15:return e.abrupt("break",38);case 16:return e.next=18,this.leaveConversation(i,n);case 18:return e.abrupt("break",38);case 19:return e.next=21,this.sendMessage(i,n);case 21:return e.abrupt("break",38);case 22:return e.next=24,this.sendFile(i,n);case 24:return e.abrupt("break",38);case 25:return e.next=27,this.sendTyping(i,n);case 27:return e.abrupt("break",38);case 28:return e.next=30,this.getParticipant(i,n);case 30:return e.abrupt("break",38);case 31:return e.next=33,this.getUser(i,n);case 33:return e.abrupt("break",38);case 34:return e.next=36,this.sendUserEndedChatMessage(i,n);case 36:return e.abrupt("break",38);case 37:throw new I(r);case 38:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"registerEventCallbacks",value:function(){this.clientEventsHandler.register(this.service)}},{key:"clearEventCallbacks",value:function(){this.clientEventsHandler.clear(this.service)}},{key:"initialize",value:(g=i()(s.a.mark((function e(t,n){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.service.initialize(t.token);case 2:this.registerEventCallbacks(),n({method:"initialize"});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"shutdown",value:(m=i()(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.service.shutdown();case 2:this.clearEventCallbacks(),t({method:"shutdown"});case 4:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"getConversation",value:(y=i()(s.a.mark((function e(t,n){var r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.service.getConversation(t.conversationId);case 2:r=e.sent,n({method:"getConversation",data:h.fromConversation(r)});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"leaveConversation",value:(f=i()(s.a.mark((function e(t,n){var r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.service.leaveConversation(t.conversationId);case 2:r=e.sent,n({method:"leaveConversation",data:h.fromConversation(r)});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"getMessages",value:(l=i()(s.a.mark((function e(t,n){var r,i,a,o,u;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.conversationId,i=t.pageSize,a=t.anchor,o=t.direction,e.next=3,this.service.getMessages(r,i,a,o).catch((function(e){throw new P(e.code,e.message)}));case 3:return u=e.sent,e.t0=n,e.next=7,Promise.all(u.items.map((function(e){return h.fromMessage(e)})));case 7:e.t1=e.sent,e.t2=u.hasNextPage,e.t3=u.hasPrevPage,e.t4={items:e.t1,hasNextPage:e.t2,hasPrevPage:e.t3},e.t5={method:"getMessages",data:e.t4},(0,e.t0)(e.t5);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"sendMessage",value:(u=i()(s.a.mark((function e(t,n){var r,i,a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.conversationId,i=t.message,a=t.nonce,e.next=3,this.service.sendMessage(r,i,a).catch((function(e){throw new P(e.code,e.message)}));case 3:o=e.sent,n({method:"sendMessage",data:{index:o}});case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"sendFile",value:(o=i()(s.a.mark((function e(t,n){var r,i,a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.conversationId,i=t.file,a=t.nonce,e.next=3,this.service.sendFile(r,i,a).catch((function(e){throw new P(e.code,e.message)}));case 3:o=e.sent,n({method:"sendFile",data:{index:o}});case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"sendTyping",value:(a=i()(s.a.mark((function e(t,n){var r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.conversationId,e.next=3,this.service.sendTyping(r).catch((function(e){throw new P(e.code,e.message)}));case 3:n({method:"sendTyping"});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"sendUserEndedChatMessage",value:(r=i()(s.a.mark((function e(t,n){var r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.conversationId,e.next=3,this.service.sendUserEndedChatMessage(r).catch((function(e){throw new P(e.code,e.message)}));case 3:n({method:"sendUserEndedChatMessage"});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"getParticipant",value:(n=i()(s.a.mark((function e(t,n){var r,i,a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.conversationId,i=t.identity,e.next=3,this.service.getParticipant(r,i).catch((function(e){throw new P(e.code,e.message)}));case 3:if(a=e.sent,e.t0=n,!a){e.next=11;break}return e.next=8,h.fromParticipant(a);case 8:e.t1=e.sent,e.next=12;break;case 11:e.t1=void 0;case 12:e.t2=e.t1,e.t3={method:"getParticipant",data:e.t2},(0,e.t0)(e.t3);case 15:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"getUser",value:(t=i()(s.a.mark((function e(t,n){var r,i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.identity,e.next=3,this.service.getUser(r).catch((function(e){throw new P(e.code,e.message)}));case 3:i=e.sent,n({method:"getUser",data:h.fromUser(i)});case 5:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})}],[{key:"getInstance",value:function(t){return e.instance||(e.instance=new e(t)),e.instance}}]),e}();p()(O,"instance",void 0);Object(o.a)({app:function(e){var t;e.subscribe((t=e.send,function(){var e=i()(s.a.mark((function e(n,r){var i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=O.getInstance(t),e.next=3,i.handleMethods(n,r).catch((function(e){r({method:n.method,error:{code:e.code,message:e.message}})}));case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()))},owner:"merchant_support_experience"})},150:function(e,t,n){"use strict";var r=n(82),i=n(29),a=[].slice,s={},o=function(e,t,n){if(!(t in s)){for(var r=[],i=0;i<t;i++)r[i]="a["+i+"]";s[t]=Function("C,a","return new C("+r.join(",")+")")}return s[t](e,n)};e.exports=Function.bind||function(e){var t=r(this),n=a.call(arguments,1),s=function(){var r=n.concat(a.call(arguments));return this instanceof s?o(t,r.length,r):t.apply(e,r)};return i(t.prototype)&&(s.prototype=t.prototype),s}},207:function(e,t,n){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var r=n(449),i=n(450),a=n(451);function s(){return u.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function o(e,t){if(s()<t)throw new RangeError("Invalid typed array length");return u.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=u.prototype:(null===e&&(e=new u(t)),e.length=t),e}function u(e,t,n){if(!(u.TYPED_ARRAY_SUPPORT||this instanceof u))return new u(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return d(this,e)}return c(this,e,t,n)}function c(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r);u.TYPED_ARRAY_SUPPORT?(e=t).__proto__=u.prototype:e=f(e,t);return e}(e,t,n,r):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!u.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|h(t,n),i=(e=o(e,r)).write(t,n);i!==r&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(u.isBuffer(t)){var n=0|p(t.length);return 0===(e=o(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?o(e,0):f(e,t);if("Buffer"===t.type&&a(t.data))return f(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function d(e,t){if(l(t),e=o(e,t<0?0:0|p(t)),!u.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function f(e,t){var n=t.length<0?0:0|p(t.length);e=o(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function p(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function h(e,t){if(u.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return B(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return q(e).length;default:if(r)return B(e).length;t=(""+t).toLowerCase(),r=!0}}function v(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return T(this,t,n);case"utf8":case"utf-8":return E(this,t,n);case"ascii":return R(this,t,n);case"latin1":case"binary":return I(this,t,n);case"base64":return C(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function y(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function m(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=u.from(t,r)),u.isBuffer(t))return 0===t.length?-1:g(e,t,n,r,i);if("number"==typeof t)return t&=255,u.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):g(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function g(e,t,n,r,i){var a,s=1,o=e.length,u=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,o/=2,u/=2,n/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(a=n;a<o;a++)if(c(e,a)===c(t,-1===l?0:a-l)){if(-1===l&&(l=a),a-l+1===u)return l*s}else-1!==l&&(a-=a-l),l=-1}else for(n+u>o&&(n=o-u),a=n;a>=0;a--){for(var d=!0,f=0;f<u;f++)if(c(e,a+f)!==c(t,f)){d=!1;break}if(d)return a}return-1}function b(e,t,n,r){n=Number(n)||0;var i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;var a=t.length;if(a%2!=0)throw new TypeError("Invalid hex string");r>a/2&&(r=a/2);for(var s=0;s<r;++s){var o=parseInt(t.substr(2*s,2),16);if(isNaN(o))return s;e[n+s]=o}return s}function k(e,t,n,r){return z(B(t,e.length-n),e,n,r)}function w(e,t,n,r){return z(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function _(e,t,n,r){return w(e,t,n,r)}function x(e,t,n,r){return z(q(t),e,n,r)}function S(e,t,n,r){return z(function(e,t){for(var n,r,i,a=[],s=0;s<e.length&&!((t-=2)<0);++s)n=e.charCodeAt(s),r=n>>8,i=n%256,a.push(i),a.push(r);return a}(t,e.length-n),e,n,r)}function C(e,t,n){return 0===t&&n===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,n))}function E(e,t,n){n=Math.min(e.length,n);for(var r=[],i=t;i<n;){var a,s,o,u,c=e[i],l=null,d=c>239?4:c>223?3:c>191?2:1;if(i+d<=n)switch(d){case 1:c<128&&(l=c);break;case 2:128==(192&(a=e[i+1]))&&(u=(31&c)<<6|63&a)>127&&(l=u);break;case 3:a=e[i+1],s=e[i+2],128==(192&a)&&128==(192&s)&&(u=(15&c)<<12|(63&a)<<6|63&s)>2047&&(u<55296||u>57343)&&(l=u);break;case 4:a=e[i+1],s=e[i+2],o=e[i+3],128==(192&a)&&128==(192&s)&&128==(192&o)&&(u=(15&c)<<18|(63&a)<<12|(63&s)<<6|63&o)>65535&&u<1114112&&(l=u)}null===l?(l=65533,d=1):l>65535&&(l-=65536,r.push(l>>>10&1023|55296),l=56320|1023&l),r.push(l),i+=d}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=4096));return n}(r)}t.Buffer=u,t.SlowBuffer=function(e){+e!=e&&(e=0);return u.alloc(+e)},t.INSPECT_MAX_BYTES=50,u.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=s(),u.poolSize=8192,u._augment=function(e){return e.__proto__=u.prototype,e},u.from=function(e,t,n){return c(null,e,t,n)},u.TYPED_ARRAY_SUPPORT&&(u.prototype.__proto__=Uint8Array.prototype,u.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&u[Symbol.species]===u&&Object.defineProperty(u,Symbol.species,{value:null,configurable:!0})),u.alloc=function(e,t,n){return function(e,t,n,r){return l(t),t<=0?o(e,t):void 0!==n?"string"==typeof r?o(e,t).fill(n,r):o(e,t).fill(n):o(e,t)}(null,e,t,n)},u.allocUnsafe=function(e){return d(null,e)},u.allocUnsafeSlow=function(e){return d(null,e)},u.isBuffer=function(e){return!(null==e||!e._isBuffer)},u.compare=function(e,t){if(!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,i=0,a=Math.min(n,r);i<a;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=u.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var s=e[n];if(!u.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(r,i),i+=s.length}return r},u.byteLength=h,u.prototype._isBuffer=!0,u.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)y(this,t,t+1);return this},u.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)y(this,t,t+3),y(this,t+1,t+2);return this},u.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)y(this,t,t+7),y(this,t+1,t+6),y(this,t+2,t+5),y(this,t+3,t+4);return this},u.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?E(this,0,e):v.apply(this,arguments)},u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},u.prototype.compare=function(e,t,n,r,i){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var a=(i>>>=0)-(r>>>=0),s=(n>>>=0)-(t>>>=0),o=Math.min(a,s),c=this.slice(r,i),l=e.slice(t,n),d=0;d<o;++d)if(c[d]!==l[d]){a=c[d],s=l[d];break}return a<s?-1:s<a?1:0},u.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},u.prototype.indexOf=function(e,t,n){return m(this,e,t,n,!0)},u.prototype.lastIndexOf=function(e,t,n){return m(this,e,t,n,!1)},u.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var a=!1;;)switch(r){case"hex":return b(this,e,t,n);case"utf8":case"utf-8":return k(this,e,t,n);case"ascii":return w(this,e,t,n);case"latin1":case"binary":return _(this,e,t,n);case"base64":return x(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return S(this,e,t,n);default:if(a)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),a=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function R(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function I(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function T(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var i="",a=t;a<n;++a)i+=F(e[a]);return i}function P(e,t,n){for(var r=e.slice(t,n),i="",a=0;a<r.length;a+=2)i+=String.fromCharCode(r[a]+256*r[a+1]);return i}function A(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function O(e,t,n,r,i,a){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<a)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function M(e,t,n,r){t<0&&(t=65535+t+1);for(var i=0,a=Math.min(e.length-n,2);i<a;++i)e[n+i]=(t&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function U(e,t,n,r){t<0&&(t=4294967295+t+1);for(var i=0,a=Math.min(e.length-n,4);i<a;++i)e[n+i]=t>>>8*(r?i:3-i)&255}function j(e,t,n,r,i,a){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function N(e,t,n,r,a){return a||j(e,0,n,4),i.write(e,t,n,r,23,4),n+4}function L(e,t,n,r,a){return a||j(e,0,n,8),i.write(e,t,n,r,52,8),n+8}u.prototype.slice=function(e,t){var n,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),u.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=u.prototype;else{var i=t-e;n=new u(i,void 0);for(var a=0;a<i;++a)n[a]=this[a+e]}return n},u.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||A(e,t,this.length);for(var r=this[e],i=1,a=0;++a<t&&(i*=256);)r+=this[e+a]*i;return r},u.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||A(e,t,this.length);for(var r=this[e+--t],i=1;t>0&&(i*=256);)r+=this[e+--t]*i;return r},u.prototype.readUInt8=function(e,t){return t||A(e,1,this.length),this[e]},u.prototype.readUInt16LE=function(e,t){return t||A(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUInt16BE=function(e,t){return t||A(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUInt32LE=function(e,t){return t||A(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUInt32BE=function(e,t){return t||A(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||A(e,t,this.length);for(var r=this[e],i=1,a=0;++a<t&&(i*=256);)r+=this[e+a]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},u.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||A(e,t,this.length);for(var r=t,i=1,a=this[e+--r];r>0&&(i*=256);)a+=this[e+--r]*i;return a>=(i*=128)&&(a-=Math.pow(2,8*t)),a},u.prototype.readInt8=function(e,t){return t||A(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){t||A(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt16BE=function(e,t){t||A(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt32LE=function(e,t){return t||A(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return t||A(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readFloatLE=function(e,t){return t||A(e,4,this.length),i.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return t||A(e,4,this.length),i.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return t||A(e,8,this.length),i.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return t||A(e,8,this.length),i.read(this,e,!1,52,8)},u.prototype.writeUIntLE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||O(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,a=0;for(this[t]=255&e;++a<n&&(i*=256);)this[t+a]=e/i&255;return t+n},u.prototype.writeUIntBE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||O(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,a=1;for(this[t+i]=255&e;--i>=0&&(a*=256);)this[t+i]=e/a&255;return t+n},u.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,1,255,0),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},u.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):M(this,e,t,!0),t+2},u.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):M(this,e,t,!1),t+2},u.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):U(this,e,t,!0),t+4},u.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):U(this,e,t,!1),t+4},u.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);O(this,e,t,n,i-1,-i)}var a=0,s=1,o=0;for(this[t]=255&e;++a<n&&(s*=256);)e<0&&0===o&&0!==this[t+a-1]&&(o=1),this[t+a]=(e/s>>0)-o&255;return t+n},u.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);O(this,e,t,n,i-1,-i)}var a=n-1,s=1,o=0;for(this[t+a]=255&e;--a>=0&&(s*=256);)e<0&&0===o&&0!==this[t+a+1]&&(o=1),this[t+a]=(e/s>>0)-o&255;return t+n},u.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,1,127,-128),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},u.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):M(this,e,t,!0),t+2},u.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):M(this,e,t,!1),t+2},u.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,4,2147483647,-2147483648),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):U(this,e,t,!0),t+4},u.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||O(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):U(this,e,t,!1),t+4},u.prototype.writeFloatLE=function(e,t,n){return N(this,e,t,!0,n)},u.prototype.writeFloatBE=function(e,t,n){return N(this,e,t,!1,n)},u.prototype.writeDoubleLE=function(e,t,n){return L(this,e,t,!0,n)},u.prototype.writeDoubleBE=function(e,t,n){return L(this,e,t,!1,n)},u.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i,a=r-n;if(this===e&&n<t&&t<r)for(i=a-1;i>=0;--i)e[i+t]=this[i+n];else if(a<1e3||!u.TYPED_ARRAY_SUPPORT)for(i=0;i<a;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+a),t);return a},u.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var a;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(a=t;a<n;++a)this[a]=e;else{var s=u.isBuffer(e)?e:B(new u(e,r).toString()),o=s.length;for(a=0;a<n-t;++a)this[a+t]=s[a%o]}return this};var D=/[^+\/0-9A-Za-z-_]/g;function F(e){return e<16?"0"+e.toString(16):e.toString(16)}function B(e,t){var n;t=t||1/0;for(var r=e.length,i=null,a=[],s=0;s<r;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&a.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&a.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&a.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;a.push(n)}else if(n<2048){if((t-=2)<0)break;a.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;a.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return a}function q(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(D,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function z(e,t,n,r){for(var i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}}).call(this,n(99))},449:function(e,t,n){"use strict";t.byteLength=function(e){var t=c(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,r=c(e),s=r[0],o=r[1],u=new a(function(e,t,n){return 3*(t+n)/4-n}(0,s,o)),l=0,d=o>0?s-4:s;for(n=0;n<d;n+=4)t=i[e.charCodeAt(n)]<<18|i[e.charCodeAt(n+1)]<<12|i[e.charCodeAt(n+2)]<<6|i[e.charCodeAt(n+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;2===o&&(t=i[e.charCodeAt(n)]<<2|i[e.charCodeAt(n+1)]>>4,u[l++]=255&t);1===o&&(t=i[e.charCodeAt(n)]<<10|i[e.charCodeAt(n+1)]<<4|i[e.charCodeAt(n+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t);return u},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,a=[],s=0,o=n-i;s<o;s+=16383)a.push(l(e,s,s+16383>o?o:s+16383));1===i?(t=e[n-1],a.push(r[t>>2]+r[t<<4&63]+"==")):2===i&&(t=(e[n-2]<<8)+e[n-1],a.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"="));return a.join("")};for(var r=[],i=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,u=s.length;o<u;++o)r[o]=s[o],i[s.charCodeAt(o)]=o;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e,t,n){for(var i,a,s=[],o=t;o<n;o+=3)i=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(r[(a=i)>>18&63]+r[a>>12&63]+r[a>>6&63]+r[63&a]);return s.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},450:function(e,t){t.read=function(e,t,n,r,i){var a,s,o=8*i-r-1,u=(1<<o)-1,c=u>>1,l=-7,d=n?i-1:0,f=n?-1:1,p=e[t+d];for(d+=f,a=p&(1<<-l)-1,p>>=-l,l+=o;l>0;a=256*a+e[t+d],d+=f,l-=8);for(s=a&(1<<-l)-1,a>>=-l,l+=r;l>0;s=256*s+e[t+d],d+=f,l-=8);if(0===a)a=1-c;else{if(a===u)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,r),a-=c}return(p?-1:1)*s*Math.pow(2,a-r)},t.write=function(e,t,n,r,i,a){var s,o,u,c=8*a-i-1,l=(1<<c)-1,d=l>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:a-1,h=r?1:-1,v=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),(t+=s+d>=1?f/u:f*Math.pow(2,1-d))*u>=2&&(s++,u/=2),s+d>=l?(o=0,s=l):s+d>=1?(o=(t*u-1)*Math.pow(2,i),s+=d):(o=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+p]=255&o,p+=h,o/=256,i-=8);for(s=s<<i|o,c+=i;c>0;e[n+p]=255&s,p+=h,s/=256,c-=8);e[n+p-h]|=128*v}},451:function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},524:function(e,t,n){"use strict";
/*
@license
Copyright (c) 2021 Twilio Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


*/Object.defineProperty(t,"__esModule",{value:!0});var r=n(4);n(298);var i=n(18);n(133),n(156),n(167),n(168),n(264),n(165),n(166),n(189),n(662),n(239),n(241),n(297),n(355),n(157);var a=n(70),s=n(14),o=n(13),u=n(36),c=n(38),l=n(22);function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}n(299),n(142),n(221),n(400),n(242),n(401);var f=d(r),p=d(i),h=d(a),v=d(s),y=d(o),m=d(u),g=d(c),b=d(l),k=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{checks:t}},w=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return k((function(e){for(var n=!1,r=[],i=0,a=t;i<a.length;i++){var s=a[i];"string"!=typeof s?(n=n||e instanceof s,r.push("an instance of ".concat(s.name))):(n=n||f.default(e)===s,r.push("of type ".concat(s)))}return[n,r]}))};function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=b.default(e);if(t){var i=b.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return g.default(this,n)}}function x(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return S(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return S(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var C=function(e,t){if(t.length>e.length)throw new Error("Expected at most ".concat(e.length," argument(s), but got ").concat(t.length));for(;t.length<e.length;)t.push(void 0);var n,r=x(t.entries());try{for(r.s();!(n=r.n()).done;){var i=p.default(n.value,2),a=i[0],s=i[1],o=T(e[a],s),u=p.default(o,4),c=u[0],l=u[1],d=u[2],f=u[3];if(!c)throw new Error("Argument ".concat(a+1," is expected to be ").concat(d).concat(f," but got ").concat(l))}}catch(e){r.e(e)}finally{r.f()}},E=function(e){var t,n,r;(["undefined","boolean","number","bigint","string"].includes(f.default(e))&&(n="string"==typeof e?'"'.concat(e,'"'):"".concat(e)),"object"===f.default(e)&&"Object"!==(null==e||null===(t=e.constructor)||void 0===t?void 0:t.name))&&(n=null===e?"null":"instance of ".concat(null==e||null===(r=e.constructor)||void 0===r?void 0:r.name));return n||(n=f.default(e)),n},R=function(e){var t,n=[],r=x(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;n.push(I(i))}}catch(e){r.e(e)}finally{r.f()}return n},I=function(e){var t,n=[],r=x(Array.isArray(e)?e:[e]);try{for(r.s();!(t=r.n()).done;){var i=t.value;"string"!=typeof i&&"function"!=typeof i?n.push(i):n.push(w(i))}}catch(e){r.e(e)}finally{r.f()}return n},T=function(e,t){var n,r,i=[],a=!1,s=x(e);try{for(s.s();!(r=s.n()).done;){var o,u=x(r.value.checks);try{for(u.s();!(o=u.n()).done;){var c=(0,o.value)(t),l=p.default(c,3),d=l[0],f=l[1],v=l[2];a=a||d,!n&&v&&(n=v),f&&(i=[].concat(h.default(i),"string"==typeof f?[f]:h.default(f)))}}catch(e){u.e(e)}finally{u.f()}}}catch(e){s.e(e)}finally{s.f()}if(a)return[!0];var y=n||E(t),m=i.length-1;return[!1,y,m>0?"".concat(i.slice(0,m).join(", ")," or ").concat(i[m]):i.join(", "),m>1?";":","]};function P(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return A(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return A(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var O=k((function(e){return["string"==typeof e&&e.length>0,"a non-empty string"]})),M=k((function(e){return["number"==typeof e&&Number.isInteger(e)&&e>=0,"a non-negative integer"]})),U=k((function(e){return["object"===f.default(e)&&null!==e&&!Array.isArray(e),"a pure object (non-null and non-array)"]}));function j(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return N(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return N(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function N(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}t.array=function(e,t){return k((function(n){if(!Array.isArray(n))return[!1,"an array of ".concat(e)];var r,i=j(n.entries());try{for(i.s();!(r=i.n()).done;){var a=p.default(r.value,2),s=a[0],o=a[1],u=T(I(t),o),c=p.default(u,3),l=c[0],d=c[1],f=c[2];if(!l)return[!1,"a valid array of ".concat(e," (index ").concat(s," should be ").concat(f,")"),"malformed array of ".concat(e," (index ").concat(s," is ").concat(d,")")]}}catch(e){i.e(e)}finally{i.f()}return[!0]}))},t.custom=k,t.literal=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return k((function(e){for(var n=!1,r=[],i=0,a=t;i<a.length;i++){var s=a[i];n=n||e===s,r.push("string"==typeof s?'"'.concat(s,'"'):"".concat(s))}return[n,r]}))},t.nonEmptyArray=function(e,t){return k((function(n){if(!Array.isArray(n)||n.length<1)return[!1,"a non-empty array of ".concat(e)];var r,i=P(n.entries());try{for(i.s();!(r=i.n()).done;){var a=p.default(r.value,2),s=a[0],o=a[1],u=T(I(t),o),c=p.default(u,3),l=c[0],d=c[1],f=c[2];if(!l)return[!1,"a valid non-empty array of ".concat(e," (index ").concat(s," should be ").concat(f,")"),"malformed array of ".concat(e," (index ").concat(s," is ").concat(d,")")]}}catch(e){i.e(e)}finally{i.f()}return[!0]}))},t.nonEmptyString=O,t.nonNegativeInteger=M,t.objectSchema=function(e,t){return k((function(n){if("object"!==f.default(n)||null===n||Array.isArray(n))return[!1,"valid ".concat(e," (should be a pure object)")];for(var r=0,i=Object.entries(t);r<i.length;r++){var a=p.default(i[r],2),s=a[0],o=a[1],u=T(I(o),n[s]),c=p.default(u,3),l=c[0],d=c[1],h=c[2];if(!l)return[!1,"valid ".concat(e,' (key "').concat(s,'" should be ').concat(h,")"),"malformed ".concat(e,' (key "').concat(s,'" is ').concat(d,")")]}return[!0]}))},t.pureObject=U,t.runtimeTypeValidation=C,t.stringifyReceivedType=E,t.type=w,t.validateConstructorTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=R(t);return function(e){return function(e){m.default(n,e);var t=_(n);function n(){y.default(this,n);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return C(r,i),t.call.apply(t,[this].concat(i))}return v.default(n)}(e)}},t.validateTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=R(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypes decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return C(r,t),i.apply(this,t)}}},t.validateTypesAsync=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=R(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypesAsync decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];try{C(r,t)}catch(e){return Promise.reject(e)}return i.apply(this,t)}}}},57:function(e,t,n){"use strict";var r=n(9),i=n(15),a=n(103),s=n(29),o=n(42),u=n(33),c=n(87),l=n(106),d=n(58),f=n(45),p=n(107),h=f("isConcatSpreadable"),v=p>=51||!i((function(){var e=[];return e[h]=!1,e.concat()[0]!==e})),y=d("concat"),m=function(e){if(!s(e))return!1;var t=e[h];return void 0!==t?!!t:a(e)};r({target:"Array",proto:!0,forced:!v||!y},{concat:function(e){var t,n,r,i,a,s=o(this),d=l(s,0),f=0;for(t=-1,r=arguments.length;t<r;t++)if(m(a=-1===t?s:arguments[t])){if(f+(i=u(a.length))>9007199254740991)throw TypeError("Maximum allowed index exceeded");for(n=0;n<i;n++,f++)n in a&&c(d,f,a[n])}else{if(f>=9007199254740991)throw TypeError("Maximum allowed index exceeded");c(d,f++,a)}return d.length=f,d}})},662:function(e,t,n){"use strict";n(189);var r,i,a=n(48),s=n(71),o=n(69),u=n(94),c=n(105),l=(r=!1,(i=/[ac]/).exec=function(){return r=!0,/./.exec.apply(this,arguments)},!0===i.test("abc")&&r),d=/./.test;a({target:"RegExp",proto:!0,forced:!l},{test:function(e){var t=u(this),n=c(e),r=t.exec;if(!o(r))return s(d,t,n);var i=s(r,t,n);return null!==i&&(u(i),!0)}})},685:function(e,t,n){"use strict";(function(e){
/*
@license
The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2019, Twilio, inc.
    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      1. Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.

      2. Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in
         the documentation and/or other materials provided with the
         distribution.

      3. Neither the name of Twilio nor the names of its contributors may
         be used to endorse or promote products derived from this software
         without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes javascript-state-machine under the following license.

    Copyright (c) 2012, 2013, 2014, 2015, Jake Gordon and contributors

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

This software includes loglevel under the following license.

    Copyright (c) 2013 Tim Perry

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.

This software includes q under the following license.

    Copyright 2009–2014 Kristopher Michael Kowal. All rights reserved.
    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to
    deal in the Software without restriction, including without limitation the
    rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
    sell copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
    IN THE SOFTWARE.

This software includes platform.js under the following license.

    Copyright 2014 Benjamin Tan <https://d10.github.io/>
    Copyright 2011-2015 John-David Dalton <http://allyoucanleet.com/>

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

*/
var r=void 0!==r?r:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};Object.defineProperty(t,"__esModule",{value:!0}),n(355),n(157),n(352),n(239),n(247),n(353),n(354);var i=n(2),a=n(17),s=n(36),o=n(38),u=n(22),c=n(3),l=n(14),d=n(13);n(300),n(156),n(245),n(142);var f=n(1),p=n(4);n(168),n(165),n(166);var h=n(188),v=n(597);n(133),n(167),n(486),n(242),n(189),n(302),n(221);var y=n(524),m=n(70);n(299);var g=n(987),b=n(627);n(264),n(298),n(662),n(241),n(297);var k=n(18);n(244);var w=n(222),_=n(349),x=n(988),S=n(989),C=n(990);n(351),n(400),n(495),n(992),n(496),n(498),n(499),n(500),n(501),n(502),n(503),n(504),n(505),n(506),n(507),n(508),n(509),n(510),n(512),n(513),n(514),n(515),n(516),n(517),n(519),n(520),n(521),n(993),n(994),n(995),n(996),n(523),n(997);var E=n(1e3);n(401),n(1001),n(522);var R=n(63),I=n(246);function T(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function P(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}n(1002);var A=T(i),O=T(a),M=T(s),U=T(o),j=T(u),N=T(c),L=T(l),D=T(d),F=T(f),B=T(p),q=P(h),z=T(m),J=T(b),W=T(k),Y=T(R);function H(e,t,n,r){var i,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":B.default(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(a<3?i(s):a>3?i(t,n,s):i(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s}function Q(e,t){if("object"===("undefined"==typeof Reflect?"undefined":B.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function V(e,t){return["".concat((new Date).toISOString()," Conversations ").concat(e,":")].concat(Array.from(t))}var G=q.getLogger("twilio-conversations"),K=function(){function e(t){D.default(this,e),N.default(this,"prefix",""),this.prefix=null!=t&&t.length>0?t+" ":""}return L.default(e,[{key:"setLevel",value:function(e){G.setLevel(e)}},{key:"trace",value:function(){if(G.getLevel()==G.levels.TRACE){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.debug.apply(null,V(this.prefix+"T",t))}}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.debug.apply(null,V(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.info.apply(null,V(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.warn.apply(null,V(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.error.apply(null,V(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){G.setLevel(e)}},{key:"trace",value:function(){if(G.getLevel()==G.levels.TRACE){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.debug.apply(null,V("T",t))}}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.debug.apply(null,V("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.info.apply(null,V("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.warn.apply(null,V("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];G.error.apply(null,V("E",t))}}]),e}();function $(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function X(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$(Object(n),!0).forEach((function(t){N.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Z=L.default((function e(){var t,n,r,i,a,s,o,u,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},l=arguments.length>1?arguments[1]:void 0,d=arguments.length>2?arguments[2]:void 0;D.default(this,e),N.default(this,"typingIndicatorTimeoutDefault",5e3);var f=c.Chat||c.IPMessaging||c||{};this.productId=f.productId,this.links={myConversations:l.links.my_conversations,conversations:l.links.conversations,users:l.links.users,currentUser:l.links.current_user,typing:l.links.typing,mediaService:l.links.media_service,mediaSetService:l.links.media_set_service,messagesReceipts:l.links.messages_receipts},this.limits={mediaAttachmentsCountLimit:l.options.media_attachments_count_limit,mediaAttachmentSizeLimitInMb:l.options.media_attachment_size_limit_in_mb,mediaAttachmentsTotalSizeLimitInMb:l.options.media_attachments_total_size_limit_in_mb,emailHistoriesAllowedContentTypes:l.options.email_histories_allowed_mime_types,emailBodiesAllowedContentTypes:l.options.email_bodies_allowed_mime_types},this.typingIndicatorTimeoutOverride=f.typingIndicatorTimeoutOverride,this.backoffConfiguration=X({min:1e3,max:4e3,maxAttemptsCount:3},f.backoffConfigOverride),this.retryWhenThrottled=void 0===f.retryWhenThrottledOverride||f.retryWhenThrottledOverride,this.userInfosToSubscribe=null!==(t=null!==(n=f.userInfosToSubscribeOverride)&&void 0!==n?n:l.options.user_infos_to_subscribe)&&void 0!==t?t:100,this.reachabilityEnabled=l.options.reachability_enabled,this.userIdentity=l.identity,this.userInfo=l.sync_objects.my_user_info,this.myConversations=l.sync_objects.my_conversations;var p=null!==(r=null!==(i=f.httpCacheIntervalOverride)&&void 0!==i?i:l.options.http_cache_interval)&&void 0!==r?r:"PT5S";try{this.httpCacheInterval=v.toSeconds(v.parse(p))}catch(e){d.error("Failed to parse http cache interval ".concat(p,", using default value ").concat("PT5S")),this.httpCacheInterval=v.toSeconds(v.parse("PT5S"))}var h=null!==(a=null!==(s=f.consumptionReportIntervalOverride)&&void 0!==s?s:l.options.consumption_report_interval)&&void 0!==a?a:"PT5S";try{this.consumptionReportInterval=v.toSeconds(v.parse(h))}catch(e){d.error("Failed to parse consumption report interval ".concat(h,", using default value ").concat("PT5S")),this.consumptionReportInterval=v.toSeconds(v.parse("PT5S"))}this.channelMetadataCacheCapacity=null!==(o=c.channelMetadataCacheCapacity)&&void 0!==o?o:100,this.messageRecipientsCacheCapacity=null!==(u=c.messageRecipientsCacheCapacity)&&void 0!==u?u:1e3}));function ee(e){return JSON.parse(JSON.stringify(e))}function te(e){return void 0===e||isNaN(Number(e))?null:Number(e)}function ne(e){try{return new Date(e)}catch(e){return null}}function re(e,t,n){var r={};if(e)try{r=JSON.parse(e)}catch(e){n.warn(t,e)}return r}var ie=function(){function e(t){D.default(this,e),this.base=t.replace(/\/$/,""),this.args=[],this.paths=[]}return L.default(e,[{key:"arg",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"path",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}(),ae=y.custom((function(e){return[["string","number","boolean","object"].includes(B.default(e)),"a JSON type"]})),se=y.custom((function(e){return[["undefined","string","number","boolean","object"].includes(B.default(e)),"an optional JSON type"]})),oe=y.objectSchema("send media options",{contentType:[y.literal(null),"string"],filename:["string","undefined"],media:[y.literal("null"),"string"].concat(z.default("function"==typeof e?[e]:[]),z.default("function"==typeof Blob?[Blob]:[]))});function ue(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}var ce=K.scope("User"),le=function(e){M.default(c,e);var t,n,r,i,a,s,o,u=ue(c);function c(e,t,n,r){var i;return D.default(this,c),i=u.call(this),N.default(O.default(i),"promiseToFetch",null),N.default(O.default(i),"updated","updated"),N.default(O.default(i),"userSubscribed","userSubscribed"),N.default(O.default(i),"userUnsubscribed","userUnsubscribed"),i.services=r,i.subscribed="initializing",i.setMaxListeners(0),i.state={identity:e,entityName:t,friendlyName:null,attributes:{},online:null,notifiable:null},i._initializationPromise=new Promise((function(e){i._resolveInitializationPromise=e})),null!==n&&i._resolveInitialization(n,e,t,!1),i}return L.default(c,[{key:"identity",get:function(){return this.state.identity},set:function(e){this.state.identity=e}},{key:"entityName",set:function(e){this.state.entityName=e}},{key:"attributes",get:function(){return this.state.attributes}},{key:"friendlyName",get:function(){return this.state.friendlyName}},{key:"isOnline",get:function(){return this.state.online}},{key:"isNotifiable",get:function(){return this.state.notifiable}},{key:"isSubscribed",get:function(){return"subscribed"==this.subscribed}},{key:"_update",value:(o=A.default(F.default.mark((function e(t,n){var r,i;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:r=[],ce.debug("User for",this.state.identity,"updated:",t,n),e.t0=t,e.next="friendlyName"===e.t0?7:"attributes"===e.t0?9:"reachability"===e.t0?12:15;break;case 7:return this.state.friendlyName!==n.value&&(r.push("friendlyName"),this.state.friendlyName=n.value),e.abrupt("break",16);case 9:return i=re(n.value,"Retrieved malformed attributes from the server for user: ".concat(this.state.identity),ce),J.default(this.state.attributes,i)||(this.state.attributes=i,r.push("attributes")),e.abrupt("break",16);case 12:return this.state.online!==n.online&&(this.state.online=n.online,r.push("reachabilityOnline")),this.state.notifiable!==n.notifiable&&(this.state.notifiable=n.notifiable,r.push("reachabilityNotifiable")),e.abrupt("break",16);case 15:return e.abrupt("return");case 16:r.length>0&&this.emit("updated",{user:this,updateReasons:r});case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"_updateReachabilityInfo",value:(s=A.default(F.default.mark((function e(t,n){var r=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(this.configuration.reachabilityEnabled){e.next=4;break}return e.abrupt("return",Promise.resolve());case 4:return e.abrupt("return",t.get("reachability").then(n).catch((function(e){ce.warn("Failed to get reachability info for ",r.state.identity,e)})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"_fetch",value:(a=A.default(F.default.mark((function e(){var t=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(this.state.entityName){e.next=4;break}return e.abrupt("return",this);case 4:return this.promiseToFetch=this.services.syncClient.map({id:this.state.entityName,mode:"open_existing",includeItems:!0}).then((function(e){return t.entity=e,e.on("itemUpdated",(function(e){return ce.debug(t.state.entityName+" ("+t.state.identity+") itemUpdated: "+e.item.key),t._update(e.item.key,e.item.data)})),e.on("itemAdded",(function(e){return ce.debug(t.state.entityName+" ("+t.state.identity+") itemAdded: "+e.item.key),t._update(e.item.key,e.item.data)})),Promise.all([e.get("friendlyName").then((function(e){return t._update(e.key,e.data)})),e.get("attributes").then((function(e){return t._update(e.key,e.data)})),t._updateReachabilityInfo(e,(function(e){return t._update(e.key,e.data)}))])})).then((function(){return ce.debug("Fetched for",t.identity),t.subscribed="subscribed",t.emit("userSubscribed",t),t})).catch((function(e){throw t.promiseToFetch=null,e})),e.abrupt("return",this.promiseToFetch);case 6:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"_ensureFetched",value:(i=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:return e.abrupt("return",this.promiseToFetch||this._fetch());case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"updateAttributes",value:(r=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if("unsubscribed"!=this.subscribed){e.next=4;break}throw new Error("Can't modify unsubscribed object");case 4:return e.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(t)});case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"updateFriendlyName",value:(n=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if("unsubscribed"!=this.subscribed){e.next=4;break}throw new Error("Can't modify unsubscribed object");case 4:return e.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{friendly_name:t});case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"unsubscribe",value:(t=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(!this.promiseToFetch){e.next=9;break}return e.next=5,this.promiseToFetch;case 5:this.entity.close(),this.promiseToFetch=null,this.subscribed="unsubscribed",this.emit("userUnsubscribed",this);case 9:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_resolveInitialization",value:function(e,t,n,r){this.configuration=e,this.identity=t,this.entityName=n,this.links={self:"".concat(this.configuration.links.users,"/").concat(encodeURIComponent(this.identity))},this._resolveInitializationPromise(),r&&this.emit("updated",{user:this,updateReasons:["friendlyName","attributes","reachabilityOnline","reachabilityNotifiable"]})}}]),c}(g.ReplayEventEmitter);function de(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return fe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return fe(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function fe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}H([y.validateTypesAsync(ae),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Promise)],le.prototype,"updateAttributes",null),H([y.validateTypesAsync(["string"]),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],le.prototype,"updateFriendlyName",null);var pe=function(){function e(t,n){D.default(this,e),this.configuration=t,this.services=n,this.cache=new Map,this.cacheLifetime=100*this.configuration.httpCacheInterval,this.cleanupCache()}var t;return L.default(e,[{key:"isExpired",value:function(e){return!this.cacheLifetime||Date.now()-e>this.cacheLifetime}},{key:"cleanupCache",value:function(){var e,t=de(this.cache);try{for(t.s();!(e=t.n()).done;){var n=W.default(e.value,2),r=n[0],i=n[1];this.isExpired(i.timestamp)&&this.cache.delete(r)}}catch(e){t.e(e)}finally{t.f()}0===this.cache.size&&clearInterval(this.timer)}},{key:"pokeTimer",value:function(){var e=this;this.timer=this.timer||setInterval((function(){return e.cleanupCache()}),2*this.cacheLifetime)}},{key:"executeWithRetry",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var s=new w.Retrier(t.configuration.backoffConfiguration);s.on("attempt",(function(){e().then((function(e){return s.succeeded(e)})).catch((function(e){a.indexOf(e.status)>-1||"Twilsock disconnected"===e.message?s.failed(e):(s.removeAllListeners(),s.cancel(),i(e))}))})),s.on("succeeded",(function(e){r(e)})),s.on("cancelled",(function(e){return i(e)})),s.on("failed",(function(e){return i(e)})),s.start()}))}},{key:"get",value:(t=A.default(F.default.mark((function e(t){var n,r,i,a=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.cache.get(t))||this.isExpired(n.timestamp)){e.next=3;break}return e.abrupt("return",n.response);case 3:return r={},e.next=6,this.executeWithRetry((function(){return a.services.transport.get(t,r,a.configuration.productId)}),this.configuration.retryWhenThrottled);case 6:return i=e.sent,this.cache.set(t,{response:i,timestamp:Date.now()}),this.pokeTimer(),e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),he=L.default((function e(){D.default(this,e)}));function ve(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}N.default(he,"TYPING_INDICATOR","twilio.ipmsg.typing_indicator"),N.default(he,"NEW_MESSAGE","twilio.conversations.new_message"),N.default(he,"ADDED_TO_CONVERSATION","twilio.conversations.added_to_conversation"),N.default(he,"REMOVED_FROM_CONVERSATION","twilio.conversations.removed_from_conversation"),N.default(he,"CONSUMPTION_UPDATE","twilio.channel.consumption_update");var ye=K.scope("Participant"),me=function(e){M.default(a,e);var t,n,r,i=ve(a);function a(e,t,n,r,s){var o,u,c;if(D.default(this,a),(c=i.call(this)).conversation=n,c.links=r,c.services=s,c.state={attributes:re(e.attributes,"Retrieved malformed attributes from the server for participant: "+t,ye),dateCreated:e.dateCreated?ne(e.dateCreated):null,dateUpdated:e.dateCreated?ne(e.dateUpdated):null,sid:t,typingTimeout:null,isTyping:!1,identity:e.identity,roleSid:null!==(o=e.roleSid)&&void 0!==o?o:"",lastReadMessageIndex:Number.isInteger(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,lastReadTimestamp:e.lastConsumptionTimestamp?ne(e.lastConsumptionTimestamp):null,type:e.type||"chat",userInfo:e.userInfo,bindings:null!==(u=e.bindings)&&void 0!==u?u:{}},!e.identity&&!e.type)throw new Error("Received invalid Participant object from server: Missing identity or type of Participant.");return c}return L.default(a,[{key:"sid",get:function(){return this.state.sid}},{key:"attributes",get:function(){return this.state.attributes}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"identity",get:function(){return this.state.identity}},{key:"isTyping",get:function(){return this.state.isTyping}},{key:"lastReadMessageIndex",get:function(){return this.state.lastReadMessageIndex}},{key:"lastReadTimestamp",get:function(){return this.state.lastReadTimestamp}},{key:"roleSid",get:function(){return this.state.roleSid}},{key:"type",get:function(){return this.state.type}},{key:"bindings",get:function(){var e;return null!==(e=this.state.bindings)&&void 0!==e?e:{}}},{key:"_startTyping",value:function(e){var t=this;return this.state.typingTimeout&&clearTimeout(this.state.typingTimeout),this.state.isTyping=!0,this.emit(a.typingStarted,this),this.conversation.emit(et.typingStarted,this),this.state.typingTimeout=Number(setTimeout((function(){return t._endTyping()}),e)),this}},{key:"_endTyping",value:function(){this.state.typingTimeout&&(this.state.isTyping=!1,this.emit(a.typingEnded,this),this.conversation.emit(et.typingEnded,this),clearInterval(this.state.typingTimeout),this.state.typingTimeout=null)}},{key:"_update",value:function(e){var t=[],n=re(e.attributes,"Retrieved malformed attributes from the server for participant: "+this.state.sid,ye);e.attributes&&!J.default(this.state.attributes,n)&&(this.state.attributes=n,t.push("attributes"));var r=ne(e.dateUpdated);e.dateUpdated&&(null==r?void 0:r.getTime())!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=r,t.push("dateUpdated"));var i=ne(e.dateCreated);if(e.dateCreated&&(null==i?void 0:i.getTime())!==(this.state.dateCreated&&this.state.dateCreated.getTime())&&(this.state.dateCreated=i,t.push("dateCreated")),e.roleSid&&this.state.roleSid!==e.roleSid&&(this.state.roleSid=e.roleSid,t.push("roleSid")),!Number.isInteger(e.lastConsumedMessageIndex)&&null!==e.lastConsumedMessageIndex||this.state.lastReadMessageIndex===e.lastConsumedMessageIndex||(this.state.lastReadMessageIndex=e.lastConsumedMessageIndex,t.push("lastReadMessageIndex")),e.lastConsumptionTimestamp){var s=new Date(e.lastConsumptionTimestamp);this.state.lastReadTimestamp&&this.state.lastReadTimestamp.getTime()===s.getTime()||(this.state.lastReadTimestamp=s,t.push("lastReadTimestamp"))}return e.bindings&&!J.default(this.state.bindings,e.bindings)&&(this.state.bindings=e.bindings,t.push("bindings")),t.length>0&&this.emit(a.updated,{participant:this,updateReasons:t}),this}},{key:"getUser",value:(r=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("chat"==this.type){e.next=2;break}throw new Error("Getting User is not supported for this Participant type: "+this.type);case 2:return e.abrupt("return",this.services.users.getUser(this.state.identity,this.state.userInfo));case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"remove",value:(n=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.conversation.removeParticipant(this));case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"updateAttributes",value:(t=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(t)});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),a}(g.ReplayEventEmitter);function ge(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}N.default(me,"typingStarted","typingStarted"),N.default(me,"typingEnded","typingEnded"),N.default(me,"updated","updated"),H([y.validateTypesAsync(ae),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Promise)],me.prototype,"updateAttributes",null);var be=K.scope("Participants"),ke=function(e){M.default(l,e);var t,n,r,i,a,s,o,u,c=ge(l);function l(e,t,n,r){var i;return D.default(this,l),i=c.call(this),N.default(O.default(i),"rosterEntityPromise",null),i.conversation=e,i.participants=t,i.links=n,i.services=r,i}return L.default(l,[{key:"unsubscribe",value:(u=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.rosterEntityPromise){e.next=6;break}return e.next=3,this.rosterEntityPromise;case 3:e.sent.close(),this.rosterEntityPromise=null;case 6:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"subscribe",value:function(e){var t=this,n="string"==typeof e?this.services.syncClient.map({id:e,mode:"open_existing"}):Promise.resolve(e);return this.rosterEntityPromise=this.rosterEntityPromise||n.then((function(e){e.on(S.SyncMap.itemAdded,(function(e){be.debug(t.conversation.sid+" itemAdded: "+e.item.key),t.upsertParticipant(e.item.key,e.item.data).then((function(e){t.emit(et.participantJoined,e)}))})),e.on(S.SyncMap.itemRemoved,(function(e){be.debug(t.conversation.sid+" itemRemoved: "+e.key);var n=e.key;if(t.participants.has(n)){var r=t.participants.get(n);t.participants.delete(n),r&&t.emit(et.participantLeft,r)}})),e.on(S.SyncMap.itemUpdated,(function(e){be.debug(t.conversation.sid+" itemUpdated: "+e.item.key),t.upsertParticipant(e.item.key,e.item.data).catch((function(e){return be.error(e)}))}));var n=[];return e.getItems().then((function e(r){return r.items.forEach((function(e){n.push(t.upsertParticipant(e.key,e.data))})),r.hasNextPage?r.nextPage().then(e):null})).then((function(){return Promise.all(n)})).then((function(){return e}))})).catch((function(e){throw t.rosterEntityPromise=null,"disconnected"!=t.services.syncClient.connectionState&&be.error("Failed to get roster object for conversation",t.conversation.sid,e),be.debug("ERROR: Failed to get roster object for conversation",t.conversation.sid,e),e}))}},{key:"upsertParticipantFromResponse",value:(o=A.default(F.default.mark((function e(t){var n,r,i,a,s,o,u,c;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.sid,i=t.attributes,a=t.date_created,s=t.date_updated,o=t.identity,u=t.role_sid,c=t.messaging_binding,e.next=3,this.upsertParticipant(r,{attributes:i,dateCreated:new Date(a),dateUpdated:new Date(s),identity:o,roleSid:u,lastConsumedMessageIndex:null,lastConsumptionTimestamp:null,type:null!==(n=null==c?void 0:c.type)&&void 0!==n?n:"chat"});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"upsertParticipant",value:(s=A.default(F.default.mark((function e(t,n){var r,i,a=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.participants.get(t))){e.next=3;break}return e.abrupt("return",r._update(n));case 3:return i={self:"".concat(this.links.participants,"/").concat(t)},r=new me(n,t,this.conversation,i,this.services),this.participants.set(t,r),r.on(me.updated,(function(e){return a.emit(et.participantUpdated,e)})),e.abrupt("return",r);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"getParticipants",value:(a=A.default(F.default.mark((function e(){var t=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then((function(){var e=[];return t.participants.forEach((function(t){return e.push(t)})),e})):[]);case 1:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getParticipantBySid",value:(i=A.default(F.default.mark((function e(t){var n=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then((function(){var e=n.participants.get(t);if(!e)throw new Error("Participant with SID "+t+" was not found");return e})):null);case 1:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(r=A.default(F.default.mark((function e(t){var n,r=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then((function(){if(r.participants.forEach((function(e){e.identity===t&&(n=e)})),!n)throw new Error("Participant with identity "+t+" was not found");return n})):null);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"add",value:(n=A.default(F.default.mark((function e(t,n){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.participants,{identity:t,attributes:void 0!==n?JSON.stringify(n):void 0});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"addNonChatParticipant",value:(t=A.default(F.default.mark((function e(t,n){var r,i,a,s,o=arguments;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=o.length>2&&void 0!==o[2]?o[2]:{},s=o.length>3&&void 0!==o[3]?o[3]:{},e.next=4,this.services.commandExecutor.mutateResource("post",this.links.participants,{attributes:void 0!==a?JSON.stringify(a):void 0,messaging_binding:{address:n,proxy_address:t,name:null==s||null===(r=s.email)||void 0===r?void 0:r.name,level:null==s||null===(i=s.email)||void 0===i?void 0:i.level}});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"remove",value:function(e){return this.services.commandExecutor.mutateResource("delete","".concat(this.links.participants,"/").concat(encodeURIComponent(e)))}}]),l}(g.ReplayEventEmitter),we=function(){function e(t,n){var r;D.default(this,e),N.default(this,"mcsMedia",null),this.services=n,t instanceof C.McsMedia&&(this.mcsMedia=t),this.state={sid:t.sid,category:t.category,filename:null!==(r=t.filename)&&void 0!==r?r:null,contentType:t.contentType,size:t.size}}return L.default(e,[{key:"sid",get:function(){return this.state.sid}},{key:"filename",get:function(){return this.state.filename}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"category",get:function(){return this.state.category}},{key:"getContentTemporaryUrl",value:function(){var e=this;return new C.CancellablePromise(function(){var t=A.default(F.default.mark((function t(n,r,i){var a,s,o,u;return F.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s=e.mcsMedia?void 0:e._fetchMcsMedia(),o=null===(a=e.mcsMedia)||void 0===a?void 0:a.getContentUrl(),i((function(){s&&s.cancel(),o&&o.cancel()})),t.prev=3,o){t.next=9;break}return t.next=7,s;case 7:u=t.sent,o=null==u?void 0:u.getContentUrl();case 9:if(t.t0=n,!o){t.next=16;break}return t.next=13,o;case 13:t.t1=t.sent,t.next=17;break;case 16:t.t1=null;case 17:t.t2=t.t1,(0,t.t0)(t.t2),t.next=24;break;case 21:t.prev=21,t.t3=t.catch(3),r(t.t3);case 24:case"end":return t.stop()}}),t,null,[[3,21]])})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"_fetchMcsMedia",value:function(){var e=this;return new C.CancellablePromise(function(){var t=A.default(F.default.mark((function t(n,r,i){var a;return F.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return null===e.services.mcsClient&&r(new Error("Media Content Service is unavailable")),a=e.services.mcsClient.get(e.state.sid),i((function(){return a.cancel()})),t.prev=3,t.next=6,a;case 6:e.mcsMedia=t.sent,e.state=e.mcsMedia._state(),n(e.mcsMedia),t.next=14;break;case 11:t.prev=11,t.t0=t.catch(3),r(t.t0);case 14:case"end":return t.stop()}}),t,null,[[3,11]])})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"_state",value:function(){return this.state}}]),e}(),_e=function(){function e(t){D.default(this,e),this.state=t}return L.default(e,[{key:"total",get:function(){return this.state.total}},{key:"sent",get:function(){return this.state.sent}},{key:"delivered",get:function(){return this.state.delivered}},{key:"read",get:function(){return this.state.read}},{key:"undelivered",get:function(){return this.state.undelivered}},{key:"failed",get:function(){return this.state.failed}},{key:"_update",value:function(e){this.state=e}},{key:"_isEquals",value:function(e){var t=this.total===e.total,n=this.sent===e.sent,r=this.delivered===e.delivered,i=this.read===e.read,a=this.undelivered===e.undelivered,s=this.failed===e.failed;return t&&n&&r&&i&&a&&s}}]),e}(),xe=function(){function e(t,n,r,i){D.default(this,e),this.state={prevToken:r,nextToken:i,source:n,items:t}}return L.default(e,[{key:"hasNextPage",get:function(){return!!this.state.nextToken}},{key:"hasPrevPage",get:function(){return!!this.state.prevToken}},{key:"items",get:function(){return this.state.items}},{key:"nextPage",value:function(){return this.hasNextPage?this.state.source(this.state.nextToken):Promise.reject(new Error("No next page"))}},{key:"prevPage",value:function(){return this.hasPrevPage?this.state.source(this.state.prevToken):Promise.reject(new Error("No previous page"))}}]),e}(),Se=L.default((function e(t){D.default(this,e),this.sid=t.sid,this.messageSid=t.message_sid,this.conversationSid=t.conversation_sid,this.channelMessageSid=t.channel_message_sid,this.participantSid=t.participant_sid,this.status=t.status||"queued",this.errorCode=t.error_code||0,this.dateCreated=t.date_created,this.dateUpdated=t.date_updated})),Ce=function(e){return e.map((function(e){var t,n,r,i,a=JSON.stringify(e);switch(e.type){case"QUICK_REPLY":return{type:"reply",title:e.title,id:null!==(t=e.id)&&void 0!==t?t:"",index:null!==(n=e.index)&&void 0!==n?n:0,rawData:a};case"PHONE_NUMBER":return{type:"phone",title:e.title,phone:null!==(r=e.phone)&&void 0!==r?r:"",rawData:a};case"URL":return{type:"url",title:e.title,url:null!==(i=e.url)&&void 0!==i?i:"",rawData:a};default:return{type:"other",rawData:a}}}))},Ee=function(e,t){var n=JSON.stringify(t);switch(e){case"twilio/text":return{type:"text",body:t.body,rawData:n};case"twilio/media":var r=t;return{type:"media",body:r.body,media:r.media,rawData:n};case"twilio/location":var i=t;return{type:"location",longitude:i.longitude,latitude:i.latitude,label:i.label,rawData:n};case"twilio/quick-reply":var a=t;return{type:"quickReply",body:a.body,replies:a.actions,rawData:n};case"twilio/call-to-action":var s=t;return{type:"callToAction",body:s.body,actions:Ce(s.actions),rawData:n};case"twilio/list-picker":var o=t;return{type:"listPicker",body:o.body,button:o.button,items:o.items,rawData:n};case"twilio/card":var u,c,l=t;return{type:"card",title:l.title,subtitle:l.subtitle,media:null!==(u=l.media)&&void 0!==u?u:[],actions:Ce(null!==(c=l.actions)&&void 0!==c?c:[]),rawData:n};default:return{type:"other",rawData:n}}},Re=function(){function e(t,n){D.default(this,e),this.name=t,this.value=n}return L.default(e,[{key:"copyWithValue",value:function(t){return new e(this.name,t)}}]),e}(),Ie=L.default((function e(t){D.default(this,e),this.sid=t.sid,this.friendlyName=t.friendly_name,this.variables=Object.entries(JSON.parse(t.variables)).map((function(e){var t=W.default(e,2),n=t[0],r=t[1];return new Re(n,r)})),this.variants=function(e){for(var t=new Map,n=0,r=Object.entries(e);n<r.length;n++){var i=W.default(r[n],2),a=i[0],s=i[1];t.set(a,Ee(a,s))}return t}(t.variants),this.dateCreated=new Date(t.date_created),this.dateUpdated=new Date(t.date_updated)}));function Te(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Pe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Te(Object(n),!0).forEach((function(t){N.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Te(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}function Oe(e,t){!function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}(e,t),t.add(e)}function Me(e,t,n){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return n}var Ue=K.scope("Message"),je=r.XMLHttpRequest||{},Ne=new WeakSet,Le=new WeakSet,De=function(e){M.default(d,e);var t,n,r,i,a,s,o,u,c,l=Ae(d);function d(e,t,n,r,i,a){var s,o,u,c,f,p,h,v;return D.default(this,d),v=l.call(this),Oe(O.default(v),Le),Oe(O.default(v),Ne),v.conversation=n,v.links=r,v.configuration=i,v.services=a,v.state={sid:t.sid,index:e,author:t.author,subject:t.subject,contentSid:t.contentSid,body:null!==(s=t.text)&&void 0!==s?s:null,timestamp:t.timestamp?new Date(t.timestamp):null,dateUpdated:t.dateUpdated?new Date(t.dateUpdated):null,lastUpdatedBy:null!==(o=t.lastUpdatedBy)&&void 0!==o?o:null,attributes:re(t.attributes,"Got malformed attributes for the message ".concat(t.sid),Ue),type:null!==(u=t.type)&&void 0!==u?u:"text",media:null,medias:null,participantSid:null!==(c=t.memberSid)&&void 0!==c?c:null,aggregatedDeliveryReceipt:t.delivery?new _e(t.delivery):null,hasChannelMetadata:null!==(f=t.channelMetadata)&&void 0!==f&&f},Me(O.default(v),Le,Be).call(O.default(v),null!==(p=t.medias)&&void 0!==p?p:null,null!==(h=t.media)&&void 0!==h?h:null),v}return L.default(d,[{key:"sid",get:function(){return this.state.sid}},{key:"author",get:function(){return this.state.author}},{key:"subject",get:function(){return this.state.subject}},{key:"contentSid",get:function(){return this.state.contentSid}},{key:"body",get:function(){return this.state.body}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"index",get:function(){return this.state.index}},{key:"lastUpdatedBy",get:function(){return this.state.lastUpdatedBy}},{key:"dateCreated",get:function(){return this.state.timestamp}},{key:"attributes",get:function(){return this.state.attributes}},{key:"type",get:function(){return this.state.type}},{key:"media",get:function(){return this.state.media}},{key:"attachedMedia",get:function(){return this.getMediaByCategories(["media"])}},{key:"participantSid",get:function(){return this.state.participantSid}},{key:"aggregatedDeliveryReceipt",get:function(){return this.state.aggregatedDeliveryReceipt}},{key:"getMediaByCategory",value:function(e){return this.getMediaByCategories(e)}},{key:"getMediaByCategories",value:function(e){var t;return(null!==(t=this.state.medias)&&void 0!==t?t:[]).filter((function(t){return e.includes(t.category)}))}},{key:"getEmailBody",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"text/plain";return null!==(e=null===(t=this.getMediaByCategories(["body"]))||void 0===t?void 0:t.filter((function(e){return e.contentType==n})).shift())&&void 0!==e?e:null}},{key:"getEmailHistory",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"text/plain";return null!==(e=null===(t=this.getMediaByCategories(["history"]))||void 0===t?void 0:t.filter((function(e){return e.contentType==n})).shift())&&void 0!==e?e:null}},{key:"_update",value:function(e){var t,n,r,i,a=this,s=[];!e.text&&"string"!=typeof e.text||e.text===this.state.body||(this.state.body=e.text,s.push("body")),e.subject&&e.subject!==this.state.subject&&(this.state.subject=e.subject,s.push("subject")),e.lastUpdatedBy&&e.lastUpdatedBy!==this.state.lastUpdatedBy&&(this.state.lastUpdatedBy=e.lastUpdatedBy,s.push("lastUpdatedBy")),e.author&&e.author!==this.state.author&&(this.state.author=e.author,s.push("author")),e.dateUpdated&&new Date(e.dateUpdated).getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=new Date(e.dateUpdated),s.push("dateUpdated")),e.timestamp&&new Date(e.timestamp).getTime()!==(this.state.timestamp&&this.state.timestamp.getTime())&&(this.state.timestamp=new Date(e.timestamp),s.push("dateCreated"));var o=re(e.attributes,"Got malformed attributes for the message ".concat(this.sid),Ue);J.default(this.state.attributes,o)||(this.state.attributes=o,s.push("attributes"));var u=e.delivery,c=this.state.aggregatedDeliveryReceipt;!!(u&&u.total&&u.delivered&&u.failed&&u.read&&u.sent&&u.undelivered)&&(c?c._isEquals(u)||(c._update(u),s.push("deliveryReceipt")):(this.state.aggregatedDeliveryReceipt=new _e(u),s.push("deliveryReceipt")));var l,d,f=(null!==(t=e.medias)&&void 0!==t?t:[]).map((function(e){var t;return null===(t=Me(a,Ne,Fe).call(a,e))||void 0===t?void 0:t._state()})).filter((function(e){return!(null===e)})),p=(null!==(n=this.state.medias)&&void 0!==n?n:[]).map((function(e){return e._state()})).filter((function(e){return!(null===e)}));J.default(f,p)&&J.default(null===(r=Me(this,Ne,Fe).call(this,e.media))||void 0===r?void 0:r._state(),null===(i=this.state.media)||void 0===i?void 0:i._state())||(Me(this,Le,Be).call(this,null!==(l=e.medias)&&void 0!==l?l:null,null!==(d=e.media)&&void 0!==d?d:null),s.push("media"));s.length>0&&this.emit("updated",{message:this,updateReasons:s})}},{key:"getParticipant",value:(c=A.default(F.default.mark((function e(){var t,n,r=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=null,!this.state.participantSid){e.next=5;break}return e.next=4,this.conversation.getParticipantBySid(this.state.participantSid).catch((function(){return Ue.debug('Participant with sid "'.concat(r.participantSid,'" not found for message ').concat(r.sid)),null}));case 4:t=e.sent;case 5:if(t||!this.state.author){e.next=9;break}return e.next=8,this.conversation.getParticipantByIdentity(this.state.author).catch((function(){return Ue.debug('Participant with identity "'.concat(r.author,'" not found for message ').concat(r.sid)),null}));case 8:t=e.sent;case 9:if(!t){e.next=11;break}return e.abrupt("return",t);case 11:throw n="Participant with ",this.state.participantSid&&(n+="SID '"+this.state.participantSid+"' "),this.state.author&&(this.state.participantSid&&(n+="or "),n+="identity '"+this.state.author+"' "),"Participant with "===n&&(n="Participant "),n+="was not found",new Error(n);case 17:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"getDetailedDeliveryReceipts",value:(u=A.default(F.default.mark((function e(){var t,n;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getDetailedDeliveryReceiptsPaginator();case 2:t=e.sent,n=t.items;case 4:if(!t.hasNextPage){e.next=11;break}return e.next=7,t.nextPage();case 7:t=e.sent,n=[].concat(z.default(n),z.default(t.items)),e.next=4;break;case 11:return e.abrupt("return",n);case 12:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"remove",value:(o=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("delete",this.links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"updateBody",value:(s=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{body:t});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"updateAttributes",value:(a=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:void 0!==t?JSON.stringify(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"attachTemporaryUrlsFor",value:(i=A.default(F.default.mark((function e(t){var n,r=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=null==t?void 0:t.map((function(e){return e.sid})),!this.services.mcsClient||!n){e.next=7;break}return e.next=4,this.services.mcsClient.mediaSetGet(n);case 4:return e.abrupt("return",e.sent.map((function(e){return new we(e,r.services)})));case 7:throw new Error("Media Content Service is unavailable");case 8:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"getTemporaryContentUrlsForMedia",value:function(e){var t=e.map((function(e){return e.sid}));return this.getTemporaryContentUrlsForMediaSids(t)}},{key:"getTemporaryContentUrlsForMediaSids",value:function(e){var t=this;return new C.CancellablePromise(function(){var n=A.default(F.default.mark((function n(r,i,a){var s,o;return F.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(s=t.services.mcsClient.mediaSetGetContentUrls(null!=e?e:[]),t.services.mcsClient&&e){n.next=4;break}return i(new Error("Media Content Service is unavailable")),n.abrupt("return");case 4:return a((function(){s.cancel()})),n.prev=5,n.next=8,s;case 8:o=n.sent,r(o),n.next=15;break;case 12:n.prev=12,n.t0=n.catch(5),i(n.t0);case 15:case"end":return n.stop()}}),n,null,[[5,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"getTemporaryContentUrlsForAttachedMedia",value:function(){var e,t=this.attachedMedia,n=null!==(e=null==t?void 0:t.map((function(e){return e.sid})))&&void 0!==e?e:[];return this.getTemporaryContentUrlsForMediaSids(n)}},{key:"_getDetailedDeliveryReceiptsPaginator",value:(r=A.default(F.default.mark((function e(t){var n,r,i,a=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.configuration.links.messagesReceipts.replace("%s",this.conversation.sid).replace("%s",this.sid),r=new ie(n).arg("PageToken",null==t?void 0:t.pageToken).arg("PageSize",null==t?void 0:t.pageSize).build(),e.next=4,this.services.network.get(r);case 4:return i=e.sent,e.abrupt("return",new xe(i.body.delivery_receipts.map((function(e){return new Se(e)})),(function(e,t){return a._getDetailedDeliveryReceiptsPaginator({pageToken:e,pageSize:t})}),i.body.meta.previous_token,i.body.meta.next_token));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getContentData",value:function(){var e=this;return new C.CancellablePromise(function(){var t=A.default(F.default.mark((function t(n,r,i){var a,s,o,u,c,l,d,f,p,h;return F.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!==e.state.contentSid){t.next=3;break}return n(null),t.abrupt("return");case 3:if(null!==(a=e.getMediaByCategories(["body"]))){t.next=7;break}return n(null),t.abrupt("return");case 7:if(s="application/x-vnd.com.twilio.rich.",0!==(o=a.filter((function(e){return e.contentType.startsWith(s)}))).length){t.next=12;break}return n(null),t.abrupt("return");case 12:return u=o[0],c=u.getContentTemporaryUrl(),i((function(){c.cancel()})),t.prev=15,t.next=18,c;case 18:l=t.sent,t.next=25;break;case 21:return t.prev=21,t.t0=t.catch(15),r(t.t0),t.abrupt("return");case 25:if(null!==l){t.next=28;break}return n(null),t.abrupt("return");case 28:return d=new Promise((function(e,t){var n,r=!1,a=new je;a.open("GET",null!==(n=l)&&void 0!==n?n:"",!0),a.responseType="text",a.onreadystatechange=function(){4!==a.readyState||r||e(a.responseText)},a.onerror=function(){t(a.statusText)},i((function(){r=!0,a.abort(),t(new Error("XHR has been aborted"))})),a.send()})),t.prev=29,t.next=32,d;case 32:p=t.sent,f=JSON.parse(p),t.next=40;break;case 36:return t.prev=36,t.t1=t.catch(29),r(t.t1),t.abrupt("return");case 40:h=u.contentType.replace(s,"").replace(".","/"),n(Ee(h,f.data));case 42:case"end":return t.stop()}}),t,null,[[15,21],[29,36]])})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"getChannelMetadata",value:(n=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state.hasChannelMetadata){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this.services.channelMetadataClient.getChannelMetadata(this.conversation.sid,this.sid);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getMessageRecipients",value:(t=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.messageRecipientsClient.getRecipientsFromMessage(this.conversation.sid,this.sid);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),d}(g.ReplayEventEmitter);function Fe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e?new we(t?Pe(Pe({},e),{},{category:t}):e,this.services):null}function Be(e,t){var n=this;this.state.media=Me(this,Ne,Fe).call(this,t),this.state.medias=e?e.map((function(e){return Me(n,Ne,Fe).call(n,e)})).filter((function(e){return null!==e})):t&&!e?[Me(this,Ne,Fe).call(this,t,"media")].filter((function(e){return null!==e})):null}function qe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ze(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qe(Object(n),!0).forEach((function(t){N.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Je(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return We(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return We(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function We(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ye(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}N.default(De,"updated","updated"),H([E.deprecated("getMediaByCategory","getMediaByCategories"),Q("design:type",Function),Q("design:paramtypes",[Array]),Q("design:returntype",Array)],De.prototype,"getMediaByCategory",null),H([y.validateTypes([y.nonEmptyString,"undefined"]),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",we)],De.prototype,"getEmailBody",null),H([y.validateTypes([y.nonEmptyString,"undefined"]),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",we)],De.prototype,"getEmailHistory",null),H([y.validateTypesAsync("string"),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],De.prototype,"updateBody",null),H([y.validateTypesAsync(ae),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Promise)],De.prototype,"updateAttributes",null),H([E.deprecated("attachTemporaryUrlsFor","getTemporaryContentUrlsForMedia"),Q("design:type",Function),Q("design:paramtypes",[Array]),Q("design:returntype",Promise)],De.prototype,"attachTemporaryUrlsFor",null),H([y.validateTypesAsync(y.nonEmptyArray("media",we)),Q("design:type",Function),Q("design:paramtypes",[Array]),Q("design:returntype",C.CancellablePromise)],De.prototype,"getTemporaryContentUrlsForMedia",null),H([y.validateTypesAsync(y.nonEmptyArray("strings","string")),Q("design:type",Function),Q("design:paramtypes",[Array]),Q("design:returntype",C.CancellablePromise)],De.prototype,"getTemporaryContentUrlsForMediaSids",null);var He=K.scope("Messages"),Qe=function(e){M.default(u,e);var t,n,r,i,a,s,o=Ye(u);function u(e,t,n){var r;return D.default(this,u),(r=o.call(this)).conversation=e,r.configuration=t,r.services=n,r.messagesByIndex=new Map,r.messagesListPromise=null,r}return L.default(u,[{key:"subscribe",value:(s=A.default(F.default.mark((function e(t){var n,r=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.messagesListPromise){e.next=2;break}return e.abrupt("return",this.messagesListPromise);case 2:return this.messagesListPromise="string"==typeof t?this.services.syncClient.list({id:t,mode:"open_existing"}):Promise.resolve(t),e.prev=3,e.next=6,this.messagesListPromise;case 6:return(n=e.sent).on("itemAdded",(function(e){He.debug("".concat(r.conversation.sid," itemAdded: ").concat(e.item.index));var t={self:"".concat(r.conversation._links.messages,"/").concat(e.item.data.sid),conversation:r.conversation._links.self,messages_receipts:"".concat(r.conversation._links.messages,"/").concat(e.item.data.sid,"/Receipts")},n=new De(e.item.index,e.item.data,r.conversation,t,r.configuration,r.services);r.messagesByIndex.has(n.index)?He.debug("Message arrived, but is already known and ignored",r.conversation.sid,n.index):(r.messagesByIndex.set(n.index,n),n.on("updated",(function(e){return r.emit("messageUpdated",e)})),r.emit("messageAdded",n))})),n.on("itemRemoved",(function(e){He.debug("#{this.conversation.sid} itemRemoved: ".concat(e.index));var t=e.index;if(r.messagesByIndex.has(t)){var n=r.messagesByIndex.get(t);if(!n)return;r.messagesByIndex.delete(n.index),n.removeAllListeners("updated"),r.emit("messageRemoved",n)}})),n.on("itemUpdated",(function(e){He.debug("".concat(r.conversation.sid," itemUpdated: ").concat(e.item.index));var t=r.messagesByIndex.get(e.item.index);t&&t._update(e.item.data)})),e.abrupt("return",n);case 13:throw e.prev=13,e.t0=e.catch(3),this.messagesListPromise=null,"disconnected"!==this.services.syncClient.connectionState&&He.error("Failed to get messages object for conversation",this.conversation.sid,e.t0),He.debug("ERROR: Failed to get messages object for conversation",this.conversation.sid,e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[3,13]])}))),function(e){return s.apply(this,arguments)})},{key:"unsubscribe",value:(a=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.messagesListPromise){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.messagesListPromise;case 4:e.sent.close(),this.messagesListPromise=null;case 7:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"sendV2",value:function(e){var t=this;return He.debug("Sending message V2",e.mediaContent,e.attributes,e.emailOptions),new C.CancellablePromise(function(){var n=A.default(F.default.mark((function n(r,i,a){var s,o,u,c,l,d,f,p,h,v,y,m;return F.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o=[],u=[],a((function(){u.forEach((function(e){return e.cancel()}))})),c=Je(e.mediaContent),n.prev=4,c.s();case 6:if((l=c.n()).done){n.next=25;break}return d=W.default(l.value,2),f=d[0],p=d[1],n.prev=8,He.debug("Adding media to a message as ".concat(p instanceof FormData?"FormData":"SendMediaOptions"),p),y=p instanceof FormData?t.services.mcsClient.postFormData(p,f):t.services.mcsClient.post(null!==(h=p.contentType)&&void 0!==h?h:"",null!==(v=p.media)&&void 0!==v?v:"",f,p.filename),u.push(y),n.t0=o,n.next=15,y;case 15:n.t1=n.sent,n.t0.push.call(n.t0,n.t1),n.next=23;break;case 19:return n.prev=19,n.t2=n.catch(8),i(n.t2),n.abrupt("return");case 23:n.next=6;break;case 25:n.next=30;break;case 27:n.prev=27,n.t3=n.catch(4),c.e(n.t3);case 30:return n.prev=30,c.f(),n.finish(30);case 33:return m=t.services.commandExecutor.mutateResource("post",t.conversation._links.messages,{body:e.text,subject:null===(s=e.emailOptions)||void 0===s?void 0:s.subject,media_sids:o.map((function(e){return e.sid})),attributes:void 0!==e.attributes?JSON.stringify(e.attributes):void 0,content_sid:e.contentSid,content_variables:void 0!==e.contentVariables?JSON.stringify(e.contentVariables.reduce((function(e,t){return ze(ze({},e),{},N.default({},t.name,t.value))}),{})):void 0}),n.prev=34,n.t4=r,n.next=38,m;case 38:n.t5=n.sent,(0,n.t4)(n.t5),n.next=45;break;case 42:n.prev=42,n.t6=n.catch(34),i(n.t6);case 45:case"end":return n.stop()}}),n,null,[[4,27,30,33],[8,19],[34,42]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"send",value:(i=A.default(F.default.mark((function e(t){var n,r,i=arguments;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},r=i.length>2?i[2]:void 0,He.debug("Sending text message",t,n,r),e.abrupt("return",this.services.commandExecutor.mutateResource("post",this.conversation._links.messages,{body:null!=t?t:"",attributes:void 0!==n?JSON.stringify(n):void 0,subject:null==r?void 0:r.subject}));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"sendMedia",value:(r=A.default(F.default.mark((function e(t){var n,r,i,a,s,o=arguments;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=o.length>1&&void 0!==o[1]?o[1]:{},a=o.length>2?o[2]:void 0,He.debug("Sending media message",t,i,a),He.debug("Sending media message as ".concat(t instanceof FormData?"FormData":"SendMediaOptions"),t,i),!(t instanceof FormData)){e.next=10;break}return e.next=7,this.services.mcsClient.postFormData(t);case 7:e.t0=e.sent,e.next=13;break;case 10:return e.next=12,this.services.mcsClient.post(null!==(n=t.contentType)&&void 0!==n?n:"",null!==(r=t.media)&&void 0!==r?r:"","media",t.filename);case 12:e.t0=e.sent;case 13:return s=e.t0,e.next=16,this.services.commandExecutor.mutateResource("post",this.conversation._links.messages,{media_sids:[s.sid],attributes:void 0!==i?JSON.stringify(i):void 0});case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getMessages",value:(n=A.default(F.default.mark((function e(t,n){var r,i=arguments;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>2&&void 0!==i[2]?i[2]:"backwards",e.abrupt("return",this._getMessages(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"_wrapPaginator",value:function(e,t,n){var r=this,i="desc"===e,a=function(){return t.nextPage().then((function(t){return r._wrapPaginator(e,t,n)}))},s=function(){return t.prevPage().then((function(t){return r._wrapPaginator(e,t,n)}))};return n(t.items).then((function(e){return{items:e.sort((function(e,t){return e.index-t.index})),hasPrevPage:i?t.hasNextPage:t.hasPrevPage,hasNextPage:i?t.hasPrevPage:t.hasNextPage,prevPage:i?a:s,nextPage:i?s:a}}))}},{key:"_upsertMessage",value:function(e,t){var n=this,r=this.messagesByIndex.get(e);if(r)return r;var i={self:"".concat(this.conversation._links.messages,"/").concat(t.sid),conversation:this.conversation._links.self,messages_receipts:"".concat(this.conversation._links.messages,"/").concat(t.sid,"/Receipts")},a=new De(e,t,this.conversation,i,this.configuration,this.services);return this.messagesByIndex.set(a.index,a),a.on("updated",(function(e){return n.emit("messageUpdated",e)})),a}},{key:"_getMessages",value:(t=A.default(F.default.mark((function e(){var t,n,r,i,a,s,o=this,u=arguments;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:30,n=u.length>1&&void 0!==u[1]?u[1]:"end",r=u.length>2&&void 0!==u[2]?u[2]:"forward",i="backwards"===r?"desc":"asc",e.next=6,this.messagesListPromise;case 6:return a=e.sent,e.next=9,null==a?void 0:a.getItems({from:"end"!==n?n:void 0,pageSize:t,order:i,limit:t});case 9:return s=e.sent,e.next=12,this._wrapPaginator(i,s,(function(e){return Promise.all(e.map((function(e){return o._upsertMessage(e.index,e.data)})))}));case 12:return e.abrupt("return",e.sent);case 13:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),u}(g.ReplayEventEmitter),Ve=function(){function e(t){D.default(this,e),N.default(this,"attributes",{}),N.default(this,"mediaContent",[]),N.default(this,"emailOptions",{}),this.messagesEntity=t}return L.default(e,[{key:"send",value:function(){var e=this;return new C.CancellablePromise(function(){var t=A.default(F.default.mark((function t(n,r,i){var a,s;return F.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=e.messagesEntity.sendV2(e),i((function(){return a.cancel()})),t.prev=2,t.next=5,a;case 5:s=t.sent,n(te(s.index)),t.next=12;break;case 9:t.prev=9,t.t0=t.catch(2),r(t.t0);case 12:case"end":return t.stop()}}),t,null,[[2,9]])})));return function(e,n,r){return t.apply(this,arguments)}}())}}]),e}(),Ge=function(){function e(t,n){D.default(this,e),this.limits=t,this.message=new Ve(n),this.emailBodies=new Map,this.emailHistories=new Map}return L.default(e,[{key:"setBody",value:function(e){return this.message.text=e,this}},{key:"setSubject",value:function(e){return this.message.emailOptions.subject=e,this}},{key:"setAttributes",value:function(e){return this.message.attributes=e,this}},{key:"setEmailBody",value:function(e,t){return this.emailBodies.set(e,t),this}},{key:"setEmailHistory",value:function(e,t){return this.emailHistories.set(e,t),this}},{key:"setContentTemplate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this.message.contentSid=e,this.message.contentVariables=t,this}},{key:"addMedia",value:function(e){if("undefined"==typeof FormData&&e instanceof FormData)throw new Error("Could not add FormData content whilst not in a browser");if(!(e instanceof FormData)){var t=e;if(!t.contentType||!t.media)throw new Error("Media content in SendMediaOptions must contain non-empty contentType and media")}return this.message.mediaContent.push(["media",e]),this}},{key:"build",value:function(){var e=this;if(this.emailBodies.forEach((function(t,n){if(!e.limits.emailBodiesAllowedContentTypes.includes(n))throw new Error("Unsupported email body content type ".concat(n))})),this.emailHistories.forEach((function(t,n){if(!e.limits.emailHistoriesAllowedContentTypes.includes(n))throw new Error("Unsupported email history content type ".concat(n))})),this.emailBodies.size>this.limits.emailBodiesAllowedContentTypes.length)throw new Error("Too many email bodies attached to the message (".concat(this.emailBodies.size," > ").concat(this.limits.emailBodiesAllowedContentTypes.length,")"));if(this.emailHistories.size>this.limits.emailHistoriesAllowedContentTypes.length)throw new Error("Too many email histories attached to the message (".concat(this.emailHistories.size," > ").concat(this.limits.emailHistoriesAllowedContentTypes.length,")"));if(this.message.mediaContent.length>this.limits.mediaAttachmentsCountLimit)throw new Error("Too many media attachments in the message (".concat(this.message.mediaContent.length," > ").concat(this.limits.mediaAttachmentsCountLimit,")"));return this.emailBodies.forEach((function(t){e.message.mediaContent.push(["body",t])})),this.emailHistories.forEach((function(t){e.message.mediaContent.push(["history",t])})),this.message}},{key:"buildAndSend",value:function(){return this.build().send()}}]),e}();function Ke(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return $e(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return $e(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function $e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Xe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}H([y.validateTypes("string"),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Ge)],Ge.prototype,"setBody",null),H([y.validateTypes("string"),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Ge)],Ge.prototype,"setSubject",null),H([y.validateTypes(ae),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Ge)],Ge.prototype,"setAttributes",null),H([y.validateTypes("string",[FormData,oe]),Q("design:type",Function),Q("design:paramtypes",[String,Object]),Q("design:returntype",Ge)],Ge.prototype,"setEmailBody",null),H([y.validateTypes("string",[FormData,oe]),Q("design:type",Function),Q("design:paramtypes",[String,Object]),Q("design:returntype",Ge)],Ge.prototype,"setEmailHistory",null),H([y.validateTypes("string",[y.array("content variables",Re),"undefined"]),Q("design:type",Function),Q("design:paramtypes",[String,Array]),Q("design:returntype",Ge)],Ge.prototype,"setContentTemplate",null),H([y.validateTypes([FormData,oe]),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Ge)],Ge.prototype,"addMedia",null);var Ze={lastMessage:"lastMessage",attributes:"attributes",createdBy:"createdBy",dateCreated:"dateCreated",dateUpdated:"dateUpdated",friendlyName:"friendlyName",lastConsumedMessageIndex:"lastConsumedMessageIndex",notificationLevel:"notificationLevel",sid:"sid",status:"status",uniqueName:"uniqueName",state:"state",bindings:"bindings"},et=function(e){M.default(j,e);var t,n,r,i,a,s,o,u,c,l,d,f,p,h,v,y,m,g,b,k,w,_,x,C,E,R,I,T,P,U=Xe(j);function j(e,t,n,r,i){var a,s,o;D.default(this,j),(o=U.call(this)).sid=t,o._links=n,o._configuration=r,o._services=i,o._entityName=e.channel,o._internalState={uniqueName:e.uniqueName||null,status:"notParticipating",attributes:null!==(a=e.attributes)&&void 0!==a?a:{},createdBy:e.createdBy,dateCreated:ne(e.dateCreated),dateUpdated:ne(e.dateUpdated),friendlyName:e.friendlyName||null,lastReadMessageIndex:Number.isInteger(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,bindings:null!==(s=e.bindings)&&void 0!==s?s:{}},e.notificationLevel&&(o._internalState.notificationLevel=e.notificationLevel);var u={participants:o._links.participants};return o._participants=new Map,o._participantsEntity=new ke(O.default(o),o._participants,u,o._services),o._participantsEntity.on(j.participantJoined,(function(e){return o.emit(j.participantJoined,e)})),o._participantsEntity.on(j.participantLeft,(function(e){return o.emit(j.participantLeft,e)})),o._participantsEntity.on(j.participantUpdated,(function(e){return o.emit(j.participantUpdated,e)})),o._messagesEntity=new Qe(O.default(o),r,i),o._messagesEntity.on(j.messageAdded,(function(e){return o._onMessageAdded(e)})),o._messagesEntity.on(j.messageUpdated,(function(e){return o.emit(j.messageUpdated,e)})),o._messagesEntity.on(j.messageRemoved,(function(e){return o.emit(j.messageRemoved,e)})),o}return L.default(j,[{key:"uniqueName",get:function(){return this._internalState.uniqueName}},{key:"status",get:function(){return this._internalState.status}},{key:"friendlyName",get:function(){return this._internalState.friendlyName}},{key:"dateUpdated",get:function(){return this._internalState.dateUpdated}},{key:"dateCreated",get:function(){return this._internalState.dateCreated}},{key:"createdBy",get:function(){var e;return null!==(e=this._internalState.createdBy)&&void 0!==e?e:""}},{key:"attributes",get:function(){return this._internalState.attributes}},{key:"lastReadMessageIndex",get:function(){return this._internalState.lastReadMessageIndex}},{key:"lastMessage",get:function(){var e;return null!==(e=this._internalState.lastMessage)&&void 0!==e?e:void 0}},{key:"notificationLevel",get:function(){var e;return null!==(e=this._internalState.notificationLevel)&&void 0!==e?e:"default"}},{key:"bindings",get:function(){return this._internalState.bindings}},{key:"limits",get:function(){return this._configuration.limits}},{key:"state",get:function(){return this._internalState.state}},{key:"_statusSource",get:function(){return this._dataSource}},{key:"add",value:(P=A.default(F.default.mark((function e(t,n){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._participantsEntity.add(t,null!=n?n:{}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return P.apply(this,arguments)})},{key:"addNonChatParticipant",value:(T=A.default(F.default.mark((function e(t,n){var r,i,a=arguments;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]?a[2]:{},i=a.length>3&&void 0!==a[3]?a[3]:{},e.abrupt("return",this._participantsEntity.addNonChatParticipant(t,n,null!=r?r:{},null!=i?i:{}));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return T.apply(this,arguments)})},{key:"advanceLastReadMessageIndex",value:(I=A.default(F.default.mark((function e(t){var n;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:if(!(t<(null!==(n=this.lastReadMessageIndex)&&void 0!==n?n:0))){e.next=6;break}return e.next=5,this._setLastReadMessageIndex(this.lastReadMessageIndex);case 5:return e.abrupt("return",e.sent);case 6:return e.next=8,this._setLastReadMessageIndex(t);case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"delete",value:(R=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("delete",this._links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"getAttributes",value:(E=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return e.abrupt("return",this.attributes);case 3:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"getMessages",value:(C=A.default(F.default.mark((function e(t,n,r){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._messagesEntity.getMessages(t,n,r));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return C.apply(this,arguments)})},{key:"getParticipants",value:(x=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._participantsEntity.getParticipants());case 3:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"getParticipantsCount",value:(_=A.default(F.default.mark((function e(){var t,n,r;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new ie(this._configuration.links.conversations).path(this.sid).build(),e.next=3,this._services.network.get(n);case 3:return r=e.sent,e.abrupt("return",null!==(t=r.body.participants_count)&&void 0!==t?t:0);case 5:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"getParticipantBySid",value:(w=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._participantsEntity.getParticipantBySid(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(k=A.default(F.default.mark((function e(){var t,n=arguments;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:"",e.abrupt("return",this._participantsEntity.getParticipantByIdentity(null!=t?t:""));case 2:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"getMessagesCount",value:(b=A.default(F.default.mark((function e(){var t,n,r;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new ie(this._configuration.links.conversations).path(this.sid).build(),e.next=3,this._services.network.get(n);case 3:return r=e.sent,e.abrupt("return",null!==(t=r.body.messages_count)&&void 0!==t?t:0);case 5:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"getUnreadMessagesCount",value:(g=A.default(F.default.mark((function e(){var t,n,r;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new ie(this._configuration.links.myConversations).path(this.sid).build(),e.next=3,this._services.network.get(t);case 3:if((n=e.sent).body.conversation_sid===this.sid){e.next=6;break}throw new Error("Conversation was not found in the user conversations list");case 6:if("number"!=typeof(r=n.body.unread_messages_count)){e.next=9;break}return e.abrupt("return",r);case 9:return e.abrupt("return",null);case 10:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"join",value:(m=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post",this._links.participants,{identity:this._configuration.userIdentity});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"leave",value:(y=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("joined"!==this._internalState.status){e.next=3;break}return e.next=3,this._services.commandExecutor.mutateResource("delete","".concat(this._links.participants,"/").concat(encodeURIComponent(this._configuration.userIdentity)));case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"removeParticipant",value:(v=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._participantsEntity.remove("string"==typeof t?t:t.sid);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"sendMessage",value:(h=A.default(F.default.mark((function e(t,n,r){var i,a,s,o;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"!=typeof t&&null!==t){e.next=5;break}return e.next=3,this._messagesEntity.send(t,n,r);case 3:return s=e.sent,e.abrupt("return",null!==(a=te(s.index))&&void 0!==a?a:0);case 5:return e.next=7,this._messagesEntity.sendMedia(t,n,r);case 7:return o=e.sent,e.abrupt("return",null!==(i=te(o.index))&&void 0!==i?i:0);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return h.apply(this,arguments)})},{key:"prepareMessage",value:function(){return new Ge(this.limits,this._messagesEntity)}},{key:"setAllMessagesRead",value:(p=A.default(F.default.mark((function e(){var t;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this.getMessages(1);case 4:if(!((t=e.sent).items.length>0)){e.next=7;break}return e.abrupt("return",this.advanceLastReadMessageIndex(t.items[0].index));case 7:return e.abrupt("return",0);case 8:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"setAllMessagesUnread",value:(f=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this._setLastReadMessageIndex(null);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"setUserNotificationLevel",value:(d=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post","".concat(this._configuration.links.myConversations,"/").concat(this.sid),{notification_level:t});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"typing",value:function(){return this._services.typingIndicator.send(this.sid)}},{key:"updateAttributes",value:(l=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post",this._links.self,{attributes:void 0!==t?JSON.stringify(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"updateFriendlyName",value:(c=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._internalState.friendlyName===t){e.next=3;break}return e.next=3,this._services.commandExecutor.mutateResource("post",this._links.self,{friendly_name:t});case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"updateLastReadMessageIndex",value:(u=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._setLastReadMessageIndex(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"updateUniqueName",value:(o=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._internalState.uniqueName===t){e.next=4;break}return t||(t=""),e.next=4,this._services.commandExecutor.mutateResource("post",this._links.self,{unique_name:t});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"getMessageRecipients",value:(s=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.messageRecipientsClient.getRecipientsFromConversation(this.sid,t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"_subscribe",value:(a=A.default(F.default.mark((function e(){var t=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._entityPromise){e.next=2;break}return e.abrupt("return",this._entityPromise);case 2:return this._entityPromise=this._services.syncClient.document({id:this._entityName,mode:"open_existing"}),e.prev=3,e.next=6,this._entityPromise;case 6:return this._entity=e.sent,this._entity.on(S.SyncDocument.updated,(function(e){return t._update(e.data)})),this._entity.on(S.SyncDocument.removed,(function(){return t.emit(j.removed,t)})),this._update(this._entity.data),e.abrupt("return",this._entity);case 13:throw e.prev=13,e.t0=e.catch(3),this._entity=null,this._entityPromise=null,"disconnected"!=this._services.syncClient.connectionState&&j._logger.error("Failed to get conversation object",e.t0),j._logger.debug("ERROR: Failed to get conversation object",e.t0),e.t0;case 20:case"end":return e.stop()}}),e,this,[[3,13]])}))),function(){return a.apply(this,arguments)})},{key:"_fetchStreams",value:(i=A.default(F.default.mark((function e(){var t,n,r;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return j._logger.trace("_streamsAvailable, this.entity.data=",null===(t=this._entity)||void 0===t?void 0:t.data),r=null===(n=this._entity)||void 0===n?void 0:n.data,e.next=6,this._services.syncClient.list({id:r.messages,mode:"open_existing"});case 6:return this._messagesList=e.sent,e.next=9,this._services.syncClient.map({id:r.roster,mode:"open_existing"});case 9:this._participantsMap=e.sent;case 10:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"_subscribeStreams",value:(r=A.default(F.default.mark((function e(){var t,n,r,i,a,s,o;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._subscribe();case 3:return j._logger.trace("_subscribeStreams, this.entity.data=",null===(t=this._entity)||void 0===t?void 0:t.data),a=null===(n=this._entity)||void 0===n?void 0:n.data,s=a.messages,o=a.roster,e.next=9,Promise.all([this._messagesEntity.subscribe(null!==(r=this._messagesList)&&void 0!==r?r:s),this._participantsEntity.subscribe(null!==(i=this._participantsMap)&&void 0!==i?i:o)]);case 9:e.next=16;break;case 11:throw e.prev=11,e.t0=e.catch(0),"disconnected"!==this._services.syncClient.connectionState&&j._logger.error("Failed to subscribe on conversation objects",this.sid,e.t0),j._logger.debug("ERROR: Failed to subscribe on conversation objects",this.sid,e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(){return r.apply(this,arguments)})},{key:"_unsubscribe",value:(n=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._entity&&(this._entity.close(),this._entity=null,this._entityPromise=null),e.abrupt("return",Promise.all([this._participantsEntity.unsubscribe(),this._messagesEntity.unsubscribe()]));case 2:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"_setStatus",value:function(e,t){var n=this;this._dataSource=t,this._internalState.status!==e&&(this._internalState.status=e,"joined"!==e?this._entityPromise&&this._unsubscribe().catch((function(t){if(j._logger.debug("ERROR while setting conversation status "+e,t),"disconnected"!==n._services.syncClient.connectionState)throw t})):this._subscribeStreams().catch((function(t){if(j._logger.debug("ERROR while setting conversation status "+e,t),"disconnected"!==n._services.syncClient.connectionState)throw t})))}},{key:"_update",value:function(e){var t,n,r,i,a;j._logger.trace("_update",e),j.preprocessUpdate(e,this.sid);for(var s=new Set,o=0,u=Object.keys(e);o<u.length;o++){var c=u[o],l=Ze[c];if(l)switch(l){case Ze.status:if(!e.status||"unknown"===e.status||this._internalState.status===e.status)break;this._internalState.status=e.status,s.add(l);break;case Ze.attributes:if(J.default(this._internalState.attributes,e.attributes))break;this._internalState.attributes=e.attributes,s.add(l);break;case Ze.lastConsumedMessageIndex:if(void 0===e.lastConsumedMessageIndex||e.lastConsumedMessageIndex===this._internalState.lastReadMessageIndex)break;this._internalState.lastReadMessageIndex=e.lastConsumedMessageIndex,s.add("lastReadMessageIndex");break;case Ze.lastMessage:if(this._internalState.lastMessage&&!e.lastMessage){delete this._internalState.lastMessage,s.add(l);break}this._internalState.lastMessage=this._internalState.lastMessage||{},void 0!==(null===(t=e.lastMessage)||void 0===t?void 0:t.index)&&e.lastMessage.index!==this._internalState.lastMessage.index&&(this._internalState.lastMessage.index=e.lastMessage.index,s.add(l)),void 0!==(null===(n=e.lastMessage)||void 0===n?void 0:n.timestamp)&&(null===(r=this._internalState.lastMessage)||void 0===r||null===(i=r.dateCreated)||void 0===i?void 0:i.getTime())!==e.lastMessage.timestamp.getTime()&&(this._internalState.lastMessage.dateCreated=e.lastMessage.timestamp,s.add(l)),J.default(this._internalState.lastMessage,{})&&delete this._internalState.lastMessage;break;case Ze.state:var d=e.state||void 0;if(void 0!==d&&(d.dateUpdated=new Date(d.dateUpdated)),J.default(this._internalState.state,d))break;this._internalState.state=d,s.add(l);break;case Ze.bindings:if(J.default(this._internalState.bindings,e.bindings))break;this._internalState.bindings=e.bindings,s.add(l);break;default:var f=e[c]instanceof Date,p=f&&(null===(a=this._internalState[l])||void 0===a?void 0:a.getTime())===e[c].getTime(),h=!f&&this[l]===e[c];if(p||h)break;this._internalState[l]=e[c],s.add(l)}}s.size>0&&this.emit(j.updated,{conversation:this,updateReasons:z.default(s)})}},{key:"_onMessageAdded",value:function(e){var t,n=Ke(this._participants.values());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.identity===e.author){r._endTyping();break}}}catch(e){n.e(e)}finally{n.f()}this.emit(j.messageAdded,e)}},{key:"_setLastReadMessageIndex",value:(t=A.default(F.default.mark((function e(t){var n;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post","".concat(this._configuration.links.myConversations,"/").concat(this.sid),{last_read_message_index:t});case 2:return n=e.sent,e.abrupt("return",n.unread_messages_count);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"preprocessUpdate",value:function(e,t){try{"string"==typeof e.attributes?e.attributes=JSON.parse(e.attributes):e.attributes&&JSON.stringify(e.attributes)}catch(n){j._logger.warn("Retrieved malformed attributes from the server for conversation: "+t),e.attributes={}}try{e.dateCreated&&(e.dateCreated=new Date(e.dateCreated))}catch(n){j._logger.warn("Retrieved malformed dateCreated from the server for conversation: "+t),delete e.dateCreated}try{e.dateUpdated&&(e.dateUpdated=new Date(e.dateUpdated))}catch(n){j._logger.warn("Retrieved malformed dateUpdated from the server for conversation: "+t),delete e.dateUpdated}try{e.lastMessage&&e.lastMessage.timestamp&&(e.lastMessage.timestamp=new Date(e.lastMessage.timestamp))}catch(n){j._logger.warn("Retrieved malformed lastMessage.timestamp from the server for conversation: "+t),delete e.lastMessage.timestamp}}}]),j}(g.ReplayEventEmitter);N.default(et,"participantJoined","participantJoined"),N.default(et,"participantLeft","participantLeft"),N.default(et,"participantUpdated","participantUpdated"),N.default(et,"messageAdded","messageAdded"),N.default(et,"messageRemoved","messageRemoved"),N.default(et,"messageUpdated","messageUpdated"),N.default(et,"typingEnded","typingEnded"),N.default(et,"typingStarted","typingStarted"),N.default(et,"updated","updated"),N.default(et,"removed","removed"),N.default(et,"_logger",K.scope("Conversation")),H([y.validateTypesAsync(y.nonEmptyString,se),Q("design:type",Function),Q("design:paramtypes",[String,Object]),Q("design:returntype",Promise)],et.prototype,"add",null),H([y.validateTypesAsync(y.nonEmptyString,y.nonEmptyString,se,se),Q("design:type",Function),Q("design:paramtypes",[String,String,Object,Object]),Q("design:returntype",Promise)],et.prototype,"addNonChatParticipant",null),H([y.validateTypesAsync(y.nonNegativeInteger),Q("design:type",Function),Q("design:paramtypes",[Number]),Q("design:returntype",Promise)],et.prototype,"advanceLastReadMessageIndex",null),H([y.validateTypesAsync(["undefined",y.nonNegativeInteger],["undefined",y.nonNegativeInteger],["undefined",y.literal("backwards","forward")]),Q("design:type",Function),Q("design:paramtypes",[Number,Number,String]),Q("design:returntype",Promise)],et.prototype,"getMessages",null),H([y.validateTypesAsync(y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],et.prototype,"getParticipantBySid",null),H([y.validateTypesAsync(y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],et.prototype,"getParticipantByIdentity",null),H([y.validateTypesAsync([y.nonEmptyString,me]),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Promise)],et.prototype,"removeParticipant",null),H([y.validateTypesAsync(["string",FormData,y.literal(null),y.objectSchema("media options",{contentType:y.nonEmptyString,media:y.custom((function(e){var t="string"==typeof e&&e.length>0||e instanceof Uint8Array||e instanceof ArrayBuffer;return"function"==typeof Blob&&(t=t||e instanceof Blob),[t,"a non-empty string, an instance of Buffer or an instance of Blob"]}))})],se,["undefined",y.literal(null),y.objectSchema("email attributes",{subject:[y.nonEmptyString,"undefined"]})]),Q("design:type",Function),Q("design:paramtypes",[Object,Object,Object]),Q("design:returntype",Promise)],et.prototype,"sendMessage",null),H([y.validateTypesAsync(y.literal("default","muted")),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],et.prototype,"setUserNotificationLevel",null),H([y.validateTypesAsync(ae),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Promise)],et.prototype,"updateAttributes",null),H([y.validateTypesAsync("string"),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],et.prototype,"updateFriendlyName",null),H([y.validateTypesAsync([y.literal(null),y.nonNegativeInteger]),Q("design:type",Function),Q("design:paramtypes",[Number]),Q("design:returntype",Promise)],et.prototype,"updateLastReadMessageIndex",null),H([y.validateTypesAsync(["string",y.literal(null)]),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],et.prototype,"updateUniqueName",null);var tt=function(){function e(){var t=this;D.default(this,e),this._promise=new Promise((function(e,n){t._resolve=e,t._reject=n}))}return L.default(e,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this.current=e,this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}}]),e}();function nt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return rt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return rt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function rt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function it(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function at(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?it(Object(n),!0).forEach((function(t){N.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):it(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function st(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}var ot=K.scope("Conversations"),ut=function(e){M.default(p,e);var t,n,r,i,a,s,o,u,c,l,d,f=st(p);function p(e,t){var n;return D.default(this,p),n=f.call(this),N.default(O.default(n),"conversations",new Map),N.default(O.default(n),"myConversationsRead",new tt),N.default(O.default(n),"tombstones",new Set),N.default(O.default(n),"myConversationsFetched",!1),n.configuration=e,n.services=t,n}return L.default(p,[{key:"addConversation",value:(d=A.default(F.default.mark((function e(t){var n,r,i,a,s,o,u,c,l,d;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=void 0!==(null==t?void 0:t.attributes)?t.attributes:{},e.next=3,this.services.commandExecutor.mutateResource("post",this.configuration.links.conversations,{friendly_name:t.friendlyName,unique_name:t.uniqueName,attributes:void 0!==a?JSON.stringify(a):void 0});case 3:if(s=e.sent,o=null!==(n=s.sid)&&void 0!==n?n:null,u=null!==(r=null===(i=s.sync_objects)||void 0===i?void 0:i.conversation)&&void 0!==r?r:null,c=at({self:s.url},s.links),!(l=this.conversations.get(o))){e.next=12;break}return e.next=11,l._subscribe();case 11:return e.abrupt("return",l);case 12:return d=new et({channel:u,entityName:"",uniqueName:"",attributes:null,createdBy:"",friendlyName:"",lastConsumedMessageIndex:0,dateCreated:null,dateUpdated:null},o,c,this.configuration,this.services),this.conversations.set(d.sid,d),this._registerForEvents(d),e.next=17,d._subscribe();case 17:return this.emit("conversationAdded",d),e.abrupt("return",d);case 19:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"fetchConversations",value:(l=A.default(F.default.mark((function e(){var t,n,r,i,a,s,o,u=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getMap();case 3:return(t=e.sent).on(S.SyncMap.itemAdded,(function(e){ot.debug("itemAdded: ".concat(e.item.key)),u._upsertConversation("sync",e.item.key,e.item.data)})),t.on(S.SyncMap.itemRemoved,(function(e){ot.debug("itemRemoved: ".concat(e.key));var t=e.key;u.myConversationsFetched||u.tombstones.add(t);var n=u.conversations.get(t);n&&("joined"===n.status&&(n._setStatus("notParticipating","sync"),u.emit("conversationLeft",n)),u.conversations.delete(t),u.emit("conversationRemoved",n),n.emit("removed",n))})),t.on(S.SyncMap.itemUpdated,(function(e){ot.debug("itemUpdated: ".concat(e.item.key)),u._upsertConversation("sync",e.item.key,e.item.data)})),e.next=9,this._fetchMyConversations();case 9:n=e.sent,r=[],i=nt(n);try{for(i.s();!(a=i.n()).done;)s=a.value,r.push(this._upsertConversation("rest",s.channel_sid,s))}catch(e){i.e(e)}finally{i.f()}return this.myConversationsRead.set(!0),e.next=16,Promise.all(r);case 16:return this.myConversationsFetched=!0,this.tombstones.clear(),ot.debug("The conversations list has been successfully fetched"),e.abrupt("return",this);case 22:throw e.prev=22,e.t0=e.catch(0),o="Failed to fetch the conversations list","disconnected"!==this.services.syncClient.connectionState&&ot.error(o,e.t0),ot.debug("ERROR: ".concat(o),e.t0),e.t0;case 28:case"end":return e.stop()}}),e,this,[[0,22]])}))),function(){return l.apply(this,arguments)})},{key:"getConversations",value:(c=A.default(F.default.mark((function e(){var t,n,r=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getMap();case 2:return t=e.sent,e.next=5,t.getItems();case 5:return n=e.sent,e.abrupt("return",this._wrapPaginator(n,(function(e){return Promise.all(e.map((function(e){return r._upsertConversation("sync",e.key,e.data)})))})));case 7:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"getConversation",value:(u=A.default(F.default.mark((function e(t){var n,r,i,a=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getMap();case 2:return n=e.sent,e.next=5,n.getItems({key:t});case 5:return r=e.sent,i=r.items.map((function(e){return a._upsertConversation("sync",e.key,e.data)})),e.abrupt("return",i.length>0?i[0]:null);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"getConversationByUniqueName",value:(o=A.default(F.default.mark((function e(t){var n,r,i,a,s;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new ie(this.configuration.links.myConversations).path(t).build(),e.next=3,this.services.network.get(n);case 3:return r=e.sent,i=r.body,a=i.conversation_sid,s={entityName:null,lastConsumedMessageIndex:i.last_read_message_index,status:(null==i?void 0:i.status)||"unknown",friendlyName:i.friendly_name,dateUpdated:i.date_updated,dateCreated:i.date_created,uniqueName:i.unique_name,createdBy:i.created_by,attributes:i.attributes,channel:i.sync_objects.conversation,notificationLevel:null==i?void 0:i.notification_level,sid:a},e.abrupt("return",a?this._upsertConversation("sync",a,s):null);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"peekConversation",value:(s=A.default(F.default.mark((function e(t){var n,r,i,a;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new ie(this.configuration.links.conversations).path(t).build(),e.next=3,this.services.network.get(n);case 3:return r=e.sent,i=r.body,a={entityName:null,status:(null==i?void 0:i.status)||"unknown",friendlyName:i.friendly_name,dateUpdated:i.date_updated,dateCreated:i.date_created,uniqueName:i.unique_name,createdBy:i.created_by,attributes:i.attributes,channel:"".concat(t,".channel"),sid:t},e.abrupt("return",this._upsertConversation("sync",t,a));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"_getMap",value:(a=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.syncClient.map({id:this.configuration.myConversations,mode:"open_existing"});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"_wrapPaginator",value:(i=A.default(F.default.mark((function e(t,n){var r,i=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n(t.items);case 2:return r=e.sent,e.abrupt("return",{items:r.filter((function(e){return null!==e})),hasNextPage:t.hasNextPage,hasPrevPage:t.hasPrevPage,nextPage:function(){return t.nextPage().then((function(e){return i._wrapPaginator(e,n)}))},prevPage:function(){return t.prevPage().then((function(e){return i._wrapPaginator(e,n)}))}});case 4:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})},{key:"_updateConversation",value:(r=A.default(F.default.mark((function e(t,n,r){var i,a,s;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=void 0!==n._statusSource&&t!==n._statusSource,a="rest"!==t||"sync"===n._statusSource,!i||!a||"sync"===t){e.next=5;break}return ot.trace("upsertConversation: conversation is known from sync and came from REST, ignoring",{sid:n.sid,data:r.status,conversation:n.status}),e.abrupt("return");case 5:if("joined"!==r.status||"joined"===n.status){e.next=15;break}return n._setStatus("joined",t),s={},void 0!==r.notificationLevel&&(s.notificationLevel=r.notificationLevel),void 0!==r.lastConsumedMessageIndex&&(s.lastConsumedMessageIndex=r.lastConsumedMessageIndex),J.default(s,{})||n._update(s),e.next=13,n._subscribe();case 13:return this.emit("conversationJoined",n),e.abrupt("return");case 15:if("notParticipating"!==r.status||"joined"!==n.status){e.next=22;break}return n._setStatus("notParticipating",t),n._update(r),e.next=20,n._subscribe();case 20:return this.emit("conversationLeft",n),e.abrupt("return");case 22:if("notParticipating"!==r.status){e.next=26;break}return e.next=25,n._subscribe();case 25:return e.abrupt("return");case 26:n._update(r);case 27:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"_upsertConversation",value:(n=A.default(F.default.mark((function e(t,n,r){var i,a,s,o;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(ot.trace("upsertConversation called for ".concat(n),r),!(i=this.conversations.get(n))){e.next=9;break}return ot.trace("upsertConversation: the conversation ".concat(i.sid," is known;")+"its status is known from the source ".concat(i._statusSource," ")+"and the update came from the source ".concat(t),i),e.next=6,this._updateConversation(t,i,r);case 6:return e.next=8,i._subscribe();case 8:return e.abrupt("return",i);case 9:if("rest"!==t||!this.tombstones.has(n)){e.next=12;break}return ot.trace("upsertChannel: the conversation is deleted but reappeared again from REST, ignoring",n),e.abrupt("return",null);case 12:return ot.trace("upsertConversation: creating a local conversation object with sid "+n,r),a="".concat(this.configuration.links.conversations,"/").concat(n),s={self:a,messages:"".concat(a,"/Messages"),participants:"".concat(a,"/Participants")},o=new et(r,n,s,this.configuration,this.services),this.conversations.set(n,o),e.prev=17,e.next=20,o._subscribe();case 20:if("joined"!==r.status){e.next=23;break}return e.next=23,o._fetchStreams();case 23:e.next=32;break;case 25:if(e.prev=25,e.t0=e.catch(17),"SyncError"===e.t0.name){e.next=29;break}throw e.t0;case 29:return ot.trace("upsertChannel: the conversation is missing some Sync entity(ies), ignoring",n,e.t0),this.conversations.delete(n),e.abrupt("return",null);case 32:return this._registerForEvents(o),this.emit("conversationAdded",o),"joined"===r.status&&(o._setStatus("joined",t),this.emit("conversationJoined",o)),e.abrupt("return",o);case 36:case"end":return e.stop()}}),e,this,[[17,25]])}))),function(e,t,r){return n.apply(this,arguments)})},{key:"_fetchMyConversations",value:(t=A.default(F.default.mark((function e(){var t,n,r,i,a,s;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=null;case 2:return i=new ie(this.configuration.links.myConversations),n&&i.arg("PageToken",n),e.next=6,this.services.network.get(i.build());case 6:a=e.sent,s=null===(r=a.body)||void 0===r?void 0:r.conversations.map((function(e){return{descriptor:e,channel_sid:e.conversation_sid,status:e.status,channel:e.sync_objects.conversation,messages:e.sync_objects.messages,roster:"".concat(e.conversation_sid,".roster"),lastConsumedMessageIndex:e.last_read_message_index,notificationLevel:e.notification_level}})),n=a.body.meta.next_token,t=[].concat(z.default(t),z.default(s));case 10:if(n){e.next=2;break}case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_onConversationRemoved",value:function(e){var t=this.conversations.get(e);t&&(this.conversations.delete(e),this.emit("conversationRemoved",t))}},{key:"_registerForEvents",value:function(e){var t=this;e.on("removed",(function(){return t._onConversationRemoved(e.sid)})),e.on("updated",(function(e){return t.emit("conversationUpdated",e)})),e.on("participantJoined",(function(e){return t.emit("participantJoined",e)})),e.on("participantLeft",(function(e){return t.emit("participantLeft",e)})),e.on("participantUpdated",(function(e){return t.emit("participantUpdated",e)})),e.on("messageAdded",(function(e){return t.emit("messageAdded",e)})),e.on("messageUpdated",(function(e){return t.emit("messageUpdated",e)})),e.on("messageRemoved",(function(e){return t.emit("messageRemoved",e)})),e.on("typingStarted",(function(e){return t.emit("typingStarted",e)})),e.on("typingEnded",(function(e){return t.emit("typingEnded",e)}))}}]),p}(g.ReplayEventEmitter);function ct(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}var lt=function(e){M.default(a,e);var t,n,r,i=ct(a);function a(e,t,n){var r;return D.default(this,a),(r=i.call(this)).configuration=t,r.services=n,r.fifoStack=[],r.myself=e,r.myself.on("updated",(function(e){return r.emit("userUpdated",e)})),r.myself.on("userSubscribed",(function(){return r.emit("userSubscribed",r.myself)})),r.myself.on("userUnsubscribed",(function(){r.emit("userUnsubscribed",r.myself),r.myself._ensureFetched()})),r.subscribedUsers=new Map,r}return L.default(a,[{key:"handleUnsubscribeUser",value:function(e){this.subscribedUsers.has(e.identity)&&this.subscribedUsers.delete(e.identity);var t=0;this.fifoStack.find((function(n,r){return n==e.identity&&(t=r,!0)}))&&this.fifoStack.splice(t,1),this.emit("userUnsubscribed",e)}},{key:"handleSubscribeUser",value:function(e){if(!this.subscribedUsers.has(e.identity)){if(this.fifoStack.length>=this.configuration.userInfosToSubscribe){var t,n,r=this.fifoStack.shift();null===(t=this.subscribedUsers)||void 0===t||null===(n=t.get(r))||void 0===n||n.unsubscribe()}this.fifoStack.push(e.identity),this.subscribedUsers.set(e.identity,e),this.emit("userSubscribed",e)}}},{key:"getUser",value:(r=A.default(F.default.mark((function e(t,n){var r,i,a,s=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:if(t!=this.myself.identity){e.next=4;break}return e.abrupt("return",this.myself);case 4:if(!(i=this.subscribedUsers.get(t))){e.next=7;break}return e.abrupt("return",i);case 7:if(null===(r=n)||void 0===r){e.next=11;break}e.next=14;break;case 11:return e.next=13,this.getSyncUniqueName(t);case 13:n=e.sent;case 14:return(a=new le(t,n,this.configuration,this.services)).on("updated",(function(e){return s.emit("userUpdated",e)})),a.on("userSubscribed",(function(){return s.handleSubscribeUser(a)})),a.on("userUnsubscribed",(function(){return s.handleUnsubscribeUser(a)})),e.next=20,a._ensureFetched();case 20:return e.abrupt("return",a);case 21:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"getSubscribedUsers",value:(n=A.default(F.default.mark((function e(){var t;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:return t=[this.myself],this.subscribedUsers.forEach((function(e){return t.push(e)})),e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getSyncUniqueName",value:(t=A.default(F.default.mark((function e(t){var n,r,i,a;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new ie(this.configuration.links.users).path(t).build(),e.next=3,this.services.network.get(i);case 3:return a=e.sent,e.abrupt("return",null!==(n=null===(r=a.body)||void 0===r?void 0:r.sync_objects.user_info_map)&&void 0!==n?n:"");case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),a}(g.ReplayEventEmitter),dt=K.scope("TypingIndicator"),ft=function(){function e(t,n,r){D.default(this,e),this.configuration=n,this.services=r,this.getConversation=t,this.serviceTypingTimeout=null,this.sentUpdates=new Map}var t;return L.default(e,[{key:"typingTimeout",get:function(){return this.configuration.typingIndicatorTimeoutOverride||this.serviceTypingTimeout||this.configuration.typingIndicatorTimeoutDefault}},{key:"initialize",value:function(){var e=this;this.services.notificationClient.on("message",function(){var t=A.default(F.default.mark((function t(n,r){return F.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==he.TYPING_INDICATOR){t.next=3;break}return t.next=3,e._handleRemoteTyping(r);case 3:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}())}},{key:"_handleRemoteTyping",value:(t=A.default(F.default.mark((function e(t){var n=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:dt.trace("Got new typing indicator ",t),this.getConversation(t.channel_sid).then((function(e){e&&e._participants.forEach((function(e){if(e.identity===t.identity){var r=n.configuration.typingIndicatorTimeoutOverride?n.configuration.typingIndicatorTimeoutOverride+1e3:1e3*t.typing_timeout;e._startTyping(r)}}))})).catch((function(e){throw dt.error(e),e}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"send",value:function(e){var t=this.sentUpdates.get(e);return t&&t>Date.now()-this.typingTimeout?Promise.resolve():(this.sentUpdates.set(e,Date.now()),this._send(e))}},{key:"_send",value:function(e){var t=this;dt.trace("Sending typing indicator");var n=this.configuration.links.typing,r="ChannelSid=".concat(e);return this.services.twilsockClient.post(n,{"Content-Type":"application/x-www-form-urlencoded"},r,this.configuration.productId).then((function(e){e.body.hasOwnProperty("typing_timeout")&&(t.serviceTypingTimeout=1e3*e.body.typing_timeout)})).catch((function(e){throw dt.error("Failed to send typing indicator:",e),e}))}}]),e}(),pt=L.default((function e(t){D.default(this,e),this.title=t.title||null,this.body=t.body||null,this.sound=t.sound||null,this.badge=t.badge||null,this.action=t.action||null,this.type=t.type||null,this.data=t.data||{}}));function ht(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function vt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ht(Object(n),!0).forEach((function(t){N.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ht(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function yt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}var mt=function(e){return e.replace(/(^\/+|\/+$)/g,"")},gt=function(e){M.default(n,e);var t=yt(n);function n(e){return D.default(this,n),t.call(this,e)}return L.default(n)}(Y.default(Error)),bt=function(){function e(t,n,r){D.default(this,e),this._serviceUrl=t,this._services=n,this._productId=r}var t,n,r;return L.default(e,[{key:"_preProcessUrl",value:function(e){var t=mt(e);return/^https?:\/\//.test(e)?t:"".concat(mt(this._serviceUrl),"/").concat(t)}},{key:"_makeRequest",value:(r=A.default(F.default.mark((function e(t,n,r,i){var a,s,o,u;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=this._preProcessUrl(n),s=vt({"Content-Type":"application/json; charset=utf-8"},i||{}),e.t0=t,e.next="get"===e.t0?5:"post"===e.t0?11:"delete"===e.t0?15:19;break;case 5:return u=a,r&&(u+="?"+Object.entries(r).map((function(e){return e.map(encodeURIComponent).join("=")})).join("&")),e.next=9,this._services.transport.get(u,s,this._productId);case 9:return o=e.sent,e.abrupt("break",19);case 11:return e.next=13,this._services.transport.post(a,s,JSON.stringify(r),this._productId);case 13:return o=e.sent,e.abrupt("break",19);case 15:return e.next=17,this._services.transport.delete(a,s,{},this._productId);case 17:return o=e.sent,e.abrupt("break",19);case 19:if(!(o.status.code<200||o.status.code>=300)){e.next=21;break}throw new Error("Request responded with a non-success code ".concat(o.status.code));case 21:return e.abrupt("return",o);case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,n,i){return r.apply(this,arguments)})},{key:"fetchResource",value:(n=A.default(F.default.mark((function e(t,n){var r,i,a=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new w.AsyncRetrier({min:50,max:1600,maxAttemptsCount:6}),e.prev=2,e.next=5,r.run(A.default(F.default.mark((function e(){var r,i,s;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a._makeRequest("get",t,n);case 3:return r=e.sent,e.abrupt("return",{type:"success",data:r.body});case 7:if(e.prev=7,e.t0=e.catch(0),404!==(null===e.t0||void 0===e.t0||null===(i=e.t0.body)||void 0===i?void 0:i.status)||50530!==(null===e.t0||void 0===e.t0||null===(s=e.t0.body)||void 0===s?void 0:s.code)){e.next=11;break}return e.abrupt("return",{type:"noMetadata"});case 11:throw e.t0;case 12:case"end":return e.stop()}}),e,null,[[0,7]])}))));case 5:i=e.sent,e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(2),new Error('Fetch resource from "'.concat(t,'" failed.'));case 11:if("noMetadata"!==i.type){e.next=13;break}throw new gt("No metadata found.");case 13:return e.abrupt("return",i.data);case 14:case"end":return e.stop()}}),e,null,[[2,8]])}))),function(e,t){return n.apply(this,arguments)})},{key:"mutateResource",value:(t=A.default(F.default.mark((function e(t,n,r){var i;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._makeRequest(t,n,r,{"X-Twilio-Mutation-Id":I.v4()});case 2:if(202!==(i=e.sent).status.code){e.next=7;break}return e.next=6,this.fetchResource(i.body.resource_url);case 6:return e.abrupt("return",e.sent);case 7:return e.abrupt("return",i.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,n,r){return t.apply(this,arguments)})}]),e}(),kt=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;D.default(this,e),N.default(this,"_cachedTemplates",null),this._services=t,this._pageSize=n,this._cacheTtlMs=r}var t,n;return L.default(e,[{key:"getContentTemplates",value:(n=A.default(F.default.mark((function e(){var t,n,r,i,a,s,o,u=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===this._cachedTemplates){e.next=2;break}return e.abrupt("return",this._cachedTemplates);case 2:return e.next=4,this._fetchContentTemplates();case 4:t=e.sent,n=W.default(t,2),r=n[0],i=n[1],a=r;case 9:if(null===i){e.next=19;break}return e.next=12,this._fetchContentTemplates(i);case 12:s=e.sent,o=W.default(s,2),r=o[0],i=o[1],a=[].concat(z.default(a),z.default(r)),e.next=9;break;case 19:return this._cachedTemplates=Object.freeze(a),setTimeout((function(){u._cachedTemplates=null}),this._cacheTtlMs),e.abrupt("return",a);case 22:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"_fetchContentTemplates",value:(t=A.default(F.default.mark((function e(t){var n,r;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=new ie("Client/v2/ContentTemplates")).arg("PageSize",this._pageSize),void 0!==t&&n.arg("PageToken",t),e.next=6,this._services.commandExecutor.fetchResource(n.build());case 6:return r=e.sent,e.abrupt("return",[r.templates.map((function(e){return new Ie(e)})),r.meta.next_token]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();function wt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return _t(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _t(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function _t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var xt=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(D.default(this,t),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");this.maxSize=e.maxSize,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}return L.default(t,[{key:"_set",value:function(e,t){if(this.cache.set(e,t),this._size++,this._size>=this.maxSize){if(this._size=0,"function"==typeof this.onEviction){var n,r=wt(this.oldCache.entries());try{for(r.s();!(n=r.n()).done;){var i=W.default(n.value,2),a=i[0],s=i[1];this.onEviction(a,s)}}catch(e){r.e(e)}finally{r.f()}}this.oldCache=this.cache,this.cache=new Map}}},{key:"get",value:function(e){if(this.cache.has(e))return this.cache.get(e);if(this.oldCache.has(e)){var t=this.oldCache.get(e);return this.oldCache.delete(e),this._set(e,t),t}}},{key:"set",value:function(e,t){return this.cache.has(e)?this.cache.set(e,t):this._set(e,t),this}},{key:"has",value:function(e){return this.cache.has(e)||this.oldCache.has(e)}},{key:"peek",value:function(e){return this.cache.has(e)?this.cache.get(e):this.oldCache.has(e)?this.oldCache.get(e):void 0}},{key:"delete",value:function(e){var t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}},{key:"clear",value:function(){this.cache.clear(),this.oldCache.clear(),this._size=0}},{key:"keys",value:F.default.mark((function e(){var t,n,r,i;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=wt(this),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=W.default(n.value,1),i=r[0],e.next=7,i;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"values",value:F.default.mark((function e(){var t,n,r,i;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=wt(this),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=W.default(n.value,2),i=r[1],e.next=7,i;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:e,value:F.default.mark((function e(){var t,n,r,i,a,s,o,u;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=wt(this.cache),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,r;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:i=wt(this.oldCache),e.prev=18,i.s();case 20:if((a=i.n()).done){e.next=28;break}if(s=a.value,o=W.default(s,1),u=o[0],this.cache.has(u)){e.next=26;break}return e.next=26,s;case 26:e.next=20;break;case 28:e.next=33;break;case 30:e.prev=30,e.t1=e.catch(18),i.e(e.t1);case 33:return e.prev=33,i.f(),e.finish(33);case 36:case"end":return e.stop()}}),e,this,[[1,11,14,17],[18,30,33,36]])}))},{key:"size",get:function(){var e,t=0,n=wt(this.oldCache.keys());try{for(n.s();!(e=n.n()).done;){var r=e.value;this.cache.has(r)||t++}}catch(e){n.e(e)}finally{n.f()}return Math.min(this._size+t,this.maxSize)}}]),t}(Symbol.iterator),St=L.default((function e(t,n){D.default(this,e),this.type=t,this.data=n,Object.freeze(n)})),Ct=function(){function e(t,n){D.default(this,e),this._services=t,this._configuration=n,this._cache=new xt({maxSize:n.channelMetadataCacheCapacity})}var t;return L.default(e,[{key:"getChannelMetadata",value:(t=A.default(F.default.mark((function e(t,n){var r,i,a,s,o;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="".concat(t,",").concat(n),!(i=this._cache.get(r))){e.next=4;break}return e.abrupt("return",i.item);case 4:return a="".concat(this._configuration.links.conversations,"/").concat(t,"/Messages/").concat(n,"/ChannelMetadata"),e.prev=5,e.next=8,this._services.commandExecutor.fetchResource(a);case 8:s=e.sent,e.next=17;break;case 11:if(e.prev=11,e.t0=e.catch(5),!(e.t0 instanceof gt)){e.next=16;break}return this._cache.set(r,{item:null}),e.abrupt("return",null);case 16:throw new Error(e.t0);case 17:return o=new St(s.type,s.data),this._cache.set(r,{item:o}),e.abrupt("return",o);case 20:case"end":return e.stop()}}),e,this,[[5,11]])}))),function(e,n){return t.apply(this,arguments)})}]),e}();function Et(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Rt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Rt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function Rt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var It,Tt,Pt=L.default((function e(t){D.default(this,e),N.default(this,"type","email"),this.messageSid=t.message_sid,this.level=t.level,this.name=t.name,this.address=t.address})),At=L.default((function e(t){D.default(this,e),this.type=t.type,this.messageSid=t.message_sid,this.rawData=JSON.stringify(t)})),Ot=function(){function e(t,n){D.default(this,e),this._services=t,this._configuration=n,this._cache=new xt({maxSize:n.messageRecipientsCacheCapacity})}var t,n;return L.default(e,[{key:"getRecipientsFromMessage",value:(n=A.default(F.default.mark((function e(t,n){var r,i,a,s,o,u=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="".concat(t,",").concat(n),!(i=this._cache.get(r))){e.next=4;break}return e.abrupt("return",i.item);case 4:return a=new ie(this._configuration.links.conversations).path(t).path("MessageRecipients").arg("MessageSid",n).build(),e.next=7,this._services.commandExecutor.fetchResource(a);case 7:return s=e.sent,(o=s.message_recipients.map((function(e){return u._wrapResponse(e)}))).length>0&&this._cache.set(r,{item:o}),e.abrupt("return",o);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"getRecipientsFromConversation",value:(t=A.default(F.default.mark((function e(t,n){var r,i,a,s,o,u,c,l,d,f,p,h,v=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new ie(this._configuration.links.conversations).path(t).path("MessageRecipients").arg("PageToken",null!==(r=null==n?void 0:n.pageToken)&&void 0!==r?r:void 0).arg("PageSize",null!==(i=null==n?void 0:n.pageSize)&&void 0!==i?i:void 0).build(),e.next=3,this._services.commandExecutor.fetchResource(a);case 3:s=e.sent,o=s.message_recipients.map((function(e){return v._wrapResponse(e)})),u=Et(o);try{for(u.s();!(c=u.n()).done;)f=c.value,p="".concat(t,",").concat(f.messageSid),h=null!==(l=null===(d=this._cache.get(p))||void 0===d?void 0:d.item)&&void 0!==l?l:[],this._cache.set(p,{item:[].concat(z.default(h),[f])})}catch(e){u.e(e)}finally{u.f()}return e.abrupt("return",new xe(o,(function(e,n){return v.getRecipientsFromConversation(t,{pageToken:e,pageSize:n})}),s.meta.previous_token,s.meta.next_token));case 8:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"_wrapResponse",value:function(e){switch(e.type){case"email":return new Pt(e);default:return new At(e)}}}]),e}();function Mt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ut(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Mt(Object(n),!0).forEach((function(t){N.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Mt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function jt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=j.default(e);if(t){var i=j.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return U.default(this,n)}}var Nt=L.default((function e(){D.default(this,e)}));t.Client=(It=function(e){M.default(g,e);var t,n,r,i,a,s,o,u,c,l,d,f,p,h,v,y,m=jt(g);function g(e){var t,n,r,i,a,s,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(D.default(this,g),s=m.call(this),N.default(O.default(s),"version","2.6.0"),N.default(O.default(s),"connectionState","unknown"),N.default(O.default(s),"parsePushNotification",Tt.parsePushNotification),s._fpaToken=null!=e?e:"",s._options=null!=o?o:{},!s._options.disableDeepClone){var u=Ut(Ut({},s._options),{},{transport:void 0,twilsockClient:void 0});(u=ee(u)).transport=s._options.transport,u.twilsockClient=s._options.twilsockClient,s._options=u}s._options.logLevel=null!==(t=s._options.logLevel)&&void 0!==t?t:"silent",Tt._logger.setLevel(s._options.logLevel);var c=s._options.productId="ip_messaging";if(s._options.clientMetadata=s._options.clientMetadata||{},s._options.clientMetadata.hasOwnProperty("type")||(s._options.clientMetadata.type="conversations"),s._options.clientMetadata.hasOwnProperty("sdk")||(s._options.clientMetadata.sdk="JS",s._options.clientMetadata.sdkv="2.6.0"),s._options.Sync=s._options.Sync||{},void 0===s._options.Sync.enableSessionStorage&&(s._options.Sync.enableSessionStorage=!0),s._options.region&&(s._options.Sync.region=s._options.region),!e)throw new Error("A valid Twilio token should be provided");s._services=new Nt,s._myself=new le("","",null,s._services);var l=!s._options.twilsockClient;if(!s._options.initRegistrations){var d=new _.InitRegistration(c);Tt.populateInitRegistrations(d),s._options.initRegistrations=[d]}s._services.twilsockClient=s._options.twilsockClient=null!==(n=s._options.twilsockClient)&&void 0!==n?n:new _.TwilsockClient(e,c,s._options),s._services.twilsockClient.on(Tt.tokenAboutToExpire,(function(){return s.emit(Tt.tokenAboutToExpire)})),s._services.twilsockClient.on(Tt.tokenExpired,(function(){return s.emit(Tt.tokenExpired)})),s._services.twilsockClient.on(Tt.connectionError,(function(e){return s.emit(Tt.connectionError,e)})),s._services.twilsockClient.on("stateChanged",(function(e){Tt._logger.debug("Handling stateChanged for ConversationsClient: new state ".concat(e)),e!==s.connectionState&&(s.connectionState=e,s.emit(Tt.connectionStateChanged,s.connectionState))})),s._services.transport=s._options.transport=null!==(r=s._options.transport)&&void 0!==r?r:s._options.twilsockClient,s._services.notificationClient=s._options.notificationsClient=null!==(i=s._options.notificationsClient)&&void 0!==i?i:new x.Notifications(e,s._options),s._services.syncClient=s._options.syncClient=null!==(a=s._options.syncClient)&&void 0!==a?a:new S.SyncClient(e,s._options);var f=(null==o?void 0:o.Chat)||(null==o?void 0:o.IPMessaging)||o||{},p=f.region||(null==o?void 0:o.region),h=f.apiUri||f.typingUri||"https://aim.".concat(p||"us1",".twilio.com");s._services.commandExecutor=new bt(h,{transport:s._options.transport},c),s._services.contentClient=new kt(s._services);var v=function(e){s._rejectEnsureReady(e),s.emit(Tt.stateChanged,"failed"),s.emit(Tt.initFailed,{error:e})},y=function(){v({terminal:!0,message:"Twilsock has disconnected."}),s._initializeEnsureReady((null==o?void 0:o.throwErrorsAlways)||!1)};return s._services.twilsockClient.once("connectionError",v),s._services.twilsockClient.once("disconnected",y),s._services.twilsockClient.once("connected",A.default(F.default.mark((function e(){var t,n;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Tt._logger.debug("ConversationsClient started INITIALIZING"),s._services.twilsockClient.off("connectionError",v),s._services.twilsockClient.off("disconnected",y),e.prev=3,t="conversations.client.startup",s._services.twilsockClient.addPartialTelemetryEvent(new _.TelemetryEventDescription(t,"Conversations client startup",new Date),t,_.TelemetryPoint.Start),e.next=8,s._initialize();case 8:s._services.twilsockClient.addPartialTelemetryEvent(new _.TelemetryEventDescription("","",new Date),t,_.TelemetryPoint.End),e.next=17;break;case 11:e.prev=11,e.t0=e.catch(3),n={terminal:!0,message:e.t0.message},s._rejectEnsureReady(n),s.emit(Tt.stateChanged,"failed"),s.emit(Tt.initFailed,{error:n});case 17:case"end":return e.stop()}}),e,null,[[3,11]])})))),s._initializeEnsureReady((null==o?void 0:o.throwErrorsAlways)||!1),l&&s._services.twilsockClient.connect(),s}return L.default(g,[{key:"user",get:function(){return this._myself}},{key:"reachabilityEnabled",get:function(){if(!this._configuration)throw new Error("Reachability information could not yet be accessed as the client has not yet been initialized. Subscribe to the 'stateChanged' event to properly react to the client initialization.");return this._configuration.reachabilityEnabled}},{key:"token",get:function(){return this._fpaToken}},{key:"shutdown",value:(y=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._services.twilsockClient.disconnect();case 4:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"updateToken",value:(v=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:if(Tt._logger.info("updateToken"),this._fpaToken!==t){e.next=5;break}return e.abrupt("return",this);case 5:return e.next=7,this._services.twilsockClient.updateToken(t);case 7:return e.next=9,this._services.notificationClient.updateToken(t);case 9:return e.next=11,this._services.mcsClient.updateToken(t);case 11:return this._fpaToken=t,e.abrupt("return",this);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"getConversationBySid",value:(h=A.default(F.default.mark((function e(t){var n;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.myConversationsRead.promise;case 4:return e.next=6,this._conversationsEntity.getConversation(t);case 6:if(n=e.sent){e.next=12;break}return e.next=10,this.peekConversationBySid(t);case 10:(n=e.sent)&&E.deprecationWarning("The method getConversationBySid is deprecated to retrieve conversations you're not part of. Use peekConversationBySid instead.");case 12:if(n){e.next=14;break}throw new Error("Conversation with SID ".concat(t," was not found."));case 14:return e.abrupt("return",n);case 15:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"peekConversationBySid",value:(p=A.default(F.default.mark((function e(t){var n;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.peekConversation(t);case 4:if(n=e.sent){e.next=7;break}throw new Error("Conversation with SID ".concat(t," was not found."));case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"getConversationByUniqueName",value:(f=A.default(F.default.mark((function e(t){var n;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.myConversationsRead.promise;case 4:return e.next=6,this._conversationsEntity.getConversationByUniqueName(t);case 6:if(n=e.sent){e.next=9;break}throw new Error("Conversation with unique name ".concat(t," was not found."));case 9:return e.abrupt("return",n);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"getSubscribedConversations",value:(d=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._conversationsPromise.then((function(e){return e.getConversations()})));case 3:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"createConversation",value:(l=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return t=t||{},e.abrupt("return",this._conversationsPromise.then((function(e){return e.addConversation(t)})));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"setPushRegistrationId",value:(c=A.default(F.default.mark((function e(t,n){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return this._subscribeToPushNotifications(t),this._services.notificationClient.setPushRegistrationId(t,n),e.next=6,this._services.notificationClient.commitChanges();case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"unsetPushRegistrationId",value:(u=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return this._unsubscribeFromPushNotifications(t),e.next=5,this._services.notificationClient.commitChanges();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"removePushRegistrations",value:(o=A.default(F.default.mark((function e(t,n){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.notificationClient.removeRegistrations(t,n);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"handlePushNotification",value:(s=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:Tt._logger.debug("handlePushNotification, notificationPayload=",t),this.emit("pushNotification",Tt.parsePushNotification(t));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"getUser",value:(a=A.default(F.default.mark((function e(t){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._services.users.getUser(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getSubscribedUsers",value:(i=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._services.users.getSubscribedUsers());case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getTemporaryContentUrlsForMediaSids",value:function(e){var t=this;return new C.CancellablePromise(function(){var n=A.default(F.default.mark((function n(r,i,a){var s,o;return F.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t._services.mcsClient&&e){n.next=3;break}return i(new Error("Media Content Service is unavailable")),n.abrupt("return");case 3:return s=t._services.mcsClient.mediaSetGetContentUrls(e),a((function(){s.cancel()})),n.prev=5,n.next=8,s;case 8:o=n.sent,r(o),n.next=15;break;case 12:n.prev=12,n.t0=n.catch(5),i(n.t0);case 15:case"end":return n.stop()}}),n,null,[[5,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"getTemporaryContentUrlsForMedia",value:function(e){var t=e.map((function(e){return e.sid}));return this.getTemporaryContentUrlsForMediaSids(t)}},{key:"getContentTemplates",value:(r=A.default(F.default.mark((function e(){return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._services.contentClient.getContentTemplates();case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"_initialize",value:(n=A.default(F.default.mark((function e(){var t,n=this;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.fetchResource("Client/v2/Configuration");case 2:return t=e.sent,this._configuration=new Z(this._options,t,Tt._logger),this._services.channelMetadataClient=new Ct(this._services,this._configuration),this._services.messageRecipientsClient=new Ot(this._services,this._configuration),this._myself._resolveInitialization(this._configuration,this._configuration.userIdentity,this._configuration.userInfo,!0),this._services.typingIndicator=new ft(this.getConversationBySid.bind(this),this._configuration,this._services),this._services.network=new pe(this._configuration,this._services),this._services.users=new lt(this._myself,this._configuration,this._services),this._services.users.on("userSubscribed",(function(e){n.emit("userSubscribed",e)})),this._services.users.on("userUpdated",(function(e){return n.emit("userUpdated",e)})),this._services.users.on("userUnsubscribed",(function(e){n.emit("userUnsubscribed",e)})),this._conversationsEntity=new ut(this._configuration,this._services),this._conversationsEntity.on("conversationAdded",(function(e){n.emit("conversationAdded",e)})),this._conversationsEntity.on("conversationRemoved",(function(e){n.emit("conversationRemoved",e)})),this._conversationsEntity.on("conversationJoined",(function(e){n.emit("conversationJoined",e)})),this._conversationsEntity.on("conversationLeft",(function(e){n.emit("conversationLeft",e)})),this._conversationsEntity.on("conversationUpdated",(function(e){return n.emit("conversationUpdated",e)})),this._conversationsEntity.on("participantJoined",(function(e){n.emit("participantJoined",e)})),this._conversationsEntity.on("participantLeft",(function(e){n.emit("participantLeft",e)})),this._conversationsEntity.on("participantUpdated",(function(e){return n.emit("participantUpdated",e)})),this._conversationsEntity.on("messageAdded",(function(e){return n.emit("messageAdded",e)})),this._conversationsEntity.on("messageUpdated",(function(e){return n.emit("messageUpdated",e)})),this._conversationsEntity.on("messageRemoved",(function(e){return n.emit("messageRemoved",e)})),this._conversationsEntity.on("typingStarted",(function(e){return n.emit("typingStarted",e)})),this._conversationsEntity.on("typingEnded",(function(e){return n.emit("typingEnded",e)})),this._conversationsPromise=this._conversationsEntity.fetchConversations().then((function(){return n._conversationsEntity})).catch((function(e){throw e})),e.next=30,this._services.users.myself._ensureFetched();case 30:Tt._supportedPushChannels.forEach((function(e){return n._subscribeToPushNotifications(e)})),this._services.typingIndicator.initialize(),this._services.mcsClient=new C.McsClient(this._fpaToken,this._configuration.links.mediaService,this._configuration.links.mediaSetService,Ut(Ut({},this._options),{},{transport:void 0})),this._resolveEnsureReady(),this.emit(Tt.stateChanged,"initialized"),this.emit(Tt.initialized);case 36:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"_subscribeToPushNotifications",value:function(e){var t=this;[he.NEW_MESSAGE,he.ADDED_TO_CONVERSATION,he.REMOVED_FROM_CONVERSATION,he.TYPING_INDICATOR,he.CONSUMPTION_UPDATE].forEach((function(n){t._services.notificationClient.subscribe(e,n)}))}},{key:"_unsubscribeFromPushNotifications",value:function(e){var t=this;[he.NEW_MESSAGE,he.ADDED_TO_CONVERSATION,he.REMOVED_FROM_CONVERSATION,he.TYPING_INDICATOR,he.CONSUMPTION_UPDATE].forEach((function(n){t._services.notificationClient.unsubscribe(e,n)}))}},{key:"_initializeEnsureReady",value:function(e){var t=this;this._ensureReady=new Promise((function(e,n){t._resolveEnsureReady=e,t._rejectEnsureReady=n})).catch((function(t){if(e)throw t}))}}],[{key:"create",value:(t=A.default(F.default.mark((function e(t,n){var r;return F.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==n||!n.twilsockClient){e.next=2;break}throw new Error("Obsolete usage of ConversationsClient.create() factory method: if you pass twilsock from the outside then you must use ConversationsClient constructor and be prepared to work with uninitialized client.");case 2:return r=new Tt(t,n),e.next=5,r._ensureReady;case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e)}))),function(e,n){return t.apply(this,arguments)})},{key:"parsePushNotification",value:function(e){if(Tt._logger.debug("parsePushNotification, notificationPayload=",e),void 0!==e.aps){if(!e.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var t,n,r,i=Tt._parsePushNotificationChatData(e),a=e.aps,s=null;if("string"==typeof a.alert)t=a.alert||null;else t=(null===(n=a.alert)||void 0===n?void 0:n.body)||null,s=(null===(r=a.alert)||void 0===r?void 0:r.title)||null;return new pt({title:s,body:t,sound:a.sound||null,badge:a.badge||null,action:a.category||null,type:e.twi_message_type,data:i})}if(void 0!==e.data){var o=e.data;if(!o.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var u=Tt._parsePushNotificationChatData(e.data);return new pt({title:o.twi_title||null,body:o.twi_body||null,sound:o.twi_sound||null,badge:null,action:o.twi_action||null,type:o.twi_message_type,data:u})}throw new Error("Provided push notification payload is not Programmable Chat notification")}},{key:"_parsePushNotificationChatData",value:function(e){var t={};for(var n in Tt._supportedPushDataFields){var r=e[n];if(null!=r)if("message_index"!==n&&"media_count"!==n){if("media"!==n)t[Tt._supportedPushDataFields[n]]=r;else if("string"==typeof r)try{t[Tt._supportedPushDataFields[n]]=JSON.parse(r)}catch(e){Tt._logger.debug("Media message notification parsing error")}}else{var i=te(r);null!==i&&(t[Tt._supportedPushDataFields[n]]=i)}}return t}},{key:"populateInitRegistrations",value:function(e){e.populateInitRegistrations([he.TYPING_INDICATOR]),S.SyncClient.populateInitRegistrations(e)}}]),g}(g.ReplayEventEmitter),N.default(It,"conversationAdded","conversationAdded"),N.default(It,"conversationJoined","conversationJoined"),N.default(It,"conversationLeft","conversationLeft"),N.default(It,"conversationRemoved","conversationRemoved"),N.default(It,"conversationUpdated","conversationUpdated"),N.default(It,"participantJoined","participantJoined"),N.default(It,"participantLeft","participantLeft"),N.default(It,"participantUpdated","participantUpdated"),N.default(It,"messageAdded","messageAdded"),N.default(It,"messageRemoved","messageRemoved"),N.default(It,"messageUpdated","messageUpdated"),N.default(It,"tokenAboutToExpire","tokenAboutToExpire"),N.default(It,"tokenExpired","tokenExpired"),N.default(It,"typingEnded","typingEnded"),N.default(It,"typingStarted","typingStarted"),N.default(It,"pushNotification","pushNotification"),N.default(It,"userSubscribed","userSubscribed"),N.default(It,"userUnsubscribed","userUnsubscribed"),N.default(It,"userUpdated","userUpdated"),N.default(It,"stateChanged","stateChanged"),N.default(It,"initialized","initialized"),N.default(It,"initFailed","initFailed"),N.default(It,"connectionStateChanged","connectionStateChanged"),N.default(It,"connectionError","connectionError"),N.default(It,"version","2.6.0"),N.default(It,"_logger",K.scope("Client")),N.default(It,"_supportedPushChannels",["fcm","apn"]),N.default(It,"_supportedPushDataFields",{conversation_sid:"conversationSid",conversation_title:"conversationTitle",message_sid:"messageSid",message_index:"messageIndex",media_count:"mediaCount",media:"media"}),Tt=It),H([E.deprecated("token"),Q("design:type",String),Q("design:paramtypes",[])],t.Client.prototype,"token",null),H([y.validateTypesAsync(y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],t.Client.prototype,"updateToken",null),H([y.validateTypesAsync(y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],t.Client.prototype,"getConversationBySid",null),H([y.validateTypesAsync(y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],t.Client.prototype,"peekConversationBySid",null),H([y.validateTypesAsync(y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],t.Client.prototype,"getConversationByUniqueName",null),H([y.validateTypesAsync(["undefined",y.objectSchema("conversation options",{friendlyName:["string","undefined"],isPrivate:["boolean","undefined"],uniqueName:["string","undefined"]})]),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Promise)],t.Client.prototype,"createConversation",null),H([y.validateTypesAsync(y.literal("fcm","apn"),"string"),Q("design:type",Function),Q("design:paramtypes",[String,String]),Q("design:returntype",Promise)],t.Client.prototype,"setPushRegistrationId",null),H([y.validateTypesAsync(y.literal("fcm","apn")),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],t.Client.prototype,"unsetPushRegistrationId",null),H([y.validateTypesAsync(y.literal("fcm","apn"),y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String,String]),Q("design:returntype",Promise)],t.Client.prototype,"removePushRegistrations",null),H([y.validateTypesAsync(y.pureObject),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",Promise)],t.Client.prototype,"handlePushNotification",null),H([y.validateTypesAsync(y.nonEmptyString),Q("design:type",Function),Q("design:paramtypes",[String]),Q("design:returntype",Promise)],t.Client.prototype,"getUser",null),H([y.validateTypesAsync(y.nonEmptyArray("strings","string")),Q("design:type",Function),Q("design:paramtypes",[Array]),Q("design:returntype",C.CancellablePromise)],t.Client.prototype,"getTemporaryContentUrlsForMediaSids",null),H([y.validateTypesAsync(y.nonEmptyArray("media",we)),Q("design:type",Function),Q("design:paramtypes",[Array]),Q("design:returntype",C.CancellablePromise)],t.Client.prototype,"getTemporaryContentUrlsForMedia",null),H([E.deprecated("Client.create()","new Client()"),y.validateTypesAsync("string",["undefined",y.pureObject]),Q("design:type",Function),Q("design:paramtypes",[String,Object]),Q("design:returntype",Promise)],t.Client,"create",null),H([y.validateTypes(y.pureObject),Q("design:type",Function),Q("design:paramtypes",[Object]),Q("design:returntype",pt)],t.Client,"parsePushNotification",null),t.Client=Tt=H([y.validateConstructorTypes(y.nonEmptyString,[y.pureObject,"undefined"]),Q("design:paramtypes",[String,Object])],t.Client),Object.defineProperty(t,"CancellablePromise",{enumerable:!0,get:function(){return C.CancellablePromise}}),t.AggregatedDeliveryReceipt=_e,t.ChannelMetadata=St,t.ContentTemplate=Ie,t.ContentTemplateVariable=Re,t.Conversation=et,t.DetailedDeliveryReceipt=Se,t.EmailRecipientDescriptor=Pt,t.Media=we,t.Message=De,t.MessageBuilder=Ge,t.NotificationTypes=he,t.Participant=me,t.PushNotification=pt,t.RestPaginator=xe,t.UnknownRecipientDescriptor=At,t.UnsentMessage=Ve,t.User=le}).call(this,n(207).Buffer)},690:function(e,t,n){var r=n(66),i=/"/g;e.exports=function(e,t,n,a){var s=String(r(e)),o="<"+t;return""!==n&&(o+=" "+n+'="'+String(a).replace(i,"&quot;")+'"'),o+">"+s+"</"+t+">"}},691:function(e,t,n){var r=n(15);e.exports=function(e){return r((function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}))}},8:function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var r=n(3),i=n.n(r),a=n(11),s=n.n(a),o=(n(28),n(5),n(25),n(30),n(32),n(44),n(12),n(37),n(16),n(10),n(23),n(19),n(26),n(21),n(27),n(127)),u=n(1119),c=n(1120),l=n(7),d=n(4),f=n.n(d),p=(n(34),n(35),n(20),n(1121)),h=(p.a,p.a),v=function(e,t,n){if(!n&&!function(e){return e.startsWith("http://localhost:")||null!==e.match(/.+\.stripe\.me(?::\d+)?$/)||e.endsWith(".stripe.com")||e.endsWith(".link.co")||e.endsWith(".link.com")||"https://stripe.com"===e||"https://link.co"===e||"https://link.com"===e}(t))throw new Error("Invalid origin passed to thirdparty frame");var r=function(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i={type:"stripe-third-party-child-to-parent",frameID:e,payload:n,requestID:r};window.parent.postMessage(i,t)},i={},a=function(n){var r=n.data;return n.origin===t&&r&&"object"===f()(r)&&"stripe-third-party-parent-to-child"===r.type&&r.frameID===e?r:null},s=function(e){var t=a(e);if(t){var n=t.requestID,r=t.payload,s="string"==typeof n&&i[n];s&&s(r)}};return{subscribe:function(n){var s,o=function(e){var t=a(e);if(t){var s=t.requestID,o=t.payload;"string"==typeof s&&i[s]||n(o,(function(e){return r(e,s)}))}},u=window;return u.addEventListener("message",o),s={type:"stripe-third-party-frame-ready",frameID:e},window.parent.postMessage(s,t),function(){u.removeEventListener("message",o)}},send:function(e){return r(e,null)},request:function(e){0===Object.keys(i).length&&window.addEventListener("message",s);return new Promise((function(t){var n=h();i[n]=function(e){(t(e),delete i[n],0===Object.keys(i).length)&&window.removeEventListener("message",s)},r(e,n)}))},sendError:function(n){var r={type:"stripe-third-party-frame-error",frameID:e,error:n};window.parent.postMessage(r,t)}}},y=["sendError"];function m(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var g=function(e){Object(c.a)({dsn:"https://b2ef8ff49b754ecfb2aa683c670ed96e@errors.stripe.com/391",release:"d05e5ec06f146f00b3cc560a8a5354b79a9349b3",ignoreErrors:["top.GLOBALS","originalCreateNotification","canvas.contentDocument","MyApp_RemoveAllHighlights","http://tt.epicplay.com","Can't find variable: ZiteReader","jigsaw is not defined","ComboSearch is not defined","http://loading.retry.widdit.com/","atomicFindClose","fb_xd_fragment","bmi_SafeAddOnload","EBCallBackMessageReceived","conduitPage","Script error."],denyUrls:[/graph\.facebook\.com/i,/connect\.facebook\.net\/en_US\/all\.js/i,/eatdifferent\.com\.woopra-ns\.com/i,/static\.woopra\.com\/js\/woopra\.js/i,/extensions\//i,/^chrome:\/\//i,/127\.0\.0\.1:4001\/isrunning/i,/webappstoolbarba\.texthelp\.com\//i,/metrics\.itunes\.apple\.com\.edgesuite\.net\//i],integrations:[new l.a.GlobalHandlers({onunhandledrejection:!1}),new u.a]});var t=e.app,n=e.owner;Object(o.b)("owner",n);var r=document,a=r.body,d=r.location,f=new URLSearchParams(d.search.slice(1)),p=f.get("id"),h=f.get("origin");if(a&&p&&h){Object(o.b)("origin",h);var g=document.getElementById("root")||document.createElement("div");g.setAttribute("id","root"),a.appendChild(g);var b=d.pathname.endsWith("/RLogger.html"),k=v(p,h,b),w=k.sendError,_=s()(k,y);window.onerror=function(e,t,n,r,i){w(i||new Error(e))},t(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?m(Object(n),!0).forEach((function(t){i()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({root:g},_))}}},986:function(e,t,n){"use strict";var r=n(9),i=n(690);r({target:"String",proto:!0,forced:n(691)("anchor")},{anchor:function(e){return i(this,"a","name",e)}})},987:function(e,t,n){"use strict";
/*
@license
Copyright (c) 2021 Twilio Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

*/Object.defineProperty(t,"__esModule",{value:!0});var r=n(70),i=n(13),a=n(14),s=n(17),o=n(350),u=n(36),c=n(38),l=n(22),d=n(3);function f(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=f(r),h=f(i),v=f(a),y=f(s),m=f(o),g=f(u),b=f(c),k=f(l),w=f(d);function _(){}function x(){x.init.call(this)}function S(e){return void 0===e._maxListeners?x.defaultMaxListeners:e._maxListeners}function C(e,t,n){if(t)e.call(n);else for(var r=e.length,i=M(e,r),a=0;a<r;++a)i[a].call(n)}function E(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=M(e,i),s=0;s<i;++s)a[s].call(n,r)}function R(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,s=M(e,a),o=0;o<a;++o)s[o].call(n,r,i)}function I(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var s=e.length,o=M(e,s),u=0;u<s;++u)o[u].call(n,r,i,a)}function T(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=M(e,i),s=0;s<i;++s)a[s].apply(n,r)}function P(e,t,n,r){var i,a,s,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),s=a[t]):(a=e._events=new _,e._eventsCount=0),s){if("function"==typeof s?s=a[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),!s.warned&&(i=S(e))&&i>0&&s.length>i){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,o=u,"function"==typeof console.warn?console.warn(o):console.log(o)}}else s=a[t]=n,++e._eventsCount;return e}function A(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function O(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function M(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}function U(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=k.default(e);if(t){var i=k.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return b.default(this,n)}}_.prototype=Object.create(null),x.EventEmitter=x,x.usingDomains=!1,x.prototype.domain=void 0,x.prototype._events=void 0,x.prototype._maxListeners=void 0,x.defaultMaxListeners=10,x.init=function(){this.domain=null,x.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new _,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},x.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},x.prototype.getMaxListeners=function(){return S(this)},x.prototype.emit=function(e){var t,n,r,i,a,s,o,u="error"===e;if(s=this._events)u=u&&null==s.error;else if(!u)return!1;if(o=this.domain,u){if(t=arguments[1],!o){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(n=s[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:C(n,l,this);break;case 2:E(n,l,this,arguments[1]);break;case 3:R(n,l,this,arguments[1],arguments[2]);break;case 4:I(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];T(n,l,this,i)}return!0},x.prototype.addListener=function(e,t){return P(this,e,t,!1)},x.prototype.on=x.prototype.addListener,x.prototype.prependListener=function(e,t){return P(this,e,t,!0)},x.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,A(this,e,t)),this},x.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,A(this,e,t)),this},x.prototype.removeListener=function(e,t){var n,r,i,a,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new _:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){s=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new _,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,s||t)}return this},x.prototype.off=function(e,t){return this.removeListener(e,t)},x.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new _,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new _:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new _,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},x.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},x.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):O.call(e,t)},x.prototype.listenerCount=O,x.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var j=function(e){g.default(n,e);var t=U(n);function n(){var e;return h.default(this,n),e=t.call(this),w.default(y.default(e),"eventHistory",new Map),e}return v.default(n,[{key:"on",value:function(e,t){return m.default(k.default(n.prototype),"on",this).call(this,e,t)}},{key:"once",value:function(e,t){return m.default(k.default(n.prototype),"once",this).call(this,e,t)}},{key:"off",value:function(e,t){return m.default(k.default(n.prototype),"off",this).call(this,e,t)}},{key:"emit",value:function(e){for(var t,r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return this.eventHistory.set(e,i),(t=m.default(k.default(n.prototype),"emit",this)).call.apply(t,[this,e].concat(i))}},{key:"addListener",value:function(e,t){return m.default(k.default(n.prototype),"addListener",this).call(this,e,t)}},{key:"removeListener",value:function(e,t){return m.default(k.default(n.prototype),"removeListener",this).call(this,e,t)}},{key:"addListenerWithReplay",value:function(e,t){var n=this.eventHistory.get(e);return void 0!==n&&t.apply(void 0,p.default(n)),this.addListener(e,t)}},{key:"onWithReplay",value:function(e,t){return this.addListenerWithReplay(e,t)}},{key:"onceWithReplay",value:function(e,t){var r=this.eventHistory.get(e);return void 0!==r?(t.apply(void 0,p.default(r)),this):m.default(k.default(n.prototype),"once",this).call(this,e,t)}}]),n}(x);t.ReplayEventEmitter=j},988:function(e,t,n){"use strict";
/*
@license
The MIT License (MIT)

Copyright (c) 2016 Twilio Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/Object.defineProperty(t,"__esModule",{value:!0}),n(355),n(157);var r=n(2),i=n(13),a=n(14),s=n(36),o=n(38),u=n(22),c=n(1);n(133),n(244),n(156),n(166),n(167),n(168),n(245),n(142);var l=n(4),d=n(349),f=n(17),p=n(3);n(406),n(165),n(303);var h=n(222),v=n(18),y=n(70);n(351),n(247);var m=n(188),g=n(246),b=n(524);function k(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function w(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var _=k(r),x=k(i),S=k(a),C=k(s),E=k(o),R=k(u),I=k(c),T=k(l),P=k(f),A=k(p),O=k(v),M=k(y),U=w(m),j=w(g);function N(e,t,n,r){var i,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":T.default(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(a<3?i(s):a>3?i(t,n,s):i(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s}function L(e,t){if("object"===("undefined"==typeof Reflect?"undefined":T.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function D(){}function F(){F.init.call(this)}function B(e){return void 0===e._maxListeners?F.defaultMaxListeners:e._maxListeners}function q(e,t,n){if(t)e.call(n);else for(var r=e.length,i=G(e,r),a=0;a<r;++a)i[a].call(n)}function z(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=G(e,i),s=0;s<i;++s)a[s].call(n,r)}function J(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,s=G(e,a),o=0;o<a;++o)s[o].call(n,r,i)}function W(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var s=e.length,o=G(e,s),u=0;u<s;++u)o[u].call(n,r,i,a)}function Y(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=G(e,i),s=0;s<i;++s)a[s].apply(n,r)}function H(e,t,n,r){var i,a,s,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),s=a[t]):(a=e._events=new D,e._eventsCount=0),s){if("function"==typeof s?s=a[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),!s.warned&&(i=B(e))&&i>0&&s.length>i){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,o=u,"function"==typeof console.warn?console.warn(o):console.log(o)}}else s=a[t]=n,++e._eventsCount;return e}function Q(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function V(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function G(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}D.prototype=Object.create(null),F.EventEmitter=F,F.usingDomains=!1,F.prototype.domain=void 0,F.prototype._events=void 0,F.prototype._maxListeners=void 0,F.defaultMaxListeners=10,F.init=function(){this.domain=null,F.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new D,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},F.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},F.prototype.getMaxListeners=function(){return B(this)},F.prototype.emit=function(e){var t,n,r,i,a,s,o,u="error"===e;if(s=this._events)u=u&&null==s.error;else if(!u)return!1;if(o=this.domain,u){if(t=arguments[1],!o){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(n=s[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:q(n,l,this);break;case 2:z(n,l,this,arguments[1]);break;case 3:J(n,l,this,arguments[1],arguments[2]);break;case 4:W(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];Y(n,l,this,i)}return!0},F.prototype.addListener=function(e,t){return H(this,e,t,!1)},F.prototype.on=F.prototype.addListener,F.prototype.prependListener=function(e,t){return H(this,e,t,!0)},F.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,Q(this,e,t)),this},F.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,Q(this,e,t)),this},F.prototype.removeListener=function(e,t){var n,r,i,a,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new D:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){s=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new D,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,s||t)}return this},F.prototype.off=function(e,t){return this.removeListener(e,t)},F.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new D,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new D:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new D,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},F.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},F.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):V.call(e,t)},F.prototype.listenerCount=V,F.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var K=U.getLogger("twilio-notificatiions");function $(e,t){return["".concat((new Date).toISOString()," Twilio.Notifications ").concat(e,":")].concat(Array.from(t))}var X=new(function(){function e(){x.default(this,e)}return S.default(e,[{key:"setLevel",value:function(e){K.setLevel(e)}},{key:"trace",value:function(){if(K.getLevel()==K.levels.TRACE){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.debug.apply(null,$("T",t))}}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.debug.apply(null,$("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.info.apply(null,$("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.warn.apply(null,$("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.error.apply(null,$("E",t))}}]),e}());function Z(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=R.default(e);if(t){var i=R.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return E.default(this,n)}}var ee=S.default((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;x.default(this,e),this.token=t,this.notificationId=n,this.messageTypes=r}));function te(e,t){var n=new Set;return e.notificationId!==t.notificationId&&n.add("notificationId"),e.token!==t.token&&n.add("token"),function(e,t){return[].concat(M.default(M.default(e).filter((function(e){return!t.has(e)}))),M.default(M.default(t).filter((function(t){return!e.has(t)}))))}(e.messageTypes,t.messageTypes).length>0&&n.add("messageType"),[n.size>0,n]}var ne=function(e){C.default(r,e);var t,n=Z(r);function r(e){var t;return x.default(this,r),t=n.call(this),A.default(P.default(t),"desiredState",new ee),A.default(P.default(t),"currentState",new ee),A.default(P.default(t),"_hasActiveAttempt",!1),t.channelType=e,t}return S.default(r,[{key:"setNotificationId",value:function(e){this.desiredState.notificationId=e}},{key:"isActive",value:function(){return""!==this.desiredState.notificationId}},{key:"subscribe",value:function(e){this.desiredState.messageTypes.has(e)?X.debug("message type '".concat(e,"' for channel ").concat(this.channelType," is already registered")):this.desiredState.messageTypes.add(e)}},{key:"unsubscribe",value:function(e){this.desiredState.messageTypes.has(e)&&this.desiredState.messageTypes.delete(e)}},{key:"updateToken",value:function(e){this.desiredState.token=e}},{key:"commitChanges",value:(t=_.default(I.default.mark((function e(){var t,n,r,i,a,s;return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._hasActiveAttempt){e.next=3;break}throw X.error("One registration attempt is already in progress"),new Error("One registration attempt is already in progress");case 3:if(t=te(this.desiredState,this.currentState),n=O.default(t,2),r=n[0],i=n[1],r){e.next=6;break}return e.abrupt("return");case 6:if(this.currentState.notificationId||i.delete("notificationId"),X.trace("Persisting ".concat(this.channelType," registration"),i,this.desiredState),e.prev=8,this._hasActiveAttempt=!0,(a=new ee).token=this.desiredState.token,a.notificationId=this.desiredState.notificationId,a.messageTypes=new Set(this.desiredState.messageTypes),!(a.messageTypes.size>0)){e.next=24;break}return e.next=17,this.updateRegistration(a,i);case 17:s=e.sent,this.currentState.token=s.token,this.currentState.notificationId=s.notificationId,this.currentState.messageTypes=new Set(s.messageTypes),this.emit("stateChanged",this.channelType,"registered",this.currentState),e.next=30;break;case 24:return e.next=26,this.removeRegistration();case 26:this.currentState.token=a.token,this.currentState.notificationId=a.notificationId,this.currentState.messageTypes.clear(),this.emit("stateChanged",this.channelType,"unregistered",this.currentState);case 30:e.next=35;break;case 32:throw e.prev=32,e.t0=e.catch(8),e.t0;case 35:return e.prev=35,this._hasActiveAttempt=!1,e.finish(35);case 38:case"end":return e.stop()}}),e,this,[[8,32,35,38]])}))),function(){return t.apply(this,arguments)})}]),r}(F);function re(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=R.default(e);if(t){var i=R.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return E.default(this,n)}}var ie={min:2e3,max:12e4,randomness:.2},ae=function(e){C.default(a,e);var t,n,r,i=re(a);function a(e,t,n,r){var s;return x.default(this,a),s=i.call(this,e),A.default(P.default(s),"registrationId",null),s.context=t,s.twilsock=n,s.registrarUrl=r,s}return S.default(a,[{key:"updateRegistration",value:(r=_.default(I.default.mark((function e(t,n){var r,i,a,s,o,u=this;return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.has("notificationId")){e.next=3;break}return e.next=3,this.removeRegistration();case 3:if(t.notificationId&&t.notificationId.length){e.next=6;break}throw X.error("No push notification ID for registration"),new Error("No push notification ID for registration");case 6:return X.trace("Registering",this.channelType,t),r={endpoint_platform:this.context.platform,channel_type:this.channelType,version:this.context.protocolVersion.toString(),message_types:Array.from(t.messageTypes),data:{registration_id:t.notificationId}},i=this.context.productId,a="".concat(this.registrarUrl,"?productId=").concat(i),s={"Content-Type":"application/json"},X.trace("Creating registration for channel ".concat(this.channelType)),e.prev=12,e.next=15,new h.AsyncRetrier(ie).run((function(){return u.twilsock.post(a,s,r,i)}));case 15:o=e.sent,this.registrationId=o.body.id,X.debug("Registration created: ",o),e.next=24;break;case 20:throw e.prev=20,e.t0=e.catch(12),X.error("Registration failed: ",e.t0),e.t0;case 24:return e.abrupt("return",t);case 25:case"end":return e.stop()}}),e,this,[[12,20]])}))),function(e,t){return r.apply(this,arguments)})},{key:"removeRegistration",value:(n=_.default(I.default.mark((function e(){var t,n,r,i=this;return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrationId){e.next=2;break}return e.abrupt("return");case 2:return t=this.context.productId,n="".concat(this.registrarUrl,"/").concat(this.registrationId,"?productId=").concat(t),r={"Content-Type":"application/json"},X.trace("Removing registration for ".concat(this.channelType)),e.prev=6,e.next=9,new h.AsyncRetrier(Object.assign(ie,{maxAttemptsCount:3})).run((function(){return i.twilsock.delete(n,r,{},t)}));case 9:this.registrationId=null,this.currentState.notificationId="",X.debug("Registration removed for ".concat(this.channelType)),e.next=18;break;case 14:throw e.prev=14,e.t0=e.catch(6),X.error("Failed to remove registration ",this.channelType,e.t0),e.t0;case 18:case"end":return e.stop()}}),e,this,[[6,14]])}))),function(){return n.apply(this,arguments)})},{key:"sendDeviceRemoveRequest",value:(t=_.default(I.default.mark((function e(t){var n,r,i,a,s=this;return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""!==t){e.next=2;break}throw new Error("Empty registration ID");case 2:return n=this.context.productId,r="".concat(this.registrarUrl,"?productId=").concat(n),i={"Content-Type":"application/json"},a={binding_type:this.channelType,address:t},e.prev=6,X.trace("Removing old registrations for ".concat(this.channelType)),e.next=10,new h.AsyncRetrier(Object.assign(ie,{maxAttemptsCount:3})).run((function(){return s.twilsock.delete(r,i,a,n)}));case 10:this.registrationId=null,this.currentState.notificationId="",X.debug("Registration removed for ".concat(this.channelType)),e.next=19;break;case 15:throw e.prev=15,e.t0=e.catch(6),X.error("Failed to remove registration ",this.channelType,e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[6,15]])}))),function(e){return t.apply(this,arguments)})}]),a}(ne);function se(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=R.default(e);if(t){var i=R.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return E.default(this,n)}}var oe,ue=function(e){C.default(a,e);var t,n,r,i=se(a);function a(e,t,n){var r;return x.default(this,a),r=i.call(this,"twilsock"),A.default(P.default(r),"contextId",j.v4()),r.productId=e,r.platform=t,r.twilsock=n,r}return S.default(a,[{key:"updateRegistration",value:(r=_.default(I.default.mark((function e(t,n){var r,i;return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.has("messageType")){e.next=2;break}return e.abrupt("return",t);case 2:return r=Array.from(t.messageTypes),i={product_id:this.productId,notification_protocol_version:4,endpoint_platform:this.platform,message_types:r},e.prev=4,e.next=7,this.twilsock.setNotificationsContext(this.contextId,i);case 7:e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(4),X.error("Failed to update twilsock notification context: ".concat(e.t0)),e.t0;case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}}),e,this,[[4,9]])}))),function(e,t){return r.apply(this,arguments)})},{key:"removeRegistration",value:(n=_.default(I.default.mark((function e(){return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.twilsock.removeNotificationsContext(this.contextId);case 3:e.next=9;break;case 5:throw e.prev=5,e.t0=e.catch(0),X.error("Failed to remove twilsock notification context: ".concat(e.t0)),e.t0;case 9:case"end":return e.stop()}}),e,this,[[0,5]])}))),function(){return n.apply(this,arguments)})},{key:"sendDeviceRemoveRequest",value:(t=_.default(I.default.mark((function e(t){return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),a}(ne);function ce(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=R.default(e);if(t){var i=R.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return E.default(this,n)}}var le=b.literal("apn","fcm","twilsock");t.Notifications=oe=function(e){C.default(a,e);var t,n,r,i=ce(a);function a(e){var t,n,r,s,o,u,c,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};x.default(this,a),c=i.call(this),l.logLevel=null!==(t=l.logLevel)&&void 0!==t?t:"error",X.setLevel(l.logLevel);var f=null!==(n=l.productId)&&void 0!==n?n:"notifications",p=!l.twilsockClient,h=l.twilsockClient=null!==(r=l.twilsockClient)&&void 0!==r?r:new d.TwilsockClient(e,f,l),v=null!==(s=l.notifications)&&void 0!==s?s:{},y=null!==(o=null!==(u=v.region)&&void 0!==u?u:l.region)&&void 0!==o?o:"us1",m="https://ers.".concat(y,".twilio.com/v1/registrations"),g=v.ersUrl||m;c.connectors=new Map;var b=oe._detectPlatform();return c.connectors.set("apn",new ae("apn",{protocolVersion:4,productId:f,platform:b},h,g)),c.connectors.set("fcm",new ae("fcm",{protocolVersion:3,productId:f,platform:b},h,g)),c.connectors.set("twilsock",new ue(f,b,h)),h.on("stateChanged",(function(e){return c.emit("transportState",e)})),c._connector("twilsock").on("stateChanged",(function(e,t,n){return c.emit("stateChanged",e,t,n)})),c._connector("apn").on("stateChanged",(function(e,t,n){return c.emit("stateChanged",e,t,n)})),c._connector("fcm").on("stateChanged",(function(e,t,n){return c.emit("stateChanged",e,t,n)})),h.on("message",(function(e,t){return c._routeMessage(e,t)})),c.updateToken(e),p&&(h.connect(),c.twilsock=h),c}return S.default(a,[{key:"shutdown",value:(r=_.default(I.default.mark((function e(){return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.connectors.clear(),!this.twilsock){e.next=4;break}return e.next=4,this.twilsock.disconnect();case 4:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"setPushRegistrationId",value:function(e,t){X.debug("Set ".concat(e," push registration id '").concat(t,"'")),this._connector(e).setNotificationId(t)}},{key:"subscribe",value:function(e,t){X.debug("Add ".concat(e," subscriptions for message type ").concat(t)),this._connector(e).subscribe(t)}},{key:"unsubscribe",value:function(e,t){X.debug("Remove ".concat(e," subscriptions for message type ").concat(t)),this._connector(e).unsubscribe(t)}},{key:"updateToken",value:function(e){this.connectors.forEach((function(t){return t.updateToken(e)}))}},{key:"commitChanges",value:(n=_.default(I.default.mark((function e(){var t;return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.connectors.forEach((function(e){e.isActive()&&t.push(e.commitChanges())})),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"removeRegistrations",value:(t=_.default(I.default.mark((function e(t,n){return I.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._connector(t).sendDeviceRemoveRequest(n);case 2:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"handlePushNotification",value:function(e){return{messageType:e.twi_message_type,payload:e.payload}}},{key:"_routeMessage",value:function(e,t){X.debug("Notification message arrived: ",e,t),this.emit("message",e,t)}},{key:"_connector",value:function(e){var t=this.connectors.get(e);if(!t)throw new Error("Unknown channel type: ".concat(e));return t}}],[{key:"_detectPlatform",value:function(){var e="";return"undefined"!=typeof navigator?(e="unknown",void 0!==navigator.product&&(e=navigator.product),void 0!==navigator.userAgent&&(e=navigator.userAgent)):e="web",e.substring(0,128)}}]),a}(F),N([b.validateTypes(le,b.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",void 0)],t.Notifications.prototype,"setPushRegistrationId",null),N([b.validateTypes(le,b.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",void 0)],t.Notifications.prototype,"subscribe",null),N([b.validateTypes(le,b.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",void 0)],t.Notifications.prototype,"unsubscribe",null),N([b.validateTypes(b.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String]),L("design:returntype",void 0)],t.Notifications.prototype,"updateToken",null),N([b.validateTypesAsync(le,b.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",Promise)],t.Notifications.prototype,"removeRegistrations",null),t.Notifications=oe=N([b.validateConstructorTypes(b.nonEmptyString,[b.pureObject,"undefined",b.literal(null)]),L("design:paramtypes",[String,Object])],t.Notifications)},989:function(e,t,n){"use strict";
/*
@license
The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2016, Twilio, inc.
    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      1. Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.

      2. Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in
         the documentation and/or other materials provided with the
         distribution.

      3. Neither the name of Twilio nor the names of its contributors may
         be used to endorse or promote products derived from this software
         without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes loglevel under the following license.

    Copyright (c) 2013 Tim Perry

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.

This software includes Backoff library under the following license

    Copyright (C) 2012 Mathieu Turcotte

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.

This software includes Event-to-Promise library under the following license

    Copyright (c) 2014, Julien Fontanet <julien.fontanet@isonoe.net>.

    Permission to use, copy, modify, and/or distribute this software for any purpose
    with or without fee is hereby granted, provided that the above copyright notice
    and this permission notice appear in all copies.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND
    FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
    OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
    TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF
    THIS SOFTWARE.

*/Object.defineProperty(t,"__esModule",{value:!0}),n(352),n(239),n(247),n(353),n(245),n(354),n(157);var r=n(2),i=n(13),a=n(14),s=n(17),o=n(36),u=n(38),c=n(22),l=n(3);n(300),n(156),n(142);var d=n(1),f=n(4),p=n(301),h=n(349);n(221);var v=n(63);n(298),n(168),n(299),n(165),n(166);var y=n(188);n(264),n(241),n(297);var m=n(18);n(133),n(244),n(167),n(303),n(189),n(413);var g=n(222);n(302);var b=n(246),k=n(350);n(242);var w=n(412);function _(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function x(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var S=_(r),C=_(i),E=_(a),R=_(s),I=_(o),T=_(u),P=_(c),A=_(l),O=_(d),M=_(f),U=_(v),j=x(y),N=_(m),L=x(b),D=_(k),F=x(w);function B(e,t,n,r){var i,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":M.default(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(a<3?i(s):a>3?i(t,n,s):i(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s}function q(e,t){if("object"===("undefined"==typeof Reflect?"undefined":M.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function z(){}function J(){J.init.call(this)}function W(e){return void 0===e._maxListeners?J.defaultMaxListeners:e._maxListeners}function Y(e,t,n){if(t)e.call(n);else for(var r=e.length,i=Z(e,r),a=0;a<r;++a)i[a].call(n)}function H(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=Z(e,i),s=0;s<i;++s)a[s].call(n,r)}function Q(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,s=Z(e,a),o=0;o<a;++o)s[o].call(n,r,i)}function V(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var s=e.length,o=Z(e,s),u=0;u<s;++u)o[u].call(n,r,i,a)}function G(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=Z(e,i),s=0;s<i;++s)a[s].apply(n,r)}function K(e,t,n,r){var i,a,s,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),s=a[t]):(a=e._events=new z,e._eventsCount=0),s){if("function"==typeof s?s=a[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),!s.warned&&(i=W(e))&&i>0&&s.length>i){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,o=u,"function"==typeof console.warn?console.warn(o):console.log(o)}}else s=a[t]=n,++e._eventsCount;return e}function $(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function X(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function Z(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}z.prototype=Object.create(null),J.EventEmitter=J,J.usingDomains=!1,J.prototype.domain=void 0,J.prototype._events=void 0,J.prototype._maxListeners=void 0,J.defaultMaxListeners=10,J.init=function(){this.domain=null,J.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new z,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},J.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},J.prototype.getMaxListeners=function(){return W(this)},J.prototype.emit=function(e){var t,n,r,i,a,s,o,u="error"===e;if(s=this._events)u=u&&null==s.error;else if(!u)return!1;if(o=this.domain,u){if(t=arguments[1],!o){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(n=s[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:Y(n,l,this);break;case 2:H(n,l,this,arguments[1]);break;case 3:Q(n,l,this,arguments[1],arguments[2]);break;case 4:V(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];G(n,l,this,i)}return!0},J.prototype.addListener=function(e,t){return K(this,e,t,!1)},J.prototype.on=J.prototype.addListener,J.prototype.prependListener=function(e,t){return K(this,e,t,!0)},J.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,$(this,e,t)),this},J.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,$(this,e,t)),this},J.prototype.removeListener=function(e,t){var n,r,i,a,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new z:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){s=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new z,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,s||t)}return this},J.prototype.off=function(e,t){return this.removeListener(e,t)},J.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new z,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new z:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new z,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},J.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},J.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):X.call(e,t)},J.prototype.listenerCount=X,J.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var ee=function(){function e(t){C.default(this,e),this.base=t,this.args=new Array,this.paths=new Array}return E.default(e,[{key:"pathSegment",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"queryParam",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}();function te(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}var ne=function(e){I.default(n,e);var t=te(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return C.default(this,n),(r=t.call(this)).name=r.constructor.name,r.message="".concat(e," (status: ").concat(i,", code: ").concat(a,")"),r.status=i,r.code=a,r}return n}(U.default(Error)),re=function(e){I.default(n,e);var t=te(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3?arguments[3]:void 0;return C.default(this,n),(r=t.call(this,e,i,a)).body=s,r}return n}(ne);function ie(e){return JSON.parse(JSON.stringify(e))}function ae(e){if(!(void 0===e||se(e)))throw new ne("Invalid pageSize parameter. Expected a positive integer, was '".concat(e,"'."),400,20007)}function se(e){return function(e){return!isNaN(parseInt(e))&&isFinite(e)}(e)&&e>0}var oe=j.getLogger("twilio-sync");function ue(e,t){return["".concat((new Date).toISOString()," Sync ").concat(e,":")].concat(Array.from(t))}var ce=function(e){oe.setLevel(e)},le=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];oe.trace.apply(null,ue("T",t))},de=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];oe.debug.apply(null,ue("D",t))},fe=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];oe.warn.apply(null,ue("W",t))},pe=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];oe.error.apply(null,ue("E",t))};function he(e,t,n){return e&&void 0!==e[t]?e[t]:n}var ve=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};C.default(this,e);var n=t.region||"us1",r="https://cds.".concat(n,".twilio.com"),i=t.cdsUri||r;this.settings={subscriptionsUri:i+"/v4/Subscriptions",documentsUri:i+"/v3/Documents",listsUri:i+"/v3/Lists",mapsUri:i+"/v3/Maps",streamsUri:i+"/v3/Streams",insightsUri:i+"/v3/Insights",sessionStorageEnabled:he(t.Sync,"enableSessionStorage",!0),productId:t.productId}}return E.default(e,[{key:"subscriptionsUri",get:function(){return this.settings.subscriptionsUri}},{key:"documentsUri",get:function(){return this.settings.documentsUri}},{key:"listsUri",get:function(){return this.settings.listsUri}},{key:"mapsUri",get:function(){return this.settings.mapsUri}},{key:"streamsUri",get:function(){return this.settings.streamsUri}},{key:"insightsUri",get:function(){return this.settings.insightsUri}},{key:"backoffConfig",get:function(){return this.settings.backoffConfig||{}}},{key:"sessionStorageEnabled",get:function(){return this.settings.sessionStorageEnabled}},{key:"productId",get:function(){return this.settings.productId}}]),e}();function ye(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return me(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return me(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function me(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ge=function(){function e(t){C.default(this,e),this.localObject=t,this.pendingCorrelationId=null,this.pendingAction=null,this.established=!1,this.retryCount=0}return E.default(e,[{key:"sid",get:function(){return this.localObject.sid}},{key:"type",get:function(){return this.localObject.type}},{key:"lastEventId",get:function(){return this.localObject.lastEventId}},{key:"indexName",get:function(){return this.localObject.indexName}},{key:"queryString",get:function(){return this.localObject.queryString}},{key:"isEstablished",get:function(){return this.established}},{key:"update",value:function(e,t){this.localObject._update(e,t)}},{key:"updatePending",value:function(e,t){this.pendingAction=e,this.pendingCorrelationId=t}},{key:"reset",value:function(){this.updatePending(null,null),this.retryCount=0,this.established=!1,this.setSubscriptionState("none")}},{key:"markAsFailed",value:function(e){this.rejectedWithError=e.error,this.updatePending(null,null),this.localObject.reportFailure(new ne("Failed to subscribe on service events: ".concat(e.error.message),e.error.status,e.error.code))}},{key:"complete",value:function(e){this.updatePending(null,null),this.established=!0,this.localObject._advanceLastEventId(e)}},{key:"setSubscriptionState",value:function(e){this.localObject._setSubscriptionState(e)}}]),e}(),be=function(){function e(t){var n=this;C.default(this,e),A.default(this,"isConnected",!1),A.default(this,"maxBatchSize",100),A.default(this,"subscriptionTtlTimer",null),A.default(this,"pendingPokeReason",null),this.services=t,this.subscriptions=new Map,this.persisted=new Map,this.latestPokeResponseArrivalTimestampByCorrelationId=new Map;this.backoff=g.Backoff.exponential(Object.assign({randomisationFactor:.2,initialDelay:100,maxDelay:12e4},this.services.config.backoffConfig)),this.backoff.on("ready",(function(){var e=n.getSubscriptionUpdateBatch(),t=e.action,r=e.subscriptions;t?n.applyNewSubscriptionUpdateBatch(t,r):(n.backoff.reset(),de("All subscriptions resolved."))}))}var t;return E.default(e,[{key:"getSubscriptionUpdateBatch",value:function(){function e(e,t,n,r){var i,a=[],s=ye(e);try{for(s.s();!(i=s.n()).done;){var o=N.default(i.value,2),u=o[0],c=o[1];if(!t.get(u)&&n!==c.pendingAction&&!c.rejectedWithError&&(a.push(c),r&&a.length>=r))break}}catch(e){s.e(e)}finally{s.f()}return a}var t=e(this.subscriptions,this.persisted,"establish",this.maxBatchSize);if(t.length>0)return{action:"establish",subscriptions:t};var n=e(this.persisted,this.subscriptions,"cancel",this.maxBatchSize);return n.length>0?{action:"cancel",subscriptions:n}:{action:null,subscriptions:null}}},{key:"persist",value:function(){this.backoff.backoff()}},{key:"applyNewSubscriptionUpdateBatch",value:(t=S.default(O.default.mark((function e(t,n){var r,i,a,s,o,u,c,l,d,f,p,v,y=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isConnected){e.next=4;break}return de("Twilsock connection (required for subscription) not ready; waiting…"),this.backoff.reset(),e.abrupt("return");case 4:n=this.processLocalActions(t,n),r=(new Date).getTime(),i=ye(n);try{for(i.s();!(a=i.n()).done;)s=a.value,this.recordActionAttemptOn(s,t,r)}catch(e){i.e(e)}finally{i.f()}return o=this.pendingPokeReason,this.pendingPokeReason=null,e.prev=10,e.next=13,this.request(t,r,o,n);case 13:u=e.sent,c=u.body.max_batch_size,!isNaN(parseInt(c))&&isFinite(c)&&c>0&&(this.maxBatchSize=c),this.subscriptionTtlTimer||(l=u.body.ttl_in_s,!isNaN(parseFloat(l))&&isFinite(l)&&l>0&&(this.subscriptionTtlTimer=setTimeout((function(){return y.onSubscriptionTtlElapsed()}),1e3*l))),"establish"===t&&(d=u.body.estimated_delivery_in_ms,!isNaN(parseFloat(d))&&isFinite(d)&&d>0?setTimeout((function(){return y.verifyPokeDelivery(r,d,n)}),d):pe("Invalid timeout: ".concat(d)),n.filter((function(e){return e.pendingCorrelationId===r})).forEach((function(e){return e.setSubscriptionState("response_in_flight")}))),this.backoff.reset(),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(10),f=ye(n);try{for(f.s();!(p=f.n()).done;)v=p.value,this.recordActionFailureOn(v,t)}catch(e){f.e(e)}finally{f.f()}e.t0 instanceof h.TransportUnavailableError?(de("Twilsock connection (required for subscription) not ready (c:".concat(r,"); waiting…")),this.backoff.reset()):(de("Failed an attempt to ".concat(t," subscriptions (c:").concat(r,"); retrying"),e.t0),this.persist());case 26:case"end":return e.stop()}}),e,this,[[10,21]])}))),function(e,n){return t.apply(this,arguments)})},{key:"verifyPokeDelivery",value:function(e,t,n){var r=this,i=this.latestPokeResponseArrivalTimestampByCorrelationId.get(e),a=i?(new Date).getTime()-i:t;a>=t?(n.filter((function(t){return t.pendingCorrelationId===e})).forEach((function(e){e.updatePending(null,null),e.retryCount++,r.persisted.delete(e.sid)})),this.persist(),this.latestPokeResponseArrivalTimestampByCorrelationId.delete(e)):setTimeout((function(){return r.verifyPokeDelivery(e,t,n)}),t-a)}},{key:"processLocalActions",value:function(e,t){return"cancel"===e?t.filter((function(e){return!e.rejectedWithError})):t}},{key:"recordActionAttemptOn",value:function(e,t,n){if(e.setSubscriptionState("request_in_flight"),"establish"===t)this.persisted.set(e.sid,e),e.updatePending(t,n);else{var r=this.persisted.get(e.sid);r&&r.updatePending(t,n)}}},{key:"recordActionFailureOn",value:function(e,t){e.setSubscriptionState("none"),e.updatePending(null,null),"establish"===t&&this.persisted.delete(e.sid)}},{key:"request",value:function(e,t,n,r){var i=r.map((function(t){return{object_sid:t.sid,object_type:t.type,last_event_id:"establish"===e?t.lastEventId:void 0,index_name:"establish"===e?t.indexName:void 0,query_string:"establish"===e?t.queryString:void 0}})),a=r.filter((function(e){return e.retryCount>0})).length;de("Attempting '".concat(e,"' request (c:").concat(t,"):"),i);var s={event_protocol_version:4,action:e,correlation_id:t,retried_requests:a,ttl_in_s:-1,requests:i};return"ttl"===n&&(s.reason=n),this.services.network.post(this.services.config.subscriptionsUri,s)}},{key:"add",value:function(e,t){de("Establishing intent to subscribe to ".concat(e));var n=this.subscriptions.get(e);n&&t&&n.lastEventId===t.lastEventId||(this.persisted.delete(e),this.subscriptions.set(e,new ge(t)),this.persist())}},{key:"remove",value:function(e){de("Establishing intent to unsubscribe from ".concat(e)),this.subscriptions.delete(e)&&this.persist()}},{key:"acceptMessage",value:function(e,t){le("Subscriptions received",e);var n=e.event_type,r=void 0!==e.events?e.events:[e.event],i=e.correlation_id;i&&this.latestPokeResponseArrivalTimestampByCorrelationId.set(i,(new Date).getTime());var a,s=ye(r);try{for(s.s();!(a=s.n()).done;){var o=a.value,u=void 0;switch(e.event_type){case"subscription_established":this.applySubscriptionEstablishedMessage(o,i);break;case"subscription_canceled":this.applySubscriptionCancelledMessage(o,i);break;case"subscription_failed":this.applySubscriptionFailedMessage(o,i);break;case(u=n.match(/^(?:map|list|document|stream|live_query)_/)||{}).input:var c=void 0;switch(u[0]){case"map_":c=o.map_sid;break;case"list_":c=o.list_sid;break;case"document_":c=o.document_sid;break;case"stream_":c=o.stream_sid;break;case"live_query_":c=o.query_id,t=!1,!0===e.strictly_ordered&&(t=!0);break;default:c=void 0}this.applyEventToSubscribedEntity(c,o,n,t);break;default:de("Dropping unknown message type ".concat(n))}}}catch(e){s.e(e)}finally{s.f()}}},{key:"applySubscriptionEstablishedMessage",value:function(e,t){var n=e.object_sid,r=this.persisted.get(e.object_sid);r&&r.pendingCorrelationId===t?"interrupted"===e.replay_status?(de("Event Replay for subscription to ".concat(n," (c:").concat(t,") interrupted; continuing eagerly.")),r.updatePending(null,null),this.persisted.delete(r.sid),this.backoff.reset()):"completed"===e.replay_status&&(de("Event Replay for subscription to ".concat(n," (c:").concat(t,") completed. Subscription is ready.")),r.complete(e.last_event_id),this.persisted.set(e.object_sid,r),r.setSubscriptionState("established"),this.backoff.reset()):de("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionCancelledMessage",value:function(e,t){var n=this.persisted.get(e.object_sid);n&&n.pendingCorrelationId===t?(n.updatePending(null,null),n.setSubscriptionState("none"),this.persisted.delete(e.object_sid)):de("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionFailedMessage",value:function(e,t){var n=e.object_sid,r=this.subscriptions.get(n),i=this.persisted.get(n);r&&i?i.pendingCorrelationId===t&&(pe("Failed to subscribe on ".concat(i.sid),e.error),i.markAsFailed(e),i.setSubscriptionState("none")):!r&&i&&(this.persisted.delete(n),i.setSubscriptionState("none")),this.persist()}},{key:"applyEventToSubscribedEntity",value:function(e,t,n,r){if(e){var i;r=r||(i=this.persisted.get(e))&&i.isEstablished;var a=this.subscriptions.get(e);a?(t.type=n,a.update(t,r)):de("Message dropped for SID '".concat(e,"', for which there is no subscription."))}}},{key:"onConnectionStateChanged",value:function(e){this.isConnected=e,e&&this.poke("reconnect")}},{key:"onSubscriptionTtlElapsed",value:function(){this.isConnected&&this.poke("ttl")}},{key:"poke",value:function(e){de("Triggering event replay for all subscriptions, reason=".concat(e)),this.pendingPokeReason=e,this.subscriptionTtlTimer&&(clearTimeout(this.subscriptionTtlTimer),this.subscriptionTtlTimer=null);var t,n=[],r=ye(this.persisted.values());try{for(r.s();!(t=r.n()).done;){var i=t.value;i.reset(),i.rejectedWithError&&n.push(i)}}catch(e){r.e(e)}finally{r.f()}this.persisted.clear();for(var a=0,s=n;a<s.length;a++){var o=s[a];this.persisted.set(o.sid,o)}this.persist()}},{key:"shutdown",value:function(){this.backoff.reset(),this.subscriptions.clear()}}]),e}();function ke(e){if(e.body&&e.body.message)return e.body.message;switch(e.status){case 429:return"Throttled by server";case 404:return"Not found from server";default:return"Error from server"}}function we(e){return e.body?e.body.code:0}function _e(e){return 409===e.status?new re(ke(e),e.status,we(e),e.body):e.status?new ne(ke(e),e.status,we(e)):e instanceof h.TransportUnavailableError?e:new ne(e.message,0,0)}var xe=function(){function e(t,n,r){C.default(this,e),this.clientInfo=t,this.config=n,this.transport=r}return E.default(e,[{key:"createHeaders",value:function(){return{"Content-Type":"application/json","Twilio-Sync-Client-Info":JSON.stringify(this.clientInfo),"Twilio-Request-Id":"RQ"+L.v4().replace(/-/g,"")}}},{key:"backoffConfig",value:function(){return Object.assign({min:4e3,max:6e4,maxAttemptsTime:9e4,randomness:.2},this.config.backoffConfig)}},{key:"executeWithRetry",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var s=new g.Retrier(t.backoffConfig());s.on("attempt",(function(){e().then((function(e){return s.succeeded(e)})).catch((function(e){if(a.includes(e.status)){var t=parseInt(e.headers?e.headers["Retry-After"]:null);s.failed(_e(e),isNaN(t)?null:1e3*t)}else"Twilsock disconnected"===e.message?s.failed(_e(e)):(s.removeAllListeners(),s.cancel(),i(_e(e)))}))})),s.on("succeeded",(function(e){r(e)})),s.on("cancelled",(function(e){return i(_e(e))})),s.on("failed",(function(e){return i(_e(e))})),s.start()}))}},{key:"get",value:function(e){var t=this,n=this.createHeaders();return de("GET",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry((function(){return t.transport.get(e,n,t.config.productId)}),!0)}},{key:"post",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=this.createHeaders();return null!=n&&(a["If-Match"]=n),de("POST",e,"ID:",a["Twilio-Request-Id"]),this.executeWithRetry((function(){return r.transport.post(e,a,t,r.config.productId)}),i)}},{key:"put",value:function(e,t,n){var r=this,i=this.createHeaders();return null!=n&&(i["If-Match"]=n),de("PUT",e,"ID:",i["Twilio-Request-Id"]),this.executeWithRetry((function(){return r.transport.put(e,i,t,r.config.productId)}),!1)}},{key:"delete",value:function(e){var t=this,n=this.createHeaders();return de("DELETE",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry((function(){return t.transport.delete(e,n,t.config.productId)}),!1)}}]),e}(),Se=function(){function e(t,n){C.default(this,e),this.config=t,this.storageId=null;try{this.storage=n||sessionStorage}catch(e){}}return E.default(e,[{key:"storageKey",value:function(e,t){return"".concat(this.storageId,"::").concat(e,"::").concat(t)}},{key:"isReady",get:function(){return this.config.sessionStorageEnabled&&!!this.storageId}},{key:"updateStorageId",value:function(e){this.storageId=e}},{key:"store",value:function(e,t,n){return this.isReady?this._store(this.storageKey(e,t),n):null}},{key:"read",value:function(e,t){return this.isReady?this._read(this.storageKey(e,t)):null}},{key:"remove",value:function(e,t,n){if(!this.isReady)return null;try{this.storage.removeItem(this.storageKey(e,t)),n&&this.storage.removeItem(this.storageKey(e,n))}catch(e){}}},{key:"update",value:function(e,t,n,r){if(!this.isReady)return null;this._apply(this.storageKey(e,t),r),n&&this._apply(this.storageKey(e,n),r)}},{key:"_store",value:function(e,t){try{this.storage.setItem(e,JSON.stringify(t))}catch(e){}}},{key:"_read",value:function(e){try{var t=this.storage.getItem(e);if(t)return JSON.parse(t)}catch(e){}return null}},{key:"_apply",value:function(e,t){var n=this._read(e);if(!n)return!1;this._store(e,Object.assign(n,t))}}]),e}();function Ce(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ee(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ee(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function Ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Re=function(){function e(t,n){C.default(this,e),this.services=t,this.removalHandler=n,this.subscriptionState="none",this._attachedListeners=new Map}return E.default(e,[{key:"_advanceLastEventId",value:function(e,t){}},{key:"reportFailure",value:function(e){404===e.status?this.onRemoved(!1):this.broadcastEventToListeners("failure",e)}},{key:"_subscribe",value:function(){this.services.router._subscribe(this.sid,this)}},{key:"_unsubscribe",value:function(){this.services.router._unsubscribe(this.sid)}},{key:"_setSubscriptionState",value:function(e){this.subscriptionState=e,this.broadcastEventToListeners("_subscriptionStateChanged",e)}},{key:"close",value:function(){this._unsubscribe(),null!=this.removalHandler&&this.removalHandler(this.type,this.sid,this.uniqueName)}},{key:"attach",value:function(e){var t=e.listenerUuid;this._attachedListeners.get(t)||(this._attachedListeners.size||this._subscribe(),this._attachedListeners.set(t,e))}},{key:"detach",value:function(e){this._attachedListeners.delete(e),this._attachedListeners.size||this.close()}},{key:"broadcastEventToListeners",value:function(e,t){var n,r=Ce(this._attachedListeners.values());try{for(r.s();!(n=r.n()).done;){n.value.emit(e,t)}}catch(e){r.e(e)}finally{r.f()}}}]),e}(),Ie=function(){function e(t){C.default(this,e),A.default(this,"queuedRequests",[]),A.default(this,"isRequestInFlight",!1),this.inputMergingFunction=t}return E.default(e,[{key:"add",value:function(e,t){var n=this,r=new Promise((function(r,i){return n.queuedRequests.push({input:e,requestFunction:t,resolve:r,reject:i})}));return this.wakeupQueue(),r}},{key:"squashAndAdd",value:function(e,t){var n,r=this.queuedRequests;this.queuedRequests=[],r.length>0?(n=r.map((function(e){return e.input})).reduce(this.inputMergingFunction),n=this.inputMergingFunction(n,e)):n=e;var i=this.add(n,t);return r.forEach((function(e){return i.then(e.resolve,e.reject)})),i}},{key:"isEmpty",value:function(){return 0===this.queuedRequests.length&&!this.isRequestInFlight}},{key:"wakeupQueue",value:function(){var e=this;if(0!==this.queuedRequests.length&&!this.isRequestInFlight){var t=this.queuedRequests.shift();this.isRequestInFlight=!0,t.requestFunction(t.input).then(t.resolve,t.reject).then((function(t){e.isRequestInFlight=!1,e.wakeupQueue()}))}}}]),e}(),Te=function(){function e(t){C.default(this,e),A.default(this,"queueByNamespaceKey",new Map),this.inputReducer=t}var t,n,r;return E.default(e,[{key:"add",value:(r=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,(function(e){return e.add(n,r)})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"squashAndAdd",value:(n=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,(function(e){return e.squashAndAdd(n,r)})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"invokeQueueMethod",value:(t=S.default(O.default.mark((function e(t,n){var r,i;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.queueByNamespaceKey.has(t)||this.queueByNamespaceKey.set(t,new Ie(this.inputReducer)),r=this.queueByNamespaceKey.get(t),i=n(r),this.queueByNamespaceKey.get(t).isEmpty()&&this.queueByNamespaceKey.delete(t),e.abrupt("return",i);case 5:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})}]),e}();function Pe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}var Ae=function(e){I.default(n,e);var t=Pe(n);function n(){var e;return C.default(this,n),(e=t.call(this)).closed=!1,e.uuid=b.v4(),e}return E.default(n,[{key:"listenerUuid",get:function(){return this.uuid}},{key:"close",value:function(){this.removeAllListeners(),this.closed=!0}},{key:"ensureNotClosed",value:function(){if(this.closed)throw new Error("Invalid operation on closed object")}}]),n}(J);function Oe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}var Me=function(e){I.default(d,e);var t,n,r,i,a,s,o,u,c,l=Oe(d);function d(e,t,n){var r;C.default(this,d),r=l.call(this,e,n),A.default(R.default(r),"isDeleted",!1);return r.updateMergingQueue=new Ie((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.descriptor=t,r.descriptor.data=r.descriptor.data||{},r.descriptor.date_updated=new Date(r.descriptor.date_updated),r}return E.default(d,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"document"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"_update",value:function(e){switch(e.date_created=new Date(e.date_created),e.type){case"document_updated":if(e.id<=this.lastEventId){le("Document update skipped, current:",this.lastEventId,", remote:",e.id);break}var t=void 0!==this.descriptor.data?ie(this.descriptor.data):null;this.descriptor.last_event_id=e.id,this.descriptor.revision=e.document_revision,this.descriptor.date_updated=e.date_created,this.descriptor.data=e.document_data,this.broadcastEventToListeners("updated",{data:e.document_data,isLocal:!1,previousData:t}),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.id,revision:e.document_revision,date_updated:e.date_created,data:e.document_data});break;case"document_removed":this.onRemoved(!1)}}},{key:"set",value:(c=S.default(O.default.mark((function e(t,n){var r,i=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(r,(function(e){return i._setUnconditionally(t,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"mutate",value:(u=S.default(O.default.mark((function e(t,n){var r,i=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},e.abrupt("return",this.updateMergingQueue.add(r,(function(e){return i._setWithIfMatch(t,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"update",value:(o=S.default(O.default.mark((function e(t,n){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate((function(e){return Object.assign(e,t)}),n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"setTtl",value:(s=S.default(O.default.mark((function e(t){var n;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({ttl:t});case 2:n=e.sent,this.descriptor.date_expires=n.date_expires;case 4:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"_setUnconditionally",value:(a=S.default(O.default.mark((function e(t,n){var r;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({data:t,revision:void 0,ttl:n});case 2:return r=e.sent,this._handleSuccessfulUpdateResult(r),e.abrupt("return",this.descriptor.data);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"_setWithIfMatch",value:(i=S.default(O.default.mark((function e(t,n){var r,i,a;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=t(ie(this.descriptor.data)))){e.next=22;break}return i=this.revision,e.prev=3,e.next=6,this._postUpdateToServer({data:r,revision:i,ttl:n});case 6:return a=e.sent,this._handleSuccessfulUpdateResult(a),e.abrupt("return",this.descriptor.data);case 11:if(e.prev=11,e.t0=e.catch(3),412!==e.t0.status){e.next=19;break}return e.next=16,this._softSync();case 16:return e.abrupt("return",this._setWithIfMatch(t));case 19:throw e.t0;case 20:e.next=23;break;case 22:return e.abrupt("return",this.descriptor.data);case 23:case"end":return e.stop()}}),e,this,[[3,11]])}))),function(e,t){return i.apply(this,arguments)})},{key:"_handleSuccessfulUpdateResult",value:function(e){if(!(e.last_event_id<=this.descriptor.last_event_id)){var t=void 0!==this.descriptor.data?ie(this.descriptor.data):null;this.descriptor.revision=e.revision,this.descriptor.data=e.data,this.descriptor.last_event_id=e.last_event_id,this.descriptor.date_expires=e.date_expires,this.descriptor.date_updated=new Date(e.date_updated),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.last_event_id,revision:e.revision,date_updated:e.date_updated,data:e.data}),this.broadcastEventToListeners("updated",{data:this.descriptor.data,isLocal:!0,previousData:t})}}},{key:"_postUpdateToServer",value:(r=S.default(O.default.mark((function e(t){var n,r,i;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=17;break}return n={data:t.data},void 0!==t.ttl&&(n.ttl=t.ttl),r=t.revision,e.prev=4,e.next=7,this.services.network.post(this.uri,n,r);case 7:return i=e.sent,e.abrupt("return",{revision:i.body.revision,data:t.data,last_event_id:i.body.last_event_id,date_updated:i.body.date_updated,date_expires:i.body.date_expires});case 11:throw e.prev=11,e.t0=e.catch(4),404===e.t0.status&&this.onRemoved(!1),e.t0;case 15:e.next=18;break;case 17:return e.abrupt("return",Promise.reject(new ne("The Document has been removed",404,54100)));case 18:case"end":return e.stop()}}),e,this,[[4,11]])}))),function(e){return r.apply(this,arguments)})},{key:"_softSync",value:(n=S.default(O.default.mark((function e(){var t=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.network.get(this.uri).then((function(e){var n={type:"document_updated",id:e.body.last_event_id,document_revision:e.body.revision,document_data:e.body.data,date_created:e.body.date_updated};return t._update(n),t})).catch((function(e){404===e.status?t.onRemoved(!1):pe("Can't get updates for ".concat(t.sid,":"),e)})));case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onRemoved",value:function(e){if(!this.isDeleted){var t=void 0!==this.descriptor.data?ie(this.descriptor.data):null;this.isDeleted=!0,this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e,previousData:t})}}},{key:"removeDocument",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=6;break}return e.next=3,this.services.network.delete(this.uri);case 3:this.onRemoved(!0),e.next=7;break;case 6:return e.abrupt("return",Promise.reject(new ne("The Document has been removed",404,54100)));case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"type",get:function(){return"document"}}]),d}(Re),Ue=function(e){I.default(o,e);var t,n,r,i,a,s=Oe(o);function o(e){var t;return C.default(this,o),(t=s.call(this)).syncDocumentImpl=e,t.syncDocumentImpl.attach(R.default(t)),t}return E.default(o,[{key:"uri",get:function(){return this.syncDocumentImpl.uri}},{key:"revision",get:function(){return this.syncDocumentImpl.revision}},{key:"lastEventId",get:function(){return this.syncDocumentImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncDocumentImpl.dateExpires}},{key:"type",get:function(){return Me.type}},{key:"sid",get:function(){return this.syncDocumentImpl.sid}},{key:"data",get:function(){return this.syncDocumentImpl.data}},{key:"dateUpdated",get:function(){return this.syncDocumentImpl.dateUpdated}},{key:"uniqueName",get:function(){return this.syncDocumentImpl.uniqueName}},{key:"set",value:(a=S.default(O.default.mark((function e(t,n){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.set(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"mutate",value:(i=S.default(O.default.mark((function e(t,n){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.mutate(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"update",value:(r=S.default(O.default.mark((function e(t,n){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.update(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"setTtl",value:(n=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"removeDocument",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.removeDocument());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){D.default(P.default(o.prototype),"close",this).call(this),this.syncDocumentImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return Me.type}}]),o}(Ae);A.default(Ue,"removed","removed"),A.default(Ue,"updated","updated"),B([p.validateTypesAsync(p.pureObject,["undefined",p.objectSchema("document metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object,Object]),q("design:returntype",Promise)],Ue.prototype,"set",null),B([p.validateTypesAsync("function",["undefined",p.objectSchema("document metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Function,Object]),q("design:returntype",Promise)],Ue.prototype,"mutate",null),B([p.validateTypesAsync(p.pureObject,["undefined",p.objectSchema("document metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object,Object]),q("design:returntype",Promise)],Ue.prototype,"update",null),B([p.validateTypesAsync(p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],Ue.prototype,"setTtl",null);var je=function(){function e(t){C.default(this,e),this.descriptor=t}return E.default(e,[{key:"uri",get:function(){return this.descriptor.uri}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.lastEventId}},{key:"dateUpdated",get:function(){return this.descriptor.dateUpdated}},{key:"dateExpires",get:function(){return this.descriptor.dateExpires}},{key:"index",get:function(){return this.descriptor.index}},{key:"data",get:function(){return this.descriptor.data}},{key:"update",value:function(e,t,n,r){return this.descriptor.lastEventId=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.dateUpdated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.dateExpires=e}}]),e}(),Ne=function(){function e(t,n,r,i){C.default(this,e),this.prevToken=r,this.nextToken=i,this.items=t,this.source=n}var t,n;return E.default(e,[{key:"hasNextPage",get:function(){return!!this.nextToken}},{key:"hasPrevPage",get:function(){return!!this.prevToken}},{key:"nextPage",value:(n=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasNextPage){e.next=2;break}throw new Error("No next page");case 2:return e.abrupt("return",this.source(this.nextToken));case 3:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"prevPage",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPrevPage){e.next=2;break}throw new Error("No previous page");case 2:return e.abrupt("return",this.source(this.prevToken));case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}();function Le(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return De(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return De(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function De(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Fe=function(){function e(t,n){C.default(this,e),this.balanceFactor=0,this.key=t,this.value=n,this.parent=null,this.left=null,this.right=null}return E.default(e,[{key:"isRoot",get:function(){return null===this.parent}},{key:"isLeaf",get:function(){return null===this.left&&null===this.right}},{key:"isLeftChild",get:function(){return this.parent.left===this}},{key:"update",value:function(e){this.value=e}},{key:"replace",value:function(e,t){e&&(this.left===t?this.left=t:this.right===t&&(this.right=t))}}]),e}(),Be=function(){function e(t,n){C.default(this,e),this.isLessThan=t||function(e,t){return e<t},this.isEqual=n||function(e,t){return e===t},this.root=null,this.count=null}return E.default(e,[{key:"size",get:function(){return this.count}},{key:"clear",value:function(){this.root=null,this.count=0}},{key:"set",value:function(e,t){var n=this.getNode(e);n?n.update(t):this.insert(e,t)}},{key:"insert",value:function(e,t){var n=new Fe(e,t);if(this.count++,this.root){for(var r=this.root;;)if(this.isLessThan(e,r.key)){if(!r.left){r.left=n;break}r=r.left}else{if(!r.right){r.right=n;break}r=r.right}for(n.parent=r,r=n;r.parent;){var i=r.parent,a=i.balanceFactor;if(r.isLeftChild?i.balanceFactor++:i.balanceFactor--,Math.abs(i.balanceFactor)<Math.abs(a))break;if(i.balanceFactor<-1||i.balanceFactor>1){this.rebalance(i);break}r=i}}else this.root=n}},{key:"get",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t.value;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"delete",value:function(e){var t=this.getNode(e);if(!t||t.key!==e)return null;var n=t.parent,r=t.left,i=t.right;if(!!r!=!!i){var a=r||i;n||a?n&&!a?this.root=a:(n.replace(t,null),this.rebalance(n)):this.root=null}else{for(var s=t.left;s.right;)s=s.right;if(t.left===s)t.isRoot?(this.root=s,s.parent=null):(t.isLeftChild?t.parent.left=s:t.parent.right=s,s.parent=t.parent),s.right=t.right,s.right.parent=s,s.balanceFactor=t.balanceFactor,t={parent:s,isLeftChild:!0};else{var o=s.parent,u=s.left;o.right=u,u&&(u.parent=o),t.isRoot?(this.root=s,s.parent=null):(t.isLeftChild?t.parent.left=s:t.parent.right=s,s.parent=t.parent),s.right=t.right,s.right.parent=s,s.left=t.left,s.left.parent=s,s.balanceFactor=t.balanceFactor,t={parent:o,isLeftChild:!1}}}for(this.count--;t.parent;){var c=t.parent,l=c.balanceFactor;if(t.isLeftChild?c.balanceFactor-=1:c.balanceFactor+=1,Math.abs(c.balanceFactor)>Math.abs(l)){if(!(c.balanceFactor<-1||c.balanceFactor>1))break;if(this.rebalance(c),0!==c.parent.balanceFactor)break;t=c.parent}else t=c}return null}},{key:"getNode",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"rebalance",value:function(e){e.balanceFactor<0?e.right.balanceFactor>0?(this.rotateRight(e.right),this.rotateLeft(e)):this.rotateLeft(e):e.balanceFactor>0&&(e.left.balanceFactor<0?(this.rotateLeft(e.left),this.rotateRight(e)):this.rotateRight(e))}},{key:"rotateLeft",value:function(e){var t=e.right;e.right=t.left,null!==t.left&&(t.left.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.left=e,e.parent=t,e.balanceFactor=e.balanceFactor+1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor+1-Math.max(e.balanceFactor,0)}},{key:"rotateRight",value:function(e){var t=e.left;e.left=t.right,null!==t.right&&(t.right.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.right=e,e.parent=t,e.balanceFactor=e.balanceFactor-1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor-1-Math.max(e.balanceFactor,0)}},{key:Symbol.iterator,value:O.default.mark((function e(){var t,n,r;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=Le(this.getIterator()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,r;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"getIterator",value:O.default.mark((function e(){var t,n,r,i=arguments;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=i.length>0&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(!n){e.next=8;break}if(!this.isEqual(t,n.key)&&(null!==t||n.left)){e.next=5;break}return e.abrupt("break",8);case 5:n=this.isLessThan(t,n.key)||null===t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(!r){e.next=29;break}return e.next=14,[n.key,n.value];case 14:if(r=!1,!n.right){e.next=21;break}for(n=n.right;n.left;)n=n.left;r=!0,e.next=27;break;case 21:if(!n.parent){e.next=26;break}r=n.parent.left===n,n=n.parent,e.next=27;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:if(!n.parent){e.next=34;break}r=n.parent.left===n,n=n.parent,e.next=35;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}}),e,this)}))},{key:"getReverseIterator",value:O.default.mark((function e(){var t,n,r,i=arguments;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=i.length>0&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(!n){e.next=8;break}if(!this.isEqual(t,n.key)&&(null!==t||n.right)){e.next=5;break}return e.abrupt("break",8);case 5:n=this.isLessThan(t,n.key)&&null!==t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(!r){e.next=29;break}return e.next=14,[n.key,n.value];case 14:if(r=!1,!n.left){e.next=21;break}for(n=n.left;n.right;)n=n.right;r=!0,e.next=27;break;case 21:if(!n.parent){e.next=26;break}r=n.parent.right===n,n=n.parent,e.next=27;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:if(!n.parent){e.next=34;break}r=n.parent.right===n,n=n.parent,e.next=35;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}}),e,this)}))}]),e}();function qe(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ze(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ze(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}function ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Je=function(){function e(t,n){C.default(this,e),this.value=t,this.revision=n||0}return E.default(e,[{key:"isValid",get:function(){return!0}}]),e}(),We=function(){function e(t){C.default(this,e),this.revision=t}return E.default(e,[{key:"isValid",get:function(){return!1}}]),e}(),Ye=function(){function e(){C.default(this,e),this.items=new Be}return E.default(e,[{key:"store",value:function(e,t,n){var r=this.items.get(e);return r&&r.revision>n?r.isValid?r.value:null:(this.items.set(e,new Je(t,n)),t)}},{key:"delete",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.items.get(e);(!r||r.revision<t||r&&!0===n)&&this.items.set(e,new We(t))}},{key:"isKnown",value:function(e,t){var n=this.items.get(e);return n&&n.revision>=t}},{key:"get",value:function(e){var t=this.items.get(e);return t&&t.isValid?t.value:null}},{key:"has",value:function(e){var t=this.items.get(e);return t&&t.isValid}},{key:"forEach",value:function(e){if(this.items){var t,n=qe(this.items);try{for(n.s();!(t=n.n()).done;){var r=N.default(t.value,2),i=r[0],a=r[1];a.isValid&&e(i,a.value)}}catch(e){n.e(e)}finally{n.f()}}}}]),e}();function He(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}var Qe=function(e){I.default(y,e);var t,n,r,i,a,s,o,u,c,l,d,f,p,h,v=He(y);function y(e,t,n){var r;C.default(this,y);return(r=v.call(this,e,n)).updateMergingQueue=new Te((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.cache=new Ye,r.descriptor=t,r.descriptor.date_updated=new Date(r.descriptor.date_updated),r}return E.default(y,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"list"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"_addOrUpdateItemOnServer",value:(h=S.default(O.default.mark((function e(t,n,r,i){var a,s;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a={data:n},void 0!==i&&(a.ttl=i),e.next=4,this.services.network.post(t,a,r);case 4:return(s=e.sent).body.data=n,s.body.date_updated=new Date(s.body.date_updated),e.abrupt("return",s.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return h.apply(this,arguments)})},{key:"push",value:(p=S.default(O.default.mark((function e(t,n){var r,i,a;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(n||{}).ttl,e.next=3,this._addOrUpdateItemOnServer(this.links.items,t,void 0,r);case 3:return i=e.sent,a=Number(i.index),this._handleItemMutated(a,i.url,i.last_event_id,i.revision,t,i.date_updated,i.date_expires,!0,!1),e.abrupt("return",this.cache.get(a));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"set",value:(f=S.default(O.default.mark((function e(t,n,r){var i,a=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,(function(e){return a._updateItemUnconditionally(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"_updateItemUnconditionally",value:(d=S.default(O.default.mark((function e(t,n,r){var i,a;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return i=e.sent,e.next=5,this._addOrUpdateItemOnServer(i.uri,n,void 0,r);case 5:return a=e.sent,this._handleItemMutated(t,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return d.apply(this,arguments)})},{key:"_updateItemWithIfMatch",value:(l=S.default(O.default.mark((function e(t,n,r){var i,a,s,o;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:if(i=e.sent,!(a=n(ie(i.data)))){e.next=25;break}return s=i.revision,e.prev=6,e.next=9,this._addOrUpdateItemOnServer(i.uri,a,s,r);case 9:return o=e.sent,this._handleItemMutated(t,o.url,o.last_event_id,o.revision,o.data,o.date_updated,o.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 14:if(e.prev=14,e.t0=e.catch(6),412!==e.t0.status){e.next=22;break}return e.next=19,this._getItemFromServer(t);case 19:return e.abrupt("return",this._updateItemWithIfMatch(t,n,r));case 22:throw e.t0;case 23:e.next=26;break;case 25:return e.abrupt("return",i);case 26:case"end":return e.stop()}}),e,this,[[6,14]])}))),function(e,t,n){return l.apply(this,arguments)})},{key:"mutate",value:(c=S.default(O.default.mark((function e(t,n,r){var i,a=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.add(t,i,(function(e){return a._updateItemWithIfMatch(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"update",value:(u=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,(function(e){return Object.assign(e,n)}),r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"remove",value:(o=S.default(O.default.mark((function e(t){var n,r,i;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return n=e.sent,r=ie(n.data),e.next=6,this.services.network.delete(n.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,r,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"get",value:function(){var e=S.default(O.default.mark((function e(t){var n;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.cache.get(t))){e.next=5;break}return e.abrupt("return",n);case 5:return e.abrupt("return",this._getItemFromServer(t));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:(s=S.default(O.default.mark((function e(t){var n;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({index:t});case 2:if(!((n=e.sent).items.length<1)){e.next=7;break}throw new ne("No item with index ".concat(t," found"),404,54151);case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"queryItems",value:function(){var e=S.default(O.default.mark((function e(t){var n,r,i,a,s=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new ee(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Index",t.index).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return r=e.sent,i=r.body.items.map((function(e){return e.date_updated=new Date(e.date_updated),s.cache.get(e.index)?s._handleItemMutated(e.index,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):s.cache.store(Number(e.index),new je({index:Number(e.index),uri:e.url,revision:e.revision,lastEventId:e.last_event_id,dateUpdated:e.date_updated,dateExpires:e.date_expires,data:e.data}),e.last_event_id),s.cache.get(e.index)})),a=r.body.meta,e.abrupt("return",new Ne(i,(function(e){return s.queryItems({pageToken:e})}),a.previous_token,a.next_token));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:(a=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ae((t=t||{}).pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getContext",value:(i=S.default(O.default.mark((function e(){var t;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.context){e.next=5;break}return e.next=3,this.services.network.get(this.links.context);case 3:t=e.sent,this._updateContextIfRequired(t.body.data,t.body.last_event_id);case 5:return e.abrupt("return",this.context);case 6:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"setTtl",value:(r=S.default(O.default.mark((function e(t){var n,r;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=S.default(O.default.mark((function e(t,n){var r,i,a;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,i={ttl:n},e.next=6,this.services.network.post(r.uri,i);case 6:a=e.sent,r.updateDateExpires(a.body.date_expires);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeList",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){var n=Number(e.item_index);switch(e.date_created=new Date(e.date_created),e.type){case"list_item_added":case"list_item_updated":this._handleItemMutated(n,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"list_item_added"===e.type,!0);break;case"list_item_removed":this._handleItemRemoved(n,e.id,e.item_data,e.date_created,!0);break;case"list_context_updated":this._handleContextUpdate(e.context_data,e.id,e.date_created);break;case"list_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.list_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,a,s,o,u){if(this.shouldIgnoreEvent(e,n))le("Item ".concat(e," update skipped, current: ").concat(this.lastEventId,", remote: ").concat(n));else{this._updateRootDateUpdated(a);var c=this.cache.get(e);if(!c){var l=new je({index:e,uri:t,lastEventId:n,revision:r,data:i,dateUpdated:a,dateExpires:s});return this.cache.store(e,l,n),void this.emitItemMutationEvent(l,u,o)}var d=ie(c.data);c.update(n,r,i,a),this.cache.store(e,c,n),void 0!==s&&c.updateDateExpires(s),this.emitItemMutationEvent(c,u,!1,d)}}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=n?"itemAdded":"itemUpdated",a={item:e,isLocal:!t};n||(a.previousItemData=r),this.broadcastEventToListeners(i,a)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{index:e,isLocal:!i,previousItemData:n})}},{key:"_handleContextUpdate",value:function(e,t,n){this._updateRootDateUpdated(n),this._updateContextIfRequired(e,t)&&this.broadcastEventToListeners("contextUpdated",{context:e,isLocal:!1})}},{key:"_updateContextIfRequired",value:function(e,t){return!this.contextEventId||t>this.contextEventId?(this.context=e,this.contextEventId=t,!0):(le("Context update skipped, current:",this.lastEventId,", remote:",t),!1)}}],[{key:"type",get:function(){return"list"}}]),y}(Re),Ve=function(e){I.default(p,e);var t,n,r,i,a,s,o,u,c,l,d,f=He(p);function p(e){var t;return C.default(this,p),(t=f.call(this)).syncListImpl=e,t.syncListImpl.attach(R.default(t)),t}return E.default(p,[{key:"uri",get:function(){return this.syncListImpl.uri}},{key:"revision",get:function(){return this.syncListImpl.revision}},{key:"lastEventId",get:function(){return this.syncListImpl.lastEventId}},{key:"links",get:function(){return this.syncListImpl.links}},{key:"dateExpires",get:function(){return this.syncListImpl.dateExpires}},{key:"type",get:function(){return Qe.type}},{key:"sid",get:function(){return this.syncListImpl.sid}},{key:"uniqueName",get:function(){return this.syncListImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncListImpl.dateUpdated}},{key:"push",value:(d=S.default(O.default.mark((function e(t,n){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.push(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"set",value:(l=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.set(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"mutate",value:(c=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.mutate(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"update",value:(u=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.update(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"remove",value:(o=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.remove(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"get",value:(s=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.get(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"getContext",value:(a=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getContext());case 2:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getItems",value:(i=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getItems(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setTtl",value:(r=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=S.default(O.default.mark((function e(t,n){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeList",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.removeList());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){D.default(P.default(p.prototype),"close",this).call(this),this.syncListImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return Qe.type}}]),p}(Ae);A.default(Ve,"itemAdded","itemAdded"),A.default(Ve,"itemUpdated","itemUpdated"),A.default(Ve,"itemRemoved","itemRemoved"),A.default(Ve,"removed","removed"),B([p.validateTypesAsync(p.pureObject,["undefined",p.objectSchema("item metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object,Object]),q("design:returntype",Promise)],Ve.prototype,"push",null),B([p.validateTypesAsync(p.nonNegativeInteger,p.pureObject,["undefined",p.objectSchema("item metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Number,Object,Object]),q("design:returntype",Promise)],Ve.prototype,"set",null),B([p.validateTypesAsync(p.nonNegativeInteger,"function",["undefined",p.objectSchema("item metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Number,Function,Object]),q("design:returntype",Promise)],Ve.prototype,"mutate",null),B([p.validateTypesAsync(p.nonNegativeInteger,p.pureObject,["undefined",p.objectSchema("item metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Number,Object,Object]),q("design:returntype",Promise)],Ve.prototype,"update",null),B([p.validateTypesAsync(p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],Ve.prototype,"remove",null),B([p.validateTypesAsync(p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],Ve.prototype,"get",null),B([p.validateTypesAsync(["undefined",p.objectSchema("query options",{from:[p.nonNegativeInteger,"undefined"],pageSize:[p.custom((function(e){return[se(e),"a positive integer"]})),"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],Ve.prototype,"getItems",null),B([p.validateTypesAsync(p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],Ve.prototype,"setTtl",null),B([p.validateTypesAsync(p.nonNegativeInteger,p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number,Number]),q("design:returntype",Promise)],Ve.prototype,"setItemTtl",null);var Ge=function(){function e(t){C.default(this,e),this.descriptor=t}return E.default(e,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"key",get:function(){return this.descriptor.key}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"update",value:function(e,t,n,r){return this.descriptor.last_event_id=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.date_updated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.date_expires=e}}]),e}();function Ke(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}var $e=function(e){I.default(h,e);var t,n,r,i,a,s,o,u,c,l,d,f,p=Ke(h);function h(e,t,n){var r;C.default(this,h);return(r=p.call(this,e,n)).updateMergingQueue=new Te((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.cache=new Ye,r.descriptor=t,r.descriptor.date_updated=new Date(r.descriptor.date_updated),t.items&&t.items.forEach((function(e){e.date_updated=new Date(e.date_updated),r.cache.store(e.key,new Ge(e),e.last_event_id)})),r}return E.default(h,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"map"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"set",value:(f=S.default(O.default.mark((function e(t,n,r){var i,a=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,(function(e){return a._putItemUnconditionally(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"get",value:function(){var e=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=2;break}throw new ne("SyncMapItem key may not be empty",400,54209);case 2:if(!this.cache.has(t)){e.next=6;break}return e.abrupt("return",this.cache.get(t));case 6:return e.abrupt("return",this._getItemFromServer(t));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:(d=S.default(O.default.mark((function e(t){var n;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({key:t});case 2:if(!((n=e.sent).items.length<1)){e.next=7;break}throw new ne("The specified Map Item does not exist",404,54201);case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"mutate",value:(l=S.default(O.default.mark((function e(t,n,r){var i,a=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.add(t,i,(function(e){return a._putItemWithIfMatch(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"update",value:(c=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,(function(e){return Object.assign(e,n)}),r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"_putItemUnconditionally",value:(u=S.default(O.default.mark((function e(t,n,r){var i,a;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._putItemToServer(t,n,void 0,r);case 2:return i=e.sent,a=i.item,this._handleItemMutated(a.key,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,i.added,!1),e.abrupt("return",this.cache.get(a.key));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"_putItemWithIfMatch",value:(o=S.default(O.default.mark((function e(t,n,r){var i,a,s,o,u;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t).catch((function(e){if(404===e.status)return new Ge({key:t,data:{},last_event_id:-1,revision:"-1",url:null,date_updated:null,date_expires:null});throw e}));case 2:if(i=e.sent,!(a=n(ie(i.data)))){e.next=26;break}return s=i.revision,e.prev=6,e.next=9,this._putItemToServer(t,a,s,r);case 9:return o=e.sent,u=o.item,this._handleItemMutated(u.key,u.url,u.last_event_id,u.revision,u.data,u.date_updated,u.date_expires,o.added,!1),e.abrupt("return",this.cache.get(u.key));case 15:if(e.prev=15,e.t0=e.catch(6),412!==e.t0.status){e.next=23;break}return e.next=20,this._getItemFromServer(t);case 20:return e.abrupt("return",this._putItemWithIfMatch(t,n,r));case 23:throw e.t0;case 24:e.next=27;break;case 26:return e.abrupt("return",i);case 27:case"end":return e.stop()}}),e,this,[[6,15]])}))),function(e,t,n){return o.apply(this,arguments)})},{key:"_putItemToServer",value:(s=S.default(O.default.mark((function e(t,n,r,i){var a,s,o,u,c;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new ee(this.links.items).pathSegment(t).build(),s={data:n},void 0!==i&&(s.ttl=i),e.prev=3,e.next=6,this.services.network.put(a,s,r);case 6:return o=e.sent,(u=o.body).data=n,u.date_updated=new Date(u.date_updated),c=201===o.status.code,e.abrupt("return",{added:c,item:u});case 14:throw e.prev=14,e.t0=e.catch(3),404===e.t0.status&&this.onRemoved(!1),e.t0;case 18:case"end":return e.stop()}}),e,this,[[3,14]])}))),function(e,t,n,r){return s.apply(this,arguments)})},{key:"remove",value:(a=S.default(O.default.mark((function e(t){var n,r,i;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return n=e.sent,r=ie(n.data),e.next=6,this.services.network.delete(n.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,r,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"queryItems",value:function(){var e=S.default(O.default.mark((function e(t){var n,r,i,a,s=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new ee(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Key",t.key).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return r=e.sent,i=r.body.items.map((function(e){return e.date_updated=new Date(e.date_updated),s.cache.get(e.key)?s._handleItemMutated(e.key,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):s.cache.store(e.key,new Ge(e),e.last_event_id),s.cache.get(e.key)})),a=r.body.meta,e.abrupt("return",new Ne(i,(function(e){return s.queryItems({pageToken:e})}),a.previous_token,a.next_token));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:(i=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ae((t=t||{}).pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){switch(e.date_created=new Date(e.date_created),e.type){case"map_item_added":case"map_item_updated":this._handleItemMutated(e.item_key,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"map_item_added"===e.type,!0);break;case"map_item_removed":this._handleItemRemoved(e.item_key,e.id,e.item_data,e.date_created,!0);break;case"map_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.map_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,a,s,o,u){if(this.shouldIgnoreEvent(e,n))le("SyncMapItem ",e," update skipped, current:",this.lastEventId,", remote:",n);else{this._updateRootDateUpdated(a);var c=this.cache.get(e);if(!c){var l=new Ge({key:e,url:t,last_event_id:n,revision:r,data:i,date_updated:a,date_expires:s});return this.cache.store(e,l,n),void this.emitItemMutationEvent(l,u,o)}var d=ie(c.data);c.update(n,r,i,a),this.cache.store(e,c,n),void 0!==s&&c.updateDateExpires(s),this.emitItemMutationEvent(c,u,!1,d)}}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=n?"itemAdded":"itemUpdated",a={item:e,isLocal:!t};n||(a.previousItemData=r),this.broadcastEventToListeners(i,a)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{key:e,isLocal:!i,previousItemData:n})}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"setTtl",value:(r=S.default(O.default.mark((function e(t){var n,r;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=S.default(O.default.mark((function e(t,n){var r,i,a;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,i={ttl:n},e.next=6,this.services.network.post(r.uri,i);case 6:a=e.sent,r.updateDateExpires(a.body.date_expires);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeMap",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"type",get:function(){return"map"}}]),h}(Re),Xe=function(e){I.default(d,e);var t,n,r,i,a,s,o,u,c,l=Ke(d);function d(e){var t;return C.default(this,d),(t=l.call(this)).syncMapImpl=e,t.syncMapImpl.attach(R.default(t)),t}return E.default(d,[{key:"uri",get:function(){return this.syncMapImpl.uri}},{key:"links",get:function(){return this.syncMapImpl.links}},{key:"revision",get:function(){return this.syncMapImpl.revision}},{key:"lastEventId",get:function(){return this.syncMapImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncMapImpl.dateExpires}},{key:"type",get:function(){return $e.type}},{key:"sid",get:function(){return this.syncMapImpl.sid}},{key:"uniqueName",get:function(){return this.syncMapImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncMapImpl.dateUpdated}},{key:"set",value:(c=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.set(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"get",value:(u=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.get(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"mutate",value:(o=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.mutate(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"update",value:(s=S.default(O.default.mark((function e(t,n,r){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.update(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"remove",value:(a=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.remove(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getItems",value:(i=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.getItems(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setTtl",value:(r=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=S.default(O.default.mark((function e(t,n){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeMap",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.next=3,this.syncMapImpl.removeMap();case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){D.default(P.default(d.prototype),"close",this).call(this),this.syncMapImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return $e.type}}]),d}(Ae);function Ze(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}A.default(Xe,"itemAdded","itemAdded"),A.default(Xe,"itemUpdated","itemUpdated"),A.default(Xe,"itemRemoved","itemRemoved"),A.default(Xe,"removed","removed"),B([p.validateTypesAsync("string",p.pureObject,["undefined",p.objectSchema("item metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[String,Object,Object]),q("design:returntype",Promise)],Xe.prototype,"set",null),B([p.validateTypesAsync("string"),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],Xe.prototype,"get",null),B([p.validateTypesAsync("string","function",["undefined",p.objectSchema("item metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[String,Function,Object]),q("design:returntype",Promise)],Xe.prototype,"mutate",null),B([p.validateTypesAsync("string",p.pureObject,["undefined",p.objectSchema("item metadata",{ttl:[p.nonNegativeInteger,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[String,Object,Object]),q("design:returntype",Promise)],Xe.prototype,"update",null),B([p.validateTypesAsync("string"),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],Xe.prototype,"remove",null),B([p.validateTypesAsync(["undefined",p.objectSchema("query options",{from:["string","undefined"],pageSize:[p.custom((function(e){return[se(e),"a positive integer"]})),"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],Xe.prototype,"getItems",null),B([p.validateTypesAsync(p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],Xe.prototype,"setTtl",null),B([p.validateTypesAsync("string",p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[String,Number]),q("design:returntype",Promise)],Xe.prototype,"setItemTtl",null);var et=function(e){I.default(a,e);var t,n,r,i=Ze(a);function a(e,t,n){var r;return C.default(this,a),(r=i.call(this,e,n)).descriptor=t,r}return E.default(a,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"stream"}},{key:"lastEventId",get:function(){return null}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"publishMessage",value:(r=S.default(O.default.mark((function e(t){var n,r,i,a;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={data:t},e.next=3,this.services.network.post(this.links.messages,n);case 3:return r=e.sent,i=r.body,a=this._handleMessagePublished(i.sid,t,!1),e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setTtl",value:(n=S.default(O.default.mark((function e(t){var n,r;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return n.apply(this,arguments)})},{key:"removeStream",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_update",value:function(e){switch(e.type){case"stream_message_published":this._handleMessagePublished(e.message_sid,e.message_data,!0);break;case"stream_removed":this.onRemoved(!1)}}},{key:"_handleMessagePublished",value:function(e,t,n){var r={sid:e,data:t};return this.broadcastEventToListeners("messagePublished",{message:r,isLocal:!n}),r}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}}],[{key:"type",get:function(){return"stream"}}]),a}(Re);B([p.validateTypesAsync(p.pureObject),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],et.prototype,"publishMessage",null),B([p.validateTypesAsync(p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],et.prototype,"setTtl",null);var tt=function(e){I.default(a,e);var t,n,r,i=Ze(a);function a(e){var t;return C.default(this,a),(t=i.call(this)).syncStreamImpl=e,t.syncStreamImpl.attach(R.default(t)),t}return E.default(a,[{key:"uri",get:function(){return this.syncStreamImpl.uri}},{key:"links",get:function(){return this.syncStreamImpl.links}},{key:"dateExpires",get:function(){return this.syncStreamImpl.dateExpires}},{key:"type",get:function(){return et.type}},{key:"lastEventId",get:function(){return null}},{key:"sid",get:function(){return this.syncStreamImpl.sid}},{key:"uniqueName",get:function(){return this.syncStreamImpl.uniqueName}},{key:"publishMessage",value:(r=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.publishMessage(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setTtl",value:(n=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"removeStream",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.removeStream());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){D.default(P.default(a.prototype),"close",this).call(this),this.syncStreamImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return et.type}}]),a}(Ae);A.default(tt,"messagePublished","messagePublished"),A.default(tt,"removed","removed"),B([p.validateTypesAsync(p.pureObject),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],tt.prototype,"publishMessage",null),B([p.validateTypesAsync(p.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],tt.prototype,"setTtl",null);var nt=function e(t){C.default(this,e),this.sdk="js",this.sdkVer=t,this.os=F.os.family,this.osVer=F.os.version,this.pl=F.name,this.plVer=F.version},rt=function(){function e(){C.default(this,e),this.names=new Map,this.entities=new Map}return E.default(e,[{key:"store",value:function(e){var t=this.entities.get(e.sid);return t||(this.entities.set(e.sid,e),e.uniqueName&&this.names.set(e.type+"::"+e.uniqueName,e.sid),e)}},{key:"getResolved",value:function(e,t){var n=this.names.get(t+"::"+e);return n?this.entities.get(n):null}},{key:"get",value:function(e,t){return this.entities.get(e)||this.getResolved(e,t)||null}},{key:"remove",value:function(e){var t=this.entities.get(e);t&&(this.entities.delete(e),t.uniqueName&&this.names.delete(t.type+"::"+t.uniqueName))}}]),e}();function it(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}var at=function(e){I.default(n,e);var t=it(n);function n(e,r,i,a){var s;return C.default(this,n),(s=t.call(this,r,i)).descriptor=e,s.cache=new Ye,a&&a.forEach((function(e){s.cache.store(e.key,{key:e.key,value:e.data},e.revision)})),s}return E.default(n,[{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return null}},{key:"type",get:function(){return n.type}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"indexName",get:function(){return this.descriptor.indexName}},{key:"queryString",get:function(){return this.descriptor.queryExpression}},{key:"queryUri",get:function(){return this.descriptor.queryUri}},{key:"liveQueryDescriptor",get:function(){return this.descriptor}},{key:"onRemoved",value:function(){}},{key:"getItems",value:function(){var e={};return this.cache.forEach((function(t,n){e[t]=n.value})),e}},{key:"_update",value:function(e,t){switch(e.type){case"live_query_item_updated":this.handleItemMutated(e.item_key,e.item_data,e.item_revision);break;case"live_query_item_removed":this.handleItemRemoved(e.item_key,e.item_revision);break;case"live_query_updated":this.handleBatchUpdate(e.items)}t&&this._advanceLastEventId(e.last_event_id)}},{key:"handleItemMutated",value:function(e,t,n){if(this.shouldIgnoreEvent(e,n))le("Item ".concat(e," update skipped, revision: ").concat(n));else{var r={key:e,value:t};this.cache.store(e,r,n),this.broadcastEventToListeners("itemUpdated",r)}}},{key:"handleItemRemoved",value:function(e,t){var n=null===t;this.shouldIgnoreEvent(e,t)?le("Item ".concat(e," delete skipped, revision: ").concat(t)):(this.cache.delete(e,t,n),this.broadcastEventToListeners("itemRemoved",{key:e}))}},{key:"handleBatchUpdate",value:function(e){var t=this,n={};for(var r in null!=e&&e.forEach((function(e){n[e.key]={data:e.data,revision:e.revision}})),this.cache.forEach((function(e,r){var i=n[e];null!=i?t.handleItemMutated(e,i.data,i.revision):t.handleItemRemoved(e,null),delete n[e]})),n)this.handleItemMutated(r,n[r].data,n[r].revision)}},{key:"shouldIgnoreEvent",value:function(e,t){return null!=e&&null!=t&&this.cache.isKnown(e,t)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e)}}],[{key:"type",get:function(){return"live_query"}}]),n}(Re);function st(e){return ot.apply(this,arguments)}function ot(){return(ot=S.default(O.default.mark((function e(t){var n,r,i,a,s,o;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.network,r=t.queryString,i=t.uri,a=t.type,null!=r){e.next=3;break}throw new ne("Invalid query",400,54507);case 3:return s={query_string:r},a===ut.type&&(s.type=a),e.next=7,n.post(i,s,void 0,!0);case 7:return o=e.sent,e.abrupt("return",o.body);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ut=function(e){I.default(n,e);var t=it(n);function n(e){var r;return C.default(this,n),(r=t.call(this)).liveQueryImpl=e,r.liveQueryImpl.attach(R.default(r)),r}return E.default(n,[{key:"type",get:function(){return at.type}},{key:"lastEventId",get:function(){return this.liveQueryImpl.lastEventId}},{key:"sid",get:function(){return this.liveQueryImpl.sid}},{key:"close",value:function(){D.default(P.default(n.prototype),"close",this).call(this),this.liveQueryImpl.detach(this.listenerUuid)}},{key:"getItems",value:function(){return this.ensureNotClosed(),this.liveQueryImpl.getItems()}}],[{key:"type",get:function(){return at.type}}]),n}(Ae);A.default(ut,"itemUpdated","itemUpdated"),A.default(ut,"itemRemoved","itemRemoved");var ct=function(e){I.default(i,e);var t,n,r=it(i);function i(e){var t;return C.default(this,i),t=r.call(this),A.default(R.default(t),"queryExpression",null),A.default(R.default(t),"items",{}),Object.assign(R.default(t),e),t.updateIndexName(e.indexName),t}return E.default(i,[{key:"type",get:function(){return i.type}},{key:"search",value:(n=S.default(O.default.mark((function e(t){var n=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.items={},e.abrupt("return",st({network:this.network,uri:this.queryUri,queryString:t}).then((function(e){n.queryExpression=t,e.items&&e.items.forEach((function(e){n.items[e.key]=e.data})),n.emit("searchResult",n.getItems())})).catch((function(e){throw pe("Error '".concat(e.message,"' while executing query '").concat(t,"'")),n.queryExpression=null,e})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"subscribe",value:(t=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=this.queryExpression){e.next=2;break}return e.abrupt("return",Promise.reject(new ne("Invalid query",400,54507)));case 2:return e.abrupt("return",this.liveQueryCreator(this.indexName,this.queryExpression));case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getItems",value:function(){return this.items}},{key:"updateIndexName",value:function(e){this.indexName=e,this.queryUri=this.generateQueryUri(this.indexName)}},{key:"generateQueryUri",value:function(e){return new ee(this.insightsUri).pathSegment(e).pathSegment("Items").build()}}],[{key:"type",get:function(){return"instant_query"}}]),i}(J);A.default(ct,"searchResult","searchResult"),B([p.validateTypesAsync("string"),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],ct.prototype,"search",null),B([p.validateTypes(p.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",void 0)],ct.prototype,"updateIndexName",null);function lt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=P.default(e);if(t){var i=P.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return T.default(this,n)}}function dt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ft(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?dt(Object(n),!0).forEach((function(t){A.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):dt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function pt(e){if(e){if("string"==typeof e)return{id:e,mode:"open_or_create"};var t=e.mode||(e.id?"open_or_create":"create_new");return ft(ft({},e),{},{mode:t})}return{mode:"create_new"}}var ht=function(e){I.default(g,e);var t,n,r,i,a,s,o,u,c,l,d,f,p,v,y,m=lt(g);function g(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(C.default(this,g),t=m.call(this),!e)throw new Error("Sync library needs a valid Twilio token to be passed");n.hasOwnProperty("logLevel")?ce(n.logLevel):ce("silent");var r=n.productId=n.productId||"data_sync";n.clientMetadata=n.clientMetadata||{},n.clientMetadata.hasOwnProperty("type")||(n.clientMetadata.type="sync"),n.clientMetadata.hasOwnProperty("sdk")||(n.clientMetadata.sdk="JS",n.clientMetadata.sdkv="3.1.0");var i=!n.twilsockClient;if(!n.initRegistrations){var a=new h.InitRegistration(r);g.populateInitRegistrations(a),n.initRegistrations=[a]}var s=n.twilsockClient=n.twilsockClient||new h.Twilsock(e,r,n);s.on("tokenAboutToExpire",(function(e){return t.emit("tokenAboutToExpire",e)})),s.on("tokenExpired",(function(){return t.emit("tokenExpired")})),s.on("connectionError",(function(e){return t.emit("connectionError",e)})),s.on("stateChanged",(function(e){t.emit("connectionStateChanged",e),t.services.subscriptions.onConnectionStateChanged("connected"===e)})),s.on("message",(function(e,n){return t._routeMessage(e,n)}));var o=new ve(n),u=new xe(new nt("3.1.0"),o,s),c=new Se(o);return t.services={config:o,twilsock:s,network:u,storage:c,router:R.default(t),subscriptions:null},t.services.subscriptions=new be(t.services),t.entities=new rt,i&&s.connect(),t}return E.default(g,[{key:"_routeMessage",value:function(e,t){switch(le("Notification type:",e,"content:",t),e){case"com.twilio.rtd.cds.document":case"com.twilio.rtd.cds.list":case"com.twilio.rtd.cds.map":this.services.subscriptions.acceptMessage(t,!1);break;case"twilio.sync.event":this.services.subscriptions.acceptMessage(t,!0)}}},{key:"_subscribe",value:function(e,t){this.services.subscriptions.add(e,t)}},{key:"_unsubscribe",value:function(e){this.services.subscriptions.remove(e)}},{key:"connectionState",get:function(){return this.services.twilsock.state}},{key:"ensureReady",value:(y=S.default(O.default.mark((function e(){var t;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.services.config.sessionStorageEnabled){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.services.twilsock.storageId();case 5:t=e.sent,this.services.storage.updateStorageId(t.id),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),fe("Failed to initialize storage",e.t0);case 12:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(){return y.apply(this,arguments)})},{key:"storeRootInSessionCache",value:function(e,t,n){if(this.services.config.sessionStorageEnabled&&t){var r=ie(n);e!==Ve.type&&e!==Xe.type||(r.last_event_id=null,delete r.items),this.services.storage.store(e,t,r)}}},{key:"readRootFromSessionCache",value:function(e,t){return this.services.config.sessionStorageEnabled&&t?this.services.storage.read(e,t):null}},{key:"_get",value:(v=S.default(O.default.mark((function e(t,n){var r,i,a,s=arguments;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>2&&void 0!==s[2]&&s[2],n){e.next=3;break}throw new ne("Cannot get entity without id",404);case 3:return i=new ee(t).pathSegment(n).queryParam("Include",r?"items":void 0).build(),e.next=6,this.services.network.get(i);case 6:return a=e.sent,e.abrupt("return",a.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return v.apply(this,arguments)})},{key:"_createDocument",value:function(e,t,n){var r={unique_name:e,data:t||{}};return void 0!==n&&(r.ttl=n),this.services.network.post(this.services.config.documentsUri,r).then((function(e){return e.body.data=r.data,e.body}))}},{key:"_getDocument",value:(p=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(Ue.type,t)||this._get(this.services.config.documentsUri,t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"_createList",value:function(e,t,n,r){var i={unique_name:e,purpose:t,context:n};return void 0!==r&&(i.ttl=r),this.services.network.post(this.services.config.listsUri,i).then((function(e){return e.body}))}},{key:"_getList",value:(f=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(Ve.type,t)||this._get(this.services.config.listsUri,t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"_createMap",value:function(e,t){var n={unique_name:e};return void 0!==t&&(n.ttl=t),this.services.network.post(this.services.config.mapsUri,n).then((function(e){return e.body}))}},{key:"_getMap",value:(d=S.default(O.default.mark((function e(t){var n,r=arguments;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",this.readRootFromSessionCache(Xe.type,t)||this._get(this.services.config.mapsUri,t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"_getStream",value:(l=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(tt.type,t)||this._get(this.services.config.streamsUri,t,!1));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"_createStream",value:(c=S.default(O.default.mark((function e(t,n){var r,i;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={unique_name:t},void 0!==n&&(r.ttl=n),e.next=4,this.services.network.post(this.services.config.streamsUri,r);case 4:return i=e.sent,e.abrupt("return",i.body);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"_getLiveQuery",value:function(e){return this.readRootFromSessionCache(ut.type,e)}},{key:"getCached",value:function(e,t){return e&&this.entities.get(e,t)||null}},{key:"removeFromCacheAndSession",value:function(e,t,n){this.entities.remove(t),this.services.config.sessionStorageEnabled&&this.services.storage.remove(e,t,n)}},{key:"document",value:(u=S.default(O.default.mark((function e(t){var n,r,i,a,s=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=pt(t)).mode){e.next=9;break}return e.next=6,this._createDocument(n.id,n.data,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,Ue.type))){e.next=14;break}return e.abrupt("return",new Ue(i));case 14:return e.prev=14,e.next=17,this._getDocument(n.id);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createDocument(n.id,n.data,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.document(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(Ue.type,n.id,r),a=new Me(this.services,r,(function(e,t,n){return s.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new Ue(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return u.apply(this,arguments)})},{key:"map",value:(o=S.default(O.default.mark((function e(t){var n,r,i,a,s=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=pt(t)).mode){e.next=9;break}return e.next=6,this._createMap(n.id,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,Xe.type))){e.next=14;break}return e.abrupt("return",new Xe(i));case 14:return e.prev=14,e.next=17,this._getMap(n.id,n.includeItems);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createMap(n.id,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.map(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(Xe.type,n.id,r),a=new $e(this.services,r,(function(e,t,n){return s.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new Xe(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return o.apply(this,arguments)})},{key:"list",value:(s=S.default(O.default.mark((function e(t){var n,r,i,a,s=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=pt(t)).mode){e.next=9;break}return e.next=6,this._createList(n.id,n.purpose,n.context,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,Ve.type))){e.next=14;break}return e.abrupt("return",new Ve(i));case 14:return e.prev=14,e.next=17,this._getList(n.id);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createList(n.id,n.purpose,n.context,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.list(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(Ve.type,n.id,r),a=new Qe(this.services,r,(function(e,t,n){return s.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new Ve(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return s.apply(this,arguments)})},{key:"stream",value:(a=S.default(O.default.mark((function e(t){var n,r,i,a,s,o=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=pt(t)).mode){e.next=9;break}return e.next=6,this._createStream(n.id,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,tt.type))){e.next=14;break}return e.abrupt("return",new tt(i));case 14:return e.prev=14,e.next=17,this._getStream(n.id);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createStream(n.id,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.stream(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(tt.type,n.id,r),a=function(e,t,n){return o.removeFromCacheAndSession(e,t,n)},s=new et(this.services,r,a),s=this.entities.store(s),e.abrupt("return",new tt(s));case 44:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return a.apply(this,arguments)})},{key:"shutdown",value:(i=S.default(O.default.mark((function e(){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.subscriptions.shutdown();case 2:return e.next=4,this.services.twilsock.disconnect();case 4:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"updateToken",value:(r=S.default(O.default.mark((function e(t){return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.twilsock.updateToken(t).catch((function(e){var t,n=null==e||null===(t=e.reply)||void 0===t?void 0:t.status;if(401===(null==n?void 0:n.code)&&"UNAUTHORIZED"===(null==n?void 0:n.status))throw new ne("Updated token was rejected by server",400,51130);throw e})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"liveQuery",value:(n=S.default(O.default.mark((function e(t,n){var r,i,a,s,o,u=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return r=new ee(this.services.config.insightsUri).pathSegment(t).pathSegment("Items").build(),e.next=5,st({network:this.services.network,uri:r,queryString:n,type:ut.type});case 5:return i=e.sent,(a=this.getCached(i.query_id,ut.type))||((s=this._getLiveQuery(i.query_id))||(s={indexName:t,queryExpression:n,sid:i.query_id,queryUri:r,last_event_id:i.last_event_id}),o=function(e,t,n){return u.removeFromCacheAndSession(e,t,n)},a=new at(s,this.services,o,i.items)),this.storeRootInSessionCache(ut.type,i.query_id,a.liveQueryDescriptor),a=this.entities.store(a),e.abrupt("return",new ut(a));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"instantQuery",value:(t=S.default(O.default.mark((function e(t){var n,r=this;return O.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return n=function(e,t){return r.liveQuery(e,t)},e.abrupt("return",new ct({indexName:t,network:this.services.network,insightsUri:this.services.config.insightsUri,liveQueryCreator:n}));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"populateInitRegistrations",value:function(e){e.populateInitRegistrations(["twilio.sync.event","com.twilio.rtd.cds.document","com.twilio.rtd.cds.list","com.twilio.rtd.cds.map"])}},{key:"version",get:function(){return"3.1.0"}}]),g}(J);A.default(ht,"connectionStateChanged","connectionStateChanged"),A.default(ht,"connectionError","connectionError"),A.default(ht,"tokenAboutToExpire","tokenAboutToExpire"),A.default(ht,"tokenExpired","tokenExpired"),B([p.validateTypesAsync(["undefined","string",p.objectSchema("open document options",{id:["string","undefined"],mode:[p.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[p.nonNegativeInteger,"undefined"],data:[p.pureObject,"undefined",p.literal(null)]})]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],ht.prototype,"document",null),B([p.validateTypesAsync(["undefined","string",p.objectSchema("open map options",{id:["string","undefined"],mode:[p.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[p.nonNegativeInteger,"undefined"],data:[p.pureObject,"undefined",p.literal(null)],includeItems:["boolean","undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],ht.prototype,"map",null),B([p.validateTypesAsync(["undefined","string",p.objectSchema("open list options",{id:["string","undefined"],mode:[p.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[p.nonNegativeInteger,"undefined"],data:[p.pureObject,"undefined",p.literal(null)],purpose:["string","undefined"],context:[p.pureObject,"undefined"],includeItems:["boolean","undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],ht.prototype,"list",null),B([p.validateTypesAsync(["undefined","string",p.objectSchema("open stream options",{id:["string","undefined"],mode:[p.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[p.nonNegativeInteger,"undefined"],data:[p.pureObject,"undefined",p.literal(null)]})]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],ht.prototype,"stream",null),B([p.validateTypesAsync(p.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],ht.prototype,"updateToken",null),B([p.validateTypesAsync(p.nonEmptyString,"string"),q("design:type",Function),q("design:paramtypes",[String,String]),q("design:returntype",Promise)],ht.prototype,"liveQuery",null),B([p.validateTypesAsync(p.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],ht.prototype,"instantQuery",null),t.Client=ht,t.InsightsItem=function e(){C.default(this,e)},t.InstantQuery=ct,t.LiveQuery=ut,t.Paginator=Ne,t.SyncClient=ht,t.SyncDocument=Ue,t.SyncList=Ve,t.SyncListItem=je,t.SyncMap=Xe,t.SyncMapItem=Ge,t.SyncStream=tt},990:function(e,t,n){"use strict";
/*
@license
Copyright (c) 2018, Twilio, Inc.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

*/var r=void 0!==r?r:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};Object.defineProperty(t,"__esModule",{value:!0}),n(355),n(157);var i=n(13),a=n(14),s=n(36),o=n(38),u=n(22),c=n(63),l=n(3);n(156),n(142),n(133),n(244),n(166),n(167);var d=n(2),f=n(1);n(168),n(300),n(245);var p=n(4);n(165);var h=n(188);n(523),n(247),n(189),n(411),n(302),n(221),n(264),n(486),n(303),n(652),n(991);var v=n(222),y=n(524);function m(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function g(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var b=m(i),k=m(a),w=m(s),_=m(o),x=m(u),S=m(c),C=m(l),E=m(d),R=m(f),I=m(p),T=g(h),P={exports:{}},A="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(A){var O=new Uint8Array(16);P.exports=function(){return A(O),O}}else{var M=new Array(16);P.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),M[t]=e>>>((3&t)<<3)&255;return M}}for(var U=[],j=0;j<256;++j)U[j]=(j+256).toString(16).substr(1);var N,L,D=function(e,t){var n=t||0,r=U;return[r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]]].join("")},F=P.exports,B=D,q=0,z=0;var J=function(e,t,n){var r=t&&n||0,i=t||[],a=(e=e||{}).node||N,s=void 0!==e.clockseq?e.clockseq:L;if(null==a||null==s){var o=F();null==a&&(a=N=[1|o[0],o[1],o[2],o[3],o[4],o[5]]),null==s&&(s=L=16383&(o[6]<<8|o[7]))}var u=void 0!==e.msecs?e.msecs:(new Date).getTime(),c=void 0!==e.nsecs?e.nsecs:z+1,l=u-q+(c-z)/1e4;if(l<0&&void 0===e.clockseq&&(s=s+1&16383),(l<0||u>q)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");q=u,z=c,L=s;var d=(1e4*(268435455&(u+=122192928e5))+c)%4294967296;i[r++]=d>>>24&255,i[r++]=d>>>16&255,i[r++]=d>>>8&255,i[r++]=255&d;var f=u/4294967296*1e4&268435455;i[r++]=f>>>8&255,i[r++]=255&f,i[r++]=f>>>24&15|16,i[r++]=f>>>16&255,i[r++]=s>>>8|128,i[r++]=255&s;for(var p=0;p<6;++p)i[r+p]=a[p];return t||B(i)},W=P.exports,Y=D;var H=J,Q=function(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var i=(e=e||{}).random||(e.rng||W)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var a=0;a<16;++a)t[r+a]=i[a];return t||Y(i)},V=Q;V.v1=H,V.v4=Q;var G=V;function K(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=x.default(e);if(t){var i=x.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _.default(this,n)}}var $=function(e){w.default(n,e);var t=K(n);function n(e){var r;b.default(this,n);var i,a=G.v4();return(r=t.call(this,(function(t,r){return i=r,e((function(e){n.cancellationMap.delete(a),t(e)}),(function(e){n.cancellationMap.delete(a),r(e)}),(function(e){n.cancellationMap.set(a,e)}))}))).id=a,r.rejectPromise=i,r}return k.default(n,[{key:"cancel",value:function(){var e=n.cancellationMap.get(this.id);return null==e||e(),this.rejectPromise&&(this.catch((function(){})),this.rejectPromise(new Error("Promise was cancelled"))),this}}]),n}(S.default(Promise));function X(e,t,n,r){var i,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":I.default(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(a<3?i(s):a>3?i(t,n,s):i(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s}function Z(e,t){if("object"===("undefined"==typeof Reflect?"undefined":I.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function ee(e,t){return["".concat((new Date).toISOString()," MCS Client ").concat(e,":")].concat(Array.from(t))}C.default($,"cancellationMap",new Map);var te=function(){function e(t){b.default(this,e),C.default(this,"prefix",""),this.prefix=null!=t&&t.length>0?t+" ":""}return k.default(e,[{key:"setLevel",value:function(e){T.setLevel(e)}},{key:"trace",value:function(){if(T.getLevel()==T.levels.TRACE){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.debug.apply(null,ee(this.prefix+"T",t))}}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.debug.apply(null,ee(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.info.apply(null,ee(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.warn.apply(null,ee(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.error.apply(null,ee(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){T.setLevel(e)}},{key:"trace",value:function(){if(T.getLevel()==T.levels.TRACE){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.debug.apply(null,ee("T",t))}}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.debug.apply(null,ee("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.info.apply(null,ee("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.warn.apply(null,ee("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.error.apply(null,ee("E",t))}}]),e}(),ne=function(e,t){return"".concat((n=e,n.startsWith("http")?"":function(e){return"https://mcs.".concat(null!=e?e:"us1",".twilio.com")}(t))).concat(e);var n},re=function(){function e(t,n,r,i){var a,s,o,u,c,l;b.default(this,e);var d=null!==(a=null!==(s=i.MCS)&&void 0!==s?s:i)&&void 0!==a?a:{};this.region=null!==(o=null!==(u=d.region)&&void 0!==u?u:i.region)&&void 0!==o?o:"us1",this.mediaUrl=ne(n,this.region),this.mediaSetUrl=r?ne(r):"".concat(this.mediaUrl,"Set"),this.token=t,this.retryWhenThrottledOverride=null===(c=d.retryWhenThrottledOverride)||void 0===c||c,this.backoffConfigOverride=null!==(l=d.backoffConfigOverride)&&void 0!==l?l:e.backoffConfigDefault}return k.default(e,[{key:"updateToken",value:function(e){this.token=e}}],[{key:"backoffConfigDefault",get:function(){return{min:1e3,max:4e3,maxAttemptsCount:3}}},{key:"retryWhenThrottledDefault",get:function(){return!0}}]),e}(),ie=function(){function e(t,n,r){b.default(this,e),this.config=t,this.network=n,this._update(r)}return k.default(e,[{key:"sid",get:function(){return this.state.sid}},{key:"serviceSid",get:function(){return this.state.serviceSid}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"fileName",get:function(){return this.state.filename}},{key:"filename",get:function(){return this.state.filename}},{key:"category",get:function(){return this.state.category}},{key:"getContentUrl",value:function(){var e=this;return new $(function(){var t=E.default(R.default.mark((function t(n,r,i){var a,s;return R.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=e.network.get("".concat(e.config.mediaUrl,"/").concat(e.sid)),i((function(){return a.cancel()})),t.prev=2,t.next=5,a;case 5:s=t.sent,e._update(s.body),n(e.state.contentDirectUrl),t.next=13;break;case 10:t.prev=10,t.t0=t.catch(2),r(t.t0);case 13:case"end":return t.stop()}}),t,null,[[2,10]])})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"_update",value:function(e){var t,n,r,i;this.state={sid:e.sid,serviceSid:e.service_sid,channelSid:e.channel_sid,messageSid:e.message_sid,dateCreated:e.date_created?new Date(e.date_created):null,dateUploadUpdated:e.date_upload_updated?new Date(e.date_upload_updated):null,dateUpdated:e.date_updated?new Date(e.date_updated):null,size:e.size,contentType:e.content_type,author:e.author,url:e.url,contentUrl:e.links.content,contentDirectUrl:null!==(t=e.links.content_direct_temporary)&&void 0!==t?t:null,filename:null!==(n=e.filename)&&void 0!==n?n:null,category:null!==(r=e.category)&&void 0!==r?r:"media",isMultipartUpstream:null!==(i=e.is_multipart_upstream)&&void 0!==i&&i}}},{key:"_state",value:function(){var e;return{sid:this.state.sid,category:this.state.category,filename:null!==(e=this.state.filename)&&void 0!==e?e:null,contentType:this.state.contentType,size:this.state.size}}}]),e}();function ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=x.default(e);if(t){var i=x.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _.default(this,n)}}var se=function(e){w.default(n,e);var t=ae(n);function n(e,r,i,a,s){var o;return b.default(this,n),(o=t.call(this,e)).code=r,o.body=i,o.status=a,o.headers=s,o}return k.default(n)}(S.default(Error)),oe=r.XMLHttpRequest||{};var ue,ce=function(){function e(){b.default(this,e)}return k.default(e,[{key:"get",value:function(t,n){return e.request("GET",t,n)}},{key:"post",value:function(t,n,r){return e.request("POST",t,n,r)}}],[{key:"request",value:function(e,t,n,r){return new $((function(i,a,s){var o=new oe,u=!1;for(var c in s((function(){o.abort(),u=!0})),o.open(e,t,!0),o.onreadystatechange=function(){if(4===o.readyState&&!u){var e,t=(e=o.getAllResponseHeaders())?e.split("\r\n").map((function(e){return e.split(": ")})).filter((function(e){return 2===e.length&&e[1].length>0})).reduce((function(e,t){return e[t[0]]=t[1],e}),{}):{},n=function(e){var t=e.getResponseHeader("Content-Type");if(!t||0!==t.indexOf("application/json")||0===e.responseText.length)return e.responseText;try{return JSON.parse(e.responseText)}catch(t){return e.responseText}}(o);if(200<=o.status&&o.status<300)i({status:o.status,headers:t,body:n});else{var r,s,c=null!==(r=o.statusText)&&void 0!==r?r:"NONE";if("string"==typeof n)if(n&&1===n.split("\n",2).length)s=n;else{var l,d=null===(l=n.replace(/<.*?>/g,"").split(/\r\n/g).filter((function(e){return e.length}))[0])||void 0===l?void 0:l.split(" ");s=(null==d?void 0:d.length)>2?null==d?void 0:d.slice(1).join(" "):""}else s=JSON.stringify(n);var f="".concat(o.status,": [").concat(c,"] ").concat(s);a(new se(f,o.status,n,c,t))}}},n)o.setRequestHeader(c,n[c]),"Content-Type"===c&&"application/json"===n[c]&&(r=JSON.stringify(r));o.send(r)}))}}]),e}(),le=te.scope("Network"),de=function(){function e(t,n){b.default(this,e),this.config=t,this.transport=n}return k.default(e,[{key:"backoffConfig",value:function(){return Object.assign(re.backoffConfigDefault,this.config.backoffConfigOverride)}},{key:"retryWhenThrottled",value:function(){var e,t;return null!==(e=null!==(t=this.config.retryWhenThrottledOverride)&&void 0!==t?t:re.retryWhenThrottledDefault)&&void 0!==e&&e}},{key:"executeWithRetry",value:function(e,t){var n=this;return new $(function(){var r=E.default(R.default.mark((function r(i,a,s){var o,u;return R.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:o=new v.Retrier(n.backoffConfig()),u=[502,503,504],t&&u.push(429),s((function(){o.cancel(),o.removeAllListeners()})),o.on("attempt",E.default(R.default.mark((function t(){var n,r;return R.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,n=e(),s((function(){n.cancel(),o.cancel(),o.removeAllListeners()})),t.next=5,n;case 5:r=t.sent,o.succeeded(r),t.next=12;break;case 9:t.prev=9,t.t0=t.catch(0),u.indexOf(t.t0.status)>-1||"Twilsock disconnected"===t.t0.message?o.failed(t.t0):(o.removeAllListeners(),o.cancel(),a(t.t0));case 12:case"end":return t.stop()}}),t,null,[[0,9]])})))),o.on("succeeded",(function(e){i(e)})),o.on("cancelled",(function(e){return a(e)})),o.on("failed",(function(e){return a(e)})),o.start();case 9:case"end":return r.stop()}}),r)})));return function(e,t,n){return r.apply(this,arguments)}}())}},{key:"get",value:function(e){var t=this;return new $(function(){var n=E.default(R.default.mark((function n(r,i,a){var s,o,u;return R.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s={"X-Twilio-Token":t.config.token},o=t.executeWithRetry((function(){return t.transport.get(e,s)}),t.retryWhenThrottled()),le.trace("sending GET request to ",e," headers ",s),a((function(){return o.cancel()})),n.prev=4,n.next=7,o;case 7:u=n.sent,le.trace("response",u),r(u),n.next=16;break;case 12:n.prev=12,n.t0=n.catch(4),le.debug("get() error ".concat(n.t0)),i(n.t0);case 16:case"end":return n.stop()}}),n,null,[[4,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"post",value:function(e,t,n,i,a){var s=this,o={"X-Twilio-Token":this.config.token};"undefined"!=typeof FormData&&n instanceof FormData||!i||Object.assign(o,{"Content-Type":i});var u=new URL(e);return t&&u.searchParams.append("Category",t),a&&u.searchParams.append("Filename",a),new $(function(){var t=E.default(R.default.mark((function t(i,a,c){var l,d;return R.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return l=s.transport.post(u.href,o,n),c((function(){return l.cancel()})),le.trace("sending POST request to ".concat(e," with headers ").concat(o)),t.prev=3,t.next=6,l;case 6:d=t.sent,t.next=17;break;case 9:if(t.prev=9,t.t0=t.catch(3),!(void 0===r.XMLHttpRequest&&n instanceof FormData)){t.next=14;break}return a(new TypeError("Posting FormData supported only with browser engine's FormData")),t.abrupt("return");case 14:return le.debug("post() error ".concat(t.t0)),a(t.t0),t.abrupt("return");case 17:le.trace("response",d),i(d);case 19:case"end":return t.stop()}}),t,null,[[3,9]])})));return function(e,n,r){return t.apply(this,arguments)}}())}}]),e}(),fe=te.scope("");t.default=(ue=function(){function e(t,n,r){var i,a,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};b.default(this,e),this.options=s,this.options.logLevel=null!==(i=this.options.logLevel)&&void 0!==i?i:"silent",this.config=new re(t,n,r,this.options),fe.setLevel(this.options.logLevel),this.options.transport=null!==(a=this.options.transport)&&void 0!==a?a:new ce,this.transport=this.options.transport,this.network=new de(this.config,this.transport)}return k.default(e,[{key:"updateToken",value:function(e){fe.info("updateToken"),this.config.updateToken(e)}},{key:"get",value:function(e){var t=this;return new $(function(){var n=E.default(R.default.mark((function n(r,i,a){var s,o;return R.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=t.network.get("".concat(t.config.mediaUrl,"/").concat(e)),a((function(){return s.cancel()})),n.prev=2,n.next=5,s;case 5:o=n.sent,r(new ie(t.config,t.network,o.body)),n.next=12;break;case 9:n.prev=9,n.t0=n.catch(2),i(n.t0);case 12:case"end":return n.stop()}}),n,null,[[2,9]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"post",value:function(e,t,n,r){var i=this;return new $(function(){var a=E.default(R.default.mark((function a(s,o,u){var c,l;return R.default.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return c=i.network.post(i.config.mediaUrl,null!=n?n:"media",t,e,r),u((function(){return c.cancel()})),a.prev=2,a.next=5,c;case 5:l=a.sent,s(new ie(i.config,i.network,l.body)),a.next=12;break;case 9:a.prev=9,a.t0=a.catch(2),o(a.t0);case 12:case"end":return a.stop()}}),a,null,[[2,9]])})));return function(e,t,n){return a.apply(this,arguments)}}())}},{key:"postFormData",value:function(e,t){var n=this;return new $(function(){var r=E.default(R.default.mark((function r(i,a,s){var o,u;return R.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=n.network.post(n.config.mediaUrl,null!=t?t:"media",e),s((function(){return o.cancel()})),r.prev=2,r.next=5,o;case 5:u=r.sent,i(new ie(n.config,n.network,u.body)),r.next=12;break;case 9:r.prev=9,r.t0=r.catch(2),a(r.t0);case 12:case"end":return r.stop()}}),r,null,[[2,9]])})));return function(e,t,n){return r.apply(this,arguments)}}())}},{key:"mediaSetGet",value:function(e){var t=this;return new $(function(){var n=E.default(R.default.mark((function n(r,i,a){var s,o,u,c;return R.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s={command:"get",list:e.map((function(e){return{media_sid:e}}))},o=t.network.post("".concat(t.config.mediaSetUrl),null,s,"application/json"),a((function(){return o.cancel()})),n.prev=3,n.next=6,o;case 6:u=n.sent,c=u.body.map((function(e){if(200===e.code)return new ie(t.config,t.network,e.media_record);i("Failed to obtain detailed information about Media items (failed SID ".concat(e.media_record.sid,")"))})),r(c),n.next=14;break;case 11:n.prev=11,n.t0=n.catch(3),i(n.t0);case 14:case"end":return n.stop()}}),n,null,[[3,11]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"mediaSetGetContentUrls",value:function(e){var t=this;return new $(function(){var n=E.default(R.default.mark((function n(r,i,a){var s,o,u,c;return R.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s={command:"get",list:e.map((function(e){return{media_sid:e}}))},o=t.network.post("".concat(t.config.mediaSetUrl),null,s,"application/json"),a((function(){return o.cancel()})),n.prev=3,n.next=6,o;case 6:u=n.sent,c=new Map,u.body.forEach((function(e){200===e.code?c.set(e.media_record.sid,e.media_record.links.content_direct_temporary):i("Failed to obtain detailed information about Media items (failed SID ".concat(e.media_record.sid,")"))})),r(c),n.next=15;break;case 12:n.prev=12,n.t0=n.catch(3),i(n.t0);case 15:case"end":return n.stop()}}),n,null,[[3,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}}]),e}(),C.default(ue,"version","0.6.8"),ue),X([y.validateTypes(y.nonEmptyString),Z("design:type",Function),Z("design:paramtypes",[String]),Z("design:returntype",void 0)],t.default.prototype,"updateToken",null),X([y.validateTypesAsync(y.nonEmptyString),Z("design:type",Function),Z("design:paramtypes",[String]),Z("design:returntype",$)],t.default.prototype,"get",null),t.default=X([y.validateConstructorTypes(y.nonEmptyString,y.nonEmptyString,[y.nonEmptyString,y.literal(null)],[y.pureObject,"undefined"]),Z("design:paramtypes",[String,String,Object,Object])],t.default),t.CancellablePromise=$,t.Client=t.default,t.McsClient=t.default,t.McsMedia=ie,t.Media=ie},991:function(e,t,n){"use strict";n(654)},992:function(e,t,n){"use strict";var r=n(74),i=n(115),a=n(186),s=r.aTypedArray;(0,r.exportTypedArrayMethod)("at",(function(e){var t=s(this),n=i(t),r=a(e),o=r>=0?r:n+r;return o<0||o>=n?void 0:t[o]}))},993:function(e,t,n){"use strict";var r=n(48),i=n(59),a=n(639),s=n(402),o=a.ArrayBuffer;r({global:!0,constructor:!0,forced:i.ArrayBuffer!==o},{ArrayBuffer:o}),s("ArrayBuffer")},994:function(e,t){e.exports=window.FormData},995:function(e,t,n){"use strict";var r=n(48),i=n(47),a=n(163),s=n(125),o=n(115),u=n(497),c=n(105),l=n(41),d=n(518),f=n(348),p=n(644),h=n(645),v=n(266),y=n(646),m=[],g=i(m.sort),b=i(m.push),k=l((function(){m.sort(void 0)})),w=l((function(){m.sort(null)})),_=f("sort"),x=!l((function(){if(v)return v<70;if(!(p&&p>3)){if(h)return!0;if(y)return y<603;var e,t,n,r,i="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(r=0;r<47;r++)m.push({k:t+r,v:n})}for(m.sort((function(e,t){return t.v-e.v})),r=0;r<m.length;r++)t=m[r].k.charAt(0),i.charAt(i.length-1)!==t&&(i+=t);return"DGBEFHACIJK"!==i}}));r({target:"Array",proto:!0,forced:k||!w||!_||!x},{sort:function(e){void 0!==e&&a(e);var t=s(this);if(x)return void 0===e?g(t):g(t,e);var n,r,i=[],l=o(t);for(r=0;r<l;r++)r in t&&b(i,t[r]);for(d(i,function(e){return function(t,n){return void 0===n?-1:void 0===t?1:void 0!==e?+e(t,n)||0:c(t)>c(n)?1:-1}}(e)),n=o(i),r=0;r<n;)t[r]=i[r++];for(;r<l;)u(t,r++);return t}})},996:function(e,t,n){"use strict";var r=n(48),i=n(47),a=n(650),s=n(185),o=n(105),u=n(651),c=i("".indexOf);r({target:"String",proto:!0,forced:!u("includes")},{includes:function(e){return!!~c(o(s(this)),o(a(e)),arguments.length>1?arguments[1]:void 0)}})},997:function(e,t,n){"use strict";n(998)},998:function(e,t,n){"use strict";n(493)("WeakSet",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),n(999))},999:function(e,t,n){"use strict";var r=n(47),i=n(405),a=n(404).getWeakData,s=n(243),o=n(94),u=n(175),c=n(90),l=n(347),d=n(141),f=n(91),p=n(155),h=p.set,v=p.getterFor,y=d.find,m=d.findIndex,g=r([].splice),b=0,k=function(e){return e.frozen||(e.frozen=new w)},w=function(){this.entries=[]},_=function(e,t){return y(e.entries,(function(e){return e[0]===t}))};w.prototype={get:function(e){var t=_(this,e);if(t)return t[1]},has:function(e){return!!_(this,e)},set:function(e,t){var n=_(this,e);n?n[1]=t:this.entries.push([e,t])},delete:function(e){var t=m(this.entries,(function(t){return t[0]===e}));return~t&&g(this.entries,t,1),!!~t}},e.exports={getConstructor:function(e,t,n,r){var d=e((function(e,i){s(e,p),h(e,{type:t,id:b++,frozen:void 0}),u(i)||l(i,e[r],{that:e,AS_ENTRIES:n})})),p=d.prototype,y=v(t),m=function(e,t,n){var r=y(e),i=a(o(t),!0);return!0===i?k(r).set(t,n):i[r.id]=n,e};return i(p,{delete:function(e){var t=y(this);if(!c(e))return!1;var n=a(e);return!0===n?k(t).delete(e):n&&f(n,t.id)&&delete n[t.id]},has:function(e){var t=y(this);if(!c(e))return!1;var n=a(e);return!0===n?k(t).has(e):n&&f(n,t.id)}}),i(p,n?{get:function(e){var t=y(this);if(c(e)){var n=a(e);return!0===n?k(t).get(e):n?n[t.id]:void 0}},set:function(e,t){return m(this,e,t)}}:{add:function(e){return m(this,e,!0)}}),d}}}});
//# sourceMappingURL=TwilioConversations.e2a4505a26ec66e65b8e.bundle.js.map